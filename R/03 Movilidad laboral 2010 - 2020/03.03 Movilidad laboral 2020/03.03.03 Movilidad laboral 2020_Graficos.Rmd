---
title: "Movilidad Laboral 2020"
author: "Indicadores sociodemogr谩ficos"
output:
   html_document:
      highlight: tango
      theme: flatly
      toc: yes
      toc_depth: 2
      toc_float:
        collapsed: yes
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE, cache.lazy = FALSE, 
                         eval = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(digits = 2, encoding = "UTF8")
```   
 

```{r, echo=FALSE}
rm(list = ls())
```

```{r, echo=FALSE}
setwd(here::here())
```


```{r, echo=FALSE}
#Font Stlye
require(showtext)
library(extrafont)
# activar showtext
# SE cargan las funtes del sitema Windows (Pero tarda en correr)
#ttf_import('C:/Users/dvill/AppData/Local/Microsoft/Windows/Fonts/')
#fonts()
#extrafont::loadfonts(device = "win")
#font_import()
windowsFonts()
```

```{r, echo = FALSE}
# Librer铆as que se usaron en el documCVE_ENTo
require(chorddiag)
require(circlize)
require(Cairo)
require(haven)
require(Hmisc) # %nin%
require(dplyr)
require(survey)
require(srvyr)
require(stringr)
require(sna)
require(expss)
require(knitr)
require(kableExtra)
require(sjlabelled)
require(gt)
require(ggplot2)
require(ggpubr)
require(ggalluvial)
require(ggsankey)
require(ggrepel)
require(janitor)
require(tibble)
require(tidyr)
require(reshape2)
require(openxlsx)
require(rlang)
require(doMC)
registerDoMC(cores = 18)
```


**Cuestionario Ampliado del Censo de Poblaci贸n y Vivienda 2020**

El cuestionario ampliado se guarda en un un archivo `.RData`. 

```{r, eval = FALSE}
data <- read_sav("~/Personas_Censo 2020.SAV")
save(data, 
      file = paste0(here::here(), "/Bases/Censo_Personas_2020.RData"))
```


Se seleccionan las variables que se desean conservar para la realizaci贸n de este documento y se guarda en un archivo `.RData` para practicidad del manejo de datos. 

La variable `mydata` contiene **15 015 683 observaciones** y **33 variables**.      

**Posibles variables que se pueden contemplar en la migraci贸n laboral** 

- `NIVACAD` 驴Cu谩l fue el 煤ltimo a帽o o grado aprobado por (NOMBRE) en la escuela?  
- `CONACT` Situaci贸n laboral    
- `OCUPACION_C` Cu谩l fue la ocupaci贸n de (NOMBRE) la semana pasada? Por ejemplo: t茅cnico electricista, maestra de primaria, vendedora de frutas, alba帽il, mec谩nico de autos    
- `SITTRA`  Situaci贸n de trabajo    
- `VACACIONES`   
- `SERVICIO_MEDICO`   
- `INCAP_SUELDO` 
- `INGTRMEN`   
- `ACTIVIDADES_C` 驴A qu茅 se dedica el negocio, empresa o lugar donde trabaj贸 (NOMBRE)? Por ejemplo: hacer muebles de madera, hacer escobas, reparar autos, vender ropa usada, armar televisores..    
- `TIE_TRASLADO_TRAB`   
- `MED_TRASLADO_TRAB1`  
- `MED_TRASLADO_TRAB2`   
- `MED_TRASLADO_TRAB3`    
  
锔A partir de aqu铆 se pueden correr los c贸didos .
Se carga el archivo `Migracion laboral_2020.RData`.   

```{r}
load(file = paste0(here::here(), "/Bases/03_Movilidad laboral_2020.RData"))

# Para fines pr谩cticos se genera un ponderador de uno 
mydata <- mydata %>% 
           mutate(M = 1)  %>%
            mutate(NOM_ENT = as.factor(.$CVE_ENT)) %>%
             ungroup()
```



**Entidades y Municipios**

Se genera un vector con el nombre de las entidades llamado `estados` para facilitar los filtros en el documento.     
Se genera un vector con las abreviaturas de las entidades llamado `ent` para fines pr谩cticos.     
Se genera un vector con las claves de los municipios, pero es importante hacer notar que tres municipios no entraron el muestreo del Cuestionario Ampliado.   

```{r}
# Claves de los municipios
estados <- sjlabelled::get_labels(mydata$CVE_ENT)
nom_estados <- c( "Aguascalientes", "Baja California" ,"Baja California Sur", "Campeche", "Coahuila de Zaragoza", "Colima", 
                  "Chiapas", "Chihuahua", "Ciudad de M茅xico", "Durango", "Guanajuato", "Guerrero", "Hidalgo", "Jalisco",        
                  "M茅xico", "Michoac谩n de Ocampo", "Morelos", "Nayarit", "Nuevo Le贸n", "Oaxaca", "Puebla", "Quer茅taro", 
                  "Quintana Roo", "San Luis Potos铆", "Sinaloa", "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala", 
                  "Veracruz de Ignacio de la Llave", "Yucat谩n", "Zacatecas")
est <- c("AGS", "BC", "BCS", "CAMP", "COAH", "COL", "CHIS", "CHIH", "CDMX", "DGO", "GTO", "GRO", "HGO",
         "JAL", "MEX", "MICH", "MOR", "NAY", "NL", "OAX", "PUE", "QRO", "QROO", "SLP","SIN","SON", "TAB", 
         "TAMS", "TLX", "VER", "YUC", "ZAC")

# Claves de los estados
ENT <- readRDS(file = paste0(here::here(), "/Bases/estados.RDS"))

# Claves de los municipios
MUN <- readRDS(paste0(here::here(), "/Bases/municipios_2020.RDS"))
nom_municipios <- sjlabelled::get_labels(MUN$NOM_MUN) %>% as.factor()
municipios <- sjlabelled::get_labels(MUN$CVE_MUN) %>% as.factor()
#saveRDS(MUN, file = paste0(here::here(), "/Bases/municipios_2020.RDS"))
```


**Se reclasifican algunas variables**

```{r}
data <- mydata %>%
         mutate(PE = case_when(.$CONACT %in% c("10", "13", "14", "15", "16", "17", "18", "19", "20") & (.$EDAD >= 12 & .$EDAD <= 130) ~ 1,
                               .$CONACT %in% c("30", "40", "50", "60", "70", "80") & (.$EDAD >= 12 & .$EDAD <= 130) ~ 2,
                               .$CONACT %in% c("99") & (.$EDAD >= 12 & .$EDAD <= 130) ~ 99)) %>%
         mutate(PE = labelled(x = .$PE, 
                                  labels = c(`Poblaci贸n economicamente activa` = 1,
                                             `Poblaci贸n no economicamente activa` = 2,
                                             `No especificado` = 99))) %>%
         mutate(ESCOACUM = stringr::str_pad(.$ESCOACUM, width = 2, side = c("left"), pad = "0")) %>%
         mutate(G_ESCOACUM = case_when(.$ESCOACUM %in% c("00", "01", "02", "03", "04") ~ 1,
                                       .$ESCOACUM %in% c("05", "06", "07", "08") ~ 2,
                                       .$ESCOACUM %in% c("09", "10", "11") ~ 3,
                                       .$ESCOACUM %in% c("12", "13","14","15","16", "17", "18","19", "20", "21", "22", "23", "24") ~ 4)) %>%
         mutate(G_ESCOACUM = labelled(x = .$G_ESCOACUM,
                                     labels = c(`0 a 4` = 1,
                                                `5 a 8` = 2,
                                                `9 a 11` = 3,
                                                `12 y m谩s` = 4))) %>%
         mutate(ESCOACUM = as.double(.$ESCOACUM)) %>%
         mutate(ESCOACUM = labelled(x = .$ESCOACUM,
                                     labels = c(`00` = 0, 
                                                `01` = 1,
                                                `02` = 2,
                                                `03` = 3,
                                                `04` = 4,
                                                `05` = 5,
                                                `06` = 6,
                                                `07` = 7,
                                                `08` = 8,
                                                `09` = 9,
                                                `10` = 10,
                                                `11` = 11,
                                                `12` = 12,
                                                `13` = 13,
                                                `14` = 14,
                                                `15` = 15,
                                                `16` = 16,
                                                `17` = 17,
                                                `18` = 18,
                                                `19` = 19,
                                                `20` = 20,
                                                `21` = 21,
                                                `22` = 22,
                                                `23` = 23,
                                                `24` = 24,
                                                `99` = 99))) %>%
         mutate(GEDAD = case_when(.$EDAD >= 5 & .$EDAD <= 14 ~ 1,
                                  .$EDAD >= 15 & .$EDAD <= 29 ~ 2,
                                  .$EDAD >= 30 & .$EDAD <= 59 ~ 3,
                                  .$EDAD >= 60 & .$EDAD <= 130 ~ 4)) %>%
          mutate(GEDAD = labelled(x = .$GEDAD, 
                                  labels = c(`5 a 14 a帽os` = 1,
                                             `15 a 29 a帽os` = 2,
                                             `30 a 59 a帽os` = 3, 
                                             `60 a帽os y m谩s` = 4)))
```

# Nivel estatal {.tabset .tabset-pills}   
 
## Indicadores sociodemogr谩ficos {.tabset .tabset-pills}   

### Valores absolutos   

```{r}
#Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"
names(data)
Indicadores <- function(Variable){
                # Municipios
                ## municipios <- MUN %>% pull(CVE_MUN)
                
                # Estados 
                estados <- ENT %>% pull(CVE_ENT)

                # Variable que se dese analizar
                X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                      unlist()
                # Etiquetas para las columnnas
                etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                              unlist()

                # Poblaci贸n total
                Pob.Total <- data %>%
                              as.data.frame() %>%
                               filter(CVE_ENT %in% estados) %>%
                                group_by(CVE_ENT) %>%
                                 summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                  ungroup() %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
                #Poblaci贸n desagregada
                 # Filtro de la poblaci贸n desagregada
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]   
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_ENT %in% estados) %>%
                                       filter(ENT_PAIS_TRAB %in% estados) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ENT) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ENT", paste0("Pob_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Pob.Objetivo <- left_join(ENT %>% select(CVE_ENT), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                 adorn_totals(c("row"), 
                                              fill = "-", 
                                              na.rm = TRUE)
                # Poblaci贸n residente 
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]     
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_ENT == ENT_PAIS_TRAB) %>%
                                       filter(ENT_PAIS_TRAB %in% estados) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ENT) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ENT", paste0("Residentes_", etiquetas[x])))
                  }, simplify = FALSE
                )

                Residentes <- left_join(ENT %>% select(CVE_ENT), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                               adorn_totals(c("row"), 
                                            fill = "-", 
                                            na.rm = TRUE) 
                
                # Poblaci贸n Inmigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_ENT != ENT_PAIS_TRAB) %>%
                                       filter(ENT_PAIS_TRAB %in% estados) %>%
                                        filter(CVE_ENT %in% estados) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ENT) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ENT", paste0("Inmigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                 # Poblaci贸n Inmigrante
                ## Poblaci贸n que sale de su entidad de residencia y entra a otra demarcaci贸n por motivos laborales
                Inmigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                adorn_totals(c("row"), 
                                             fill = "-", 
                                             na.rm = TRUE) 
               
                # Poblaci贸n Emigrante
                ## Poblaci贸n que entra a la entidad para trabajar
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_ENT != ENT_PAIS_TRAB) %>%
                                       filter(ENT_PAIS_TRAB %in% estados) %>%
                                        filter(ENT_PAIS_TRAB %in% estados) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(ENT_PAIS_TRAB) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ENT", paste0("Emigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Emigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                        purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                               adorn_totals(c("row"), 
                                            fill = "-", 
                                            na.rm = TRUE) 
                
               # Tabla de resultados
                Resultados <- Pob.Total %>%
                               full_join(., Pob.Objetivo, by = c("CVE_ENT")) %>%
                               full_join(., Residentes, by = c("CVE_ENT")) %>%
                               full_join(., Inmigrantes, by = c("CVE_ENT")) %>%
                               full_join(., Emigrantes, by = c("CVE_ENT")) 
                return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "SITTRA")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "CAUSA_MIG")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "TIE_TRASLADO_TRAB")
addWorksheet(wb, "MED_TRASLADO_TRAB1")
addWorksheet(wb, "MED_TRASLADO_TRAB2")
addWorksheet(wb, "MED_TRASLADO_TRAB3")
writeData(wb, 1, Indicadores("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores("SITTRA"), colNames = TRUE)
writeData(wb, 5, Indicadores("PE"), colNames = TRUE)
writeData(wb, 6, Indicadores("AFRODES"), colNames = TRUE)
writeData(wb, 7, Indicadores("HLENGUA"), colNames = TRUE)
writeData(wb, 8, Indicadores("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 9, Indicadores("ALFABET"), colNames = TRUE)
writeData(wb, 10, Indicadores("CAUSA_MIG"), colNames = TRUE)
writeData(wb, 11, Indicadores("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 12, Indicadores("NIVACAD"), colNames = TRUE)
writeData(wb, 13, Indicadores("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 14, Indicadores("TIE_TRASLADO_TRAB"), colNames = TRUE)
writeData(wb, 15, Indicadores("MED_TRASLADO_TRAB1"), colNames = TRUE)
writeData(wb, 16, Indicadores("MED_TRASLADO_TRAB2"), colNames = TRUE)
writeData(wb, 17, Indicadores("MED_TRASLADO_TRAB3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),  "/Output/Estado/03_Movilidad laboral/2020/SDEM/Indicadores sociodemograficos a nivel estatal 2020.xlsx"), overwrite = TRUE)
```

### Valores relativos  

```{r}
#Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"
names(data)
Indicadores_P <- function(Variable){
                    # Municipios
                    ## municipios <- MUN %>% pull(CVE_MUN)
                    
                    # Estados 
                    estados <- ENT %>% pull(CVE_ENT)
    
                    # Variable que se dese analizar
                    X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                          unlist()
                    # Etiquetas para las columnnas
                    etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                                  unlist()
    
                    # Poblaci贸n total
                    Pob.Total <- data %>%
                                  as.data.frame() %>%
                                   filter(CVE_ENT %in% estados) %>%
                                    group_by(CVE_ENT) %>%
                                     summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                      ungroup() %>%
                                       adorn_totals(c("row"), 
                                                    fill = "-", 
                                                     na.rm = TRUE) 
                    
                    #Poblaci贸n desagregada
                     # Filtro de la poblaci贸n desagregada
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]   
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                          filter(CVE_ENT %in% estados) %>%
                                           filter(ENT_PAIS_TRAB %in% estados) %>%
                                            filter(get(Variable) %in% Var) %>%
                                             group_by(CVE_ENT) %>%
                                              summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                               set_names(c("CVE_ENT", paste0("Pob_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Pob.Objetivo <- left_join(ENT %>% select(CVE_ENT), 
                                              purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                  na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
    
                    # Poblaci贸n residente 
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]     
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                          filter(CVE_ENT == ENT_PAIS_TRAB) %>%
                                           filter(ENT_PAIS_TRAB %in% estados) %>%
                                            filter(get(Variable) %in% Var) %>%
                                             group_by(CVE_ENT) %>%
                                              summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                               set_names(c("CVE_ENT", paste0("Residentes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
    
                    Residentes <- left_join(ENT %>% select(CVE_ENT), 
                                              purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                na.rm = TRUE) %>%
                                    adorn_percentages(denominator = "row") 
                    
                    # Poblaci贸n Inmigrante
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]      
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                          filter(CVE_ENT != ENT_PAIS_TRAB) %>%
                                           filter(ENT_PAIS_TRAB %in% estados) %>%
                                            filter(CVE_ENT %in% estados) %>%
                                             filter(get(Variable) %in% Var) %>%
                                              group_by(CVE_ENT) %>%
                                               summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                                set_names(c("CVE_ENT", paste0("Inmigrantes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                     # Poblaci贸n Inmigrante
                    ## Poblaci贸n que sale de su entidad de residencia y entra a otra demarcaci贸n por motivos laborales
                    Inmigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                              purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                    adorn_totals(c("row"), 
                                                 fill = "-", 
                                                 na.rm = TRUE) %>%
                                     adorn_percentages(denominator = "row") 
                   
                    # Poblaci贸n Emigrante
                    ## Poblaci贸n que entra a la entidad para trabajar
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]      
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                          filter(CVE_ENT != ENT_PAIS_TRAB) %>%
                                           filter(ENT_PAIS_TRAB %in% estados) %>%
                                            filter(ENT_PAIS_TRAB %in% estados) %>%
                                             filter(get(Variable) %in% Var) %>%
                                              group_by(ENT_PAIS_TRAB) %>%
                                               summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                                set_names(c("CVE_ENT", paste0("Emigrantes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Emigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                              purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                na.rm = TRUE) %>%
                                    adorn_percentages(denominator = "row") 
                    
                   # Tabla de resultados
                    Resultados <- Pob.Total %>%
                                   full_join(., Pob.Objetivo, by = c("CVE_ENT")) %>%
                                   full_join(., Residentes, by = c("CVE_ENT")) %>%
                                   full_join(., Inmigrantes, by = c("CVE_ENT")) %>%
                                   full_join(., Emigrantes, by = c("CVE_ENT")) 
                    return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "SITTRA")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "CAUSA_MIG")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "TIE_TRASLADO_TRAB")
addWorksheet(wb, "MED_TRASLADO_TRAB1")
addWorksheet(wb, "MED_TRASLADO_TRAB2")
addWorksheet(wb, "MED_TRASLADO_TRAB3")
writeData(wb, 1, Indicadores_P("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores_P("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores_P("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores_P("SITTRA"), colNames = TRUE)
writeData(wb, 5, Indicadores_P("PE"), colNames = TRUE)
writeData(wb, 6, Indicadores_P("AFRODES"), colNames = TRUE)
writeData(wb, 7, Indicadores_P("HLENGUA"), colNames = TRUE)
writeData(wb, 8, Indicadores_P("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 9, Indicadores_P("ALFABET"), colNames = TRUE)
writeData(wb, 10, Indicadores_P("CAUSA_MIG"), colNames = TRUE)
writeData(wb, 11, Indicadores_P("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 12, Indicadores_P("NIVACAD"), colNames = TRUE)
writeData(wb, 13, Indicadores_P("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 14, Indicadores_P("TIE_TRASLADO_TRAB"), colNames = TRUE)
writeData(wb, 15, Indicadores_P("MED_TRASLADO_TRAB1"), colNames = TRUE)
writeData(wb, 16, Indicadores_P("MED_TRASLADO_TRAB2"), colNames = TRUE)
writeData(wb, 17, Indicadores_P("MED_TRASLADO_TRAB3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),  "/Output/Estado/03_Movilidad laboral/2020/SDEM/Indicadores sociodemograficos a nivel estatal 2020_Porcentajes.xlsx"), overwrite = TRUE)
```

# Nivel municipal {.tabset .tabset-pills}   

```{r}
### Municipios que no pertenecen en la muestra
municipios_nomuestra <- c("004012", "007125", "029048")

#Clave de los municipios 2020 
municipios <- MUN %>%
               select(CVE_MUN) %>%
                unique() %>%
                 filter(CVE_MUN %nin% municipios_nomuestra) %>%
                  pull(CVE_MUN)

data <- data %>%
         mutate(CVE_MUN_TRABAJO = paste0(ENT_PAIS_TRAB, MUN_TRAB)) %>%
          mutate(ENT_PAIS_TRAB = case_when(.$ENT_PAIS_TRAB %in% estados ~.$ENT_PAIS_TRAB,
                                           .$ENT_PAIS_TRAB %nin% estados ~ "888", #Residencia en otro pa铆s
                                           .$ENT_PAIS_TRAB %in% "997" ~ "997",
                                           .$ENT_PAIS_TRAB %in% "998" ~ "998",
                                           .$ENT_PAIS_TRAB %in% "997" ~ "999"),
                 CVE_MUN_TRABAJO = case_when(.$CVE_MUN_TRABAJO %in% municipios ~.$CVE_MUN_TRABAJO,
                                             #### Se excluyen los municipios que no fueron muestreados
                                             .$CVE_MUN_TRABAJO %in% municipios_nomuestra ~ "777",
                                              nchar(.$CVE_MUN_TRABAJO) == 3 ~ "888",  #Residencia en otro pa铆s
                                             .$CVE_MUN_TRABAJO %in% "997999" ~ '997999',
                                             .$ENT_PAIS_TRAB %in% "997" ~ "997",
                                             .$ENT_PAIS_TRAB %in% "998" ~ "998",
                                             .$ENT_PAIS_TRAB %in% "999" ~ "999",
                                             .$MUN_TRAB %in% "999" ~ "999")) %>%
           mutate(I_Migracion = case_when(.$CVE_ENT == .$ENT_PAIS_TRAB & .$ENT_PAIS_TRAB %in% estados ~ 1,
                                          .$CVE_ENT != .$ENT_PAIS_TRAB & .$ENT_PAIS_TRAB %in% estados ~ 2,
                                          .$ENT_PAIS_TRAB %nin% estados ~ 3))
```


## Indicadores sociodemogr谩ficos {.tabset .tabset-pills}   

### Nivel municipal {.tabset .tabset-pills}   

#### Valores absolutos   

```{r}
#Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores <- function(Variable){
                # Municipios
                ### Municipios que no pertenecen en la muestra
                municipios_nomuestra <- c("004012", "007125", "029048")
                
                #Clave de los municipios 2020 
                municipios <- MUN %>%
                               select(CVE_MUN) %>%
                                unique() %>%
                                 filter(CVE_MUN %nin% municipios_nomuestra) %>%
                                  pull(CVE_MUN)
                
                # Estados 
                estados <- ENT %>% pull(CVE_ENT)

                # Variable que se dese analizar
                X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                      unlist()
                # Etiquetas para las columnnas
                etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                              unlist()

                # Poblaci贸n total
                Pob.Total <- data %>%
                              as.data.frame() %>%
                               filter(CVE_MUN %in% municipios) %>%
                                group_by(CVE_MUN) %>%
                                 summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                  ungroup() %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
                #Poblaci贸n desagregada
                 # Filtro de la poblaci贸n desagregada
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]   
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN %in% municipios) %>%
                                       filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_MUN) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_MUN", paste0("Pob_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Pob.Objetivo <- left_join(MUN %>% select(CVE_MUN), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_MUN'), "CVE_MUN") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 

                # Poblaci贸n residente 
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]     
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN == CVE_MUN_TRABAJO)%>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_MUN) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_MUN", paste0("Residentes_", etiquetas[x])))
                  }, simplify = FALSE
                )

                Residentes <- left_join(MUN %>% select(CVE_MUN),
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_MUN'), "CVE_MUN") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE)
                
                # Poblaci贸n Inmigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_MUN) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_MUN", paste0("Inmigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Inmigrantes <- left_join(MUN %>% select(CVE_MUN),
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_MUN'), "CVE_MUN") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE)
               
                # Poblaci贸n Emigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_MUN_TRABAJO) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_MUN", paste0("Emigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Emigrantes <- left_join(MUN %>% select(CVE_MUN), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_MUN'), "CVE_MUN") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
               # Tabla de resultados
                Resultados <- Pob.Total %>%
                               full_join(., Pob.Objetivo, by = c("CVE_MUN")) %>%
                               full_join(., Residentes, by = c("CVE_MUN")) %>%
                               full_join(., Inmigrantes, by = c("CVE_MUN")) %>%
                               full_join(., Emigrantes, by = c("CVE_MUN")) 
                return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "SITTRA")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "CAUSA_MIG")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "TIE_TRASLADO_TRAB")
addWorksheet(wb, "MED_TRASLADO_TRAB1")
addWorksheet(wb, "MED_TRASLADO_TRAB2")
addWorksheet(wb, "MED_TRASLADO_TRAB3")
writeData(wb, 1, Indicadores("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores("SITTRA"), colNames = TRUE)
writeData(wb, 5, Indicadores("PE"), colNames = TRUE)
writeData(wb, 6, Indicadores("AFRODES"), colNames = TRUE)
writeData(wb, 7, Indicadores("HLENGUA"), colNames = TRUE)
writeData(wb, 8, Indicadores("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 9, Indicadores("ALFABET"), colNames = TRUE)
writeData(wb, 10, Indicadores("CAUSA_MIG"), colNames = TRUE)
writeData(wb, 11, Indicadores("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 12, Indicadores("NIVACAD"), colNames = TRUE)
writeData(wb, 13, Indicadores("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 14, Indicadores("TIE_TRASLADO_TRAB"), colNames = TRUE)
writeData(wb, 15, Indicadores("MED_TRASLADO_TRAB1"), colNames = TRUE)
writeData(wb, 16, Indicadores("MED_TRASLADO_TRAB2"), colNames = TRUE)
writeData(wb, 17, Indicadores("MED_TRASLADO_TRAB3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),  "/Output/Municipio/03_Movilidad laboral/2020/SDEM/Indicadores sociodemograficos a nivel municipal 2020.xlsx"), overwrite = TRUE)
```

#### Valores relativos  

```{r}
#Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores_P <- function(Variable){
                  # Municipios
                  ### Municipios que no pertenecen en la muestra
                  municipios_nomuestra <- c("004012", "007125", "029048")
                  
                  #Clave de los municipios 2020 
                  municipios <- MUN %>%
                                 select(CVE_MUN) %>%
                                  unique() %>%
                                   filter(CVE_MUN %nin% municipios_nomuestra) %>%
                                    pull(CVE_MUN)
                  
                  # Estados 
                  estados <- ENT %>% pull(CVE_ENT)
  
                  # Variable que se dese analizar
                  X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                        unlist()
                  # Etiquetas para las columnnas
                  etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                                unlist()
  
                  # Poblaci贸n total
                  Pob.Total <- data %>%
                                as.data.frame() %>%
                                 filter(CVE_MUN %in% municipios) %>%
                                  group_by(CVE_MUN) %>%
                                   summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                    ungroup() %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) 
                  
                  #Poblaci贸n desagregada
                   # Filtro de la poblaci贸n desagregada
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]   
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN %in% municipios) %>%
                                         filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                          filter(get(Variable) %in% Var) %>%
                                           group_by(CVE_MUN) %>%
                                            summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                             set_names(c("CVE_MUN", paste0("Pob_", etiquetas[x])))
                    }, simplify = FALSE
                  )
                  
                  Pob.Objetivo <- left_join(MUN %>% select(CVE_MUN), 
                                            purrr::reduce(p, dplyr::full_join, by = 'CVE_MUN'), "CVE_MUN") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
  
                  # Poblaci贸n residente 
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]     
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN == CVE_MUN_TRABAJO)%>%
                                         filter(CVE_MUN %in% municipios) %>%
                                          filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                           filter(get(Variable) %in% Var) %>%
                                            group_by(CVE_MUN) %>%
                                             summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                              set_names(c("CVE_MUN", paste0("Residentes_", etiquetas[x])))
                    }, simplify = FALSE
                  )
  
                  Residentes <- left_join(MUN %>% select(CVE_MUN),
                                           purrr::reduce(p, dplyr::full_join, by = 'CVE_MUN'), "CVE_MUN") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
                  
                  # Poblaci贸n Inmigrante
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]      
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                         filter(CVE_MUN %in% municipios) %>%
                                          filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                           filter(get(Variable) %in% Var) %>%
                                            group_by(CVE_MUN) %>%
                                             summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                              set_names(c("CVE_MUN", paste0("Inmigrantes_", etiquetas[x])))
                    }, simplify = FALSE
                  )
                  
                  Inmigrantes <- left_join(MUN %>% select(CVE_MUN),
                                            purrr::reduce(p, dplyr::full_join, by = 'CVE_MUN'), "CVE_MUN") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
                 
                  # Poblaci贸n Emigrante
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]      
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                         filter(CVE_MUN %in% municipios) %>%
                                          filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                           filter(get(Variable) %in% Var) %>%
                                            group_by(CVE_MUN_TRABAJO) %>%
                                             summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                              set_names(c("CVE_MUN", paste0("Emigrantes_", etiquetas[x])))
                    }, simplify = FALSE
                  )
                  
                  Emigrantes <- left_join(MUN %>% select(CVE_MUN), 
                                           purrr::reduce(p, dplyr::full_join, by = 'CVE_MUN'), "CVE_MUN") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
                  
                 # Tabla de resultados
                  Resultados <- Pob.Total %>%
                                 full_join(., Pob.Objetivo, by = c("CVE_MUN")) %>%
                                 full_join(., Residentes, by = c("CVE_MUN")) %>%
                                 full_join(., Inmigrantes, by = c("CVE_MUN")) %>%
                                 full_join(., Emigrantes, by = c("CVE_MUN")) 
                  return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "SITTRA")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "CAUSA_MIG")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "TIE_TRASLADO_TRAB")
addWorksheet(wb, "MED_TRASLADO_TRAB1")
addWorksheet(wb, "MED_TRASLADO_TRAB2")
addWorksheet(wb, "MED_TRASLADO_TRAB3")
writeData(wb, 1, Indicadores_P("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores_P("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores_P("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores_P("SITTRA"), colNames = TRUE)
writeData(wb, 5, Indicadores_P("PE"), colNames = TRUE)
writeData(wb, 6, Indicadores_P("AFRODES"), colNames = TRUE)
writeData(wb, 7, Indicadores_P("HLENGUA"), colNames = TRUE)
writeData(wb, 8, Indicadores_P("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 9, Indicadores_P("ALFABET"), colNames = TRUE)
writeData(wb, 10, Indicadores_P("CAUSA_MIG"), colNames = TRUE)
writeData(wb, 11, Indicadores_P("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 12, Indicadores_P("NIVACAD"), colNames = TRUE)
writeData(wb, 13, Indicadores_P("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 14, Indicadores_P("TIE_TRASLADO_TRAB"), colNames = TRUE)
writeData(wb, 15, Indicadores_P("MED_TRASLADO_TRAB1"), colNames = TRUE)
writeData(wb, 16, Indicadores_P("MED_TRASLADO_TRAB2"), colNames = TRUE)
writeData(wb, 17, Indicadores_P("MED_TRASLADO_TRAB3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),  "/Output/Municipio/03_Movilidad laboral/2020/SDEM/Indicadores sociodemograficos a nivel municipal 2020_Porcentajes.xlsx"), overwrite = TRUE)
```

### Nivel estatal {.tabset .tabset-pills}   

#### Valores absolutos 

```{r}
#Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores <- function(Variable){
                # Municipios
                ### Municipios que no pertenecen en la muestra
                municipios_nomuestra <- c("004012", "007125", "029048")
                
                #Clave de los municipios 2020 
                municipios <- MUN %>%
                               select(CVE_MUN) %>%
                                unique() %>%
                                 filter(CVE_MUN %nin% municipios_nomuestra) %>%
                                  pull(CVE_MUN)
                
                # Estados 
                estados <- ENT %>% pull(CVE_ENT)

                # Variable que se dese analizar
                X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                      unlist()
                # Etiquetas para las columnnas
                etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                              unlist()

                # Poblaci贸n total
                Pob.Total <- data %>%
                              as.data.frame() %>%
                               filter(CVE_MUN %in% municipios) %>%
                                group_by(CVE_ENT) %>%
                                 summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                  ungroup() %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
                #Poblaci贸n desagregada
                 # Filtro de la poblaci贸n desagregada
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]   
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN %in% municipios) %>%
                                       filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ENT) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ENT", paste0("Pob_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Pob.Objetivo <- left_join(ENT %>% select(CVE_ENT), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 

                # Poblaci贸n residente 
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]     
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN == CVE_MUN_TRABAJO)%>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ENT) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ENT", paste0("Residentes_", etiquetas[x])))
                  }, simplify = FALSE
                )

                Residentes <- left_join(ENT %>% select(CVE_ENT), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE)
                
                # Poblaci贸n Inmigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ENT) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ENT", paste0("Inmigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Inmigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE)
               
                # Poblaci贸n Emigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(ENT_PAIS_TRAB) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ENT", paste0("Emigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Emigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
               # Tabla de resultados
                Resultados <- Pob.Total %>%
                               full_join(., Pob.Objetivo, by = c("CVE_ENT")) %>%
                               full_join(., Residentes, by = c("CVE_ENT")) %>%
                               full_join(., Inmigrantes, by = c("CVE_ENT")) %>%
                               full_join(., Emigrantes, by = c("CVE_ENT")) 
                return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "SITTRA")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "CAUSA_MIG")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "TIE_TRASLADO_TRAB")
addWorksheet(wb, "MED_TRASLADO_TRAB1")
addWorksheet(wb, "MED_TRASLADO_TRAB2")
addWorksheet(wb, "MED_TRASLADO_TRAB3")
writeData(wb, 1, Indicadores("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores("SITTRA"), colNames = TRUE)
writeData(wb, 5, Indicadores("PE"), colNames = TRUE)
writeData(wb, 6, Indicadores("AFRODES"), colNames = TRUE)
writeData(wb, 7, Indicadores("HLENGUA"), colNames = TRUE)
writeData(wb, 8, Indicadores("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 9, Indicadores("ALFABET"), colNames = TRUE)
writeData(wb, 10, Indicadores("CAUSA_MIG"), colNames = TRUE)
writeData(wb, 11, Indicadores("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 12, Indicadores("NIVACAD"), colNames = TRUE)
writeData(wb, 13, Indicadores("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 14, Indicadores("TIE_TRASLADO_TRAB"), colNames = TRUE)
writeData(wb, 15, Indicadores("MED_TRASLADO_TRAB1"), colNames = TRUE)
writeData(wb, 16, Indicadores("MED_TRASLADO_TRAB2"), colNames = TRUE)
writeData(wb, 17, Indicadores("MED_TRASLADO_TRAB3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),  "/Output/Municipio/03_Movilidad laboral/2020/SDEM/Indicadores sociodemograficos a nivel estatal 2020.xlsx"), overwrite = TRUE)
```

#### Valores relativos

```{r}
#Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores_P <- function(Variable){
                  # Municipios
                  ### Municipios que no pertenecen en la muestra
                  municipios_nomuestra <- c("004012", "007125", "029048")
                  
                  #Clave de los municipios 2020 
                  municipios <- MUN %>%
                                 select(CVE_MUN) %>%
                                  unique() %>%
                                   filter(CVE_MUN %nin% municipios_nomuestra) %>%
                                    pull(CVE_MUN)
                  
                  # Estados 
                  estados <- ENT %>% pull(CVE_ENT)
  
                  # Variable que se dese analizar
                  X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                        unlist()
                  # Etiquetas para las columnnas
                  etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                                unlist()
  
                  # Poblaci贸n total
                  Pob.Total <- data %>%
                                as.data.frame() %>%
                                 filter(CVE_MUN %in% municipios) %>%
                                  group_by(CVE_ENT) %>%
                                   summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                    ungroup() %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
                  
                  #Poblaci贸n desagregada
                   # Filtro de la poblaci贸n desagregada
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]   
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN %in% municipios) %>%
                                         filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                          filter(get(Variable) %in% Var) %>%
                                           group_by(CVE_ENT) %>%
                                            summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                             set_names(c("CVE_ENT", paste0("Pob_", etiquetas[x])))
                    }, simplify = FALSE
                  )
                  
                  Pob.Objetivo <- left_join(ENT %>% select(CVE_ENT), 
                                            purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
  
                  # Poblaci贸n residente 
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]     
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN == CVE_MUN_TRABAJO)%>%
                                         filter(CVE_MUN %in% municipios) %>%
                                          filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                           filter(get(Variable) %in% Var) %>%
                                            group_by(CVE_ENT) %>%
                                             summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                              set_names(c("CVE_ENT", paste0("Residentes_", etiquetas[x])))
                    }, simplify = FALSE
                  )
  
                  Residentes <- left_join(ENT %>% select(CVE_ENT), 
                                           purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                 adorn_totals(c("row"), 
                                              fill = "-", 
                                              na.rm = TRUE) %>%
                                  adorn_percentages(denominator = "row") 
                  
                  # Poblaci贸n Inmigrante
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]      
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                         filter(CVE_MUN %in% municipios) %>%
                                          filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                           filter(get(Variable) %in% Var) %>%
                                            group_by(CVE_ENT) %>%
                                             summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                              set_names(c("CVE_ENT", paste0("Inmigrantes_", etiquetas[x])))
                    }, simplify = FALSE
                  )
                  
                  Inmigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                            purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                  adorn_totals(c("row"), 
                                               fill = "-", 
                                               na.rm = TRUE) %>%
                                   adorn_percentages(denominator = "row") 
                 
                  # Poblaci贸n Emigrante
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]      
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                         filter(CVE_MUN %in% municipios) %>%
                                          filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                           filter(get(Variable) %in% Var) %>%
                                            group_by(ENT_PAIS_TRAB) %>%
                                             summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                              set_names(c("CVE_ENT", paste0("Emigrantes_", etiquetas[x])))
                    }, simplify = FALSE
                  )
                  
                  Emigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                           purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
                  
                 # Tabla de resultados
                  Resultados <- Pob.Total %>%
                                 full_join(., Pob.Objetivo, by = c("CVE_ENT")) %>%
                                 full_join(., Residentes, by = c("CVE_ENT")) %>%
                                 full_join(., Inmigrantes, by = c("CVE_ENT")) %>%
                                 full_join(., Emigrantes, by = c("CVE_ENT")) 
                  return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "SITTRA")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "CAUSA_MIG")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "TIE_TRASLADO_TRAB")
addWorksheet(wb, "MED_TRASLADO_TRAB1")
addWorksheet(wb, "MED_TRASLADO_TRAB2")
addWorksheet(wb, "MED_TRASLADO_TRAB3")
writeData(wb, 1, Indicadores_P("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores_P("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores_P("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores_P("SITTRA"), colNames = TRUE)
writeData(wb, 5, Indicadores_P("PE"), colNames = TRUE)
writeData(wb, 6, Indicadores_P("AFRODES"), colNames = TRUE)
writeData(wb, 7, Indicadores_P("HLENGUA"), colNames = TRUE)
writeData(wb, 8, Indicadores_P("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 9, Indicadores_P("ALFABET"), colNames = TRUE)
writeData(wb, 10, Indicadores_P("CAUSA_MIG"), colNames = TRUE)
writeData(wb, 11, Indicadores_P("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 12, Indicadores_P("NIVACAD"), colNames = TRUE)
writeData(wb, 13, Indicadores_P("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 14, Indicadores_P("TIE_TRASLADO_TRAB"), colNames = TRUE)
writeData(wb, 15, Indicadores_P("MED_TRASLADO_TRAB1"), colNames = TRUE)
writeData(wb, 16, Indicadores_P("MED_TRASLADO_TRAB2"), colNames = TRUE)
writeData(wb, 17, Indicadores_P("MED_TRASLADO_TRAB3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),  "/Output/Municipio/03_Movilidad laboral/2020/SDEM/Indicadores sociodemograficos a nivel estatal 2020_Porcentajes.xlsx"), overwrite = TRUE)
```

### Nivel intramunicipal {.tabset .tabset-pills}   

#### Valores absolutos 

```{r}
#Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores <- function(Variable){
                # Base de datos con filtro
                data <- data %>%
                         filter(I_Migracion == 1)
                
                # Municipios
                ### Municipios que no pertenecen en la muestra
                municipios_nomuestra <- c("004012", "007125", "029048")
                
                #Clave de los municipios 2020 
                municipios <- MUN %>%
                               select(CVE_MUN) %>%
                                unique() %>%
                                 filter(CVE_MUN %nin% municipios_nomuestra) %>%
                                  pull(CVE_MUN)
                
                # Estados 
                estados <- ENT %>% pull(CVE_ENT)

                # Variable que se dese analizar
                X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                      unlist()
                # Etiquetas para las columnnas
                etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                              unlist()

                # Poblaci贸n total
                Pob.Total <- data %>%
                              as.data.frame() %>%
                               filter(CVE_MUN %in% municipios) %>%
                                group_by(CVE_ENT) %>%
                                 summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                  ungroup() %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
                #Poblaci贸n desagregada
                 # Filtro de la poblaci贸n desagregada
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]   
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN %in% municipios) %>%
                                       filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ENT) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ENT", paste0("Pob_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Pob.Objetivo <- left_join(ENT %>% select(CVE_ENT), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 

                # Poblaci贸n residente 
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]     
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN == CVE_MUN_TRABAJO)%>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ENT) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ENT", paste0("Residentes_", etiquetas[x])))
                  }, simplify = FALSE
                )

                Residentes <- left_join(ENT %>% select(CVE_ENT), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE)
                
                # Poblaci贸n Inmigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ENT) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ENT", paste0("Inmigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Inmigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE)
               
                # Poblaci贸n Emigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(ENT_PAIS_TRAB) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ENT", paste0("Emigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Emigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
               # Tabla de resultados
                Resultados <- Pob.Total %>%
                               full_join(., Pob.Objetivo, by = c("CVE_ENT")) %>%
                               full_join(., Residentes, by = c("CVE_ENT")) %>%
                               full_join(., Inmigrantes, by = c("CVE_ENT")) %>%
                               full_join(., Emigrantes, by = c("CVE_ENT")) 
                return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "SITTRA")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "CAUSA_MIG")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "TIE_TRASLADO_TRAB")
addWorksheet(wb, "MED_TRASLADO_TRAB1")
addWorksheet(wb, "MED_TRASLADO_TRAB2")
addWorksheet(wb, "MED_TRASLADO_TRAB3")
writeData(wb, 1, Indicadores("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores("SITTRA"), colNames = TRUE)
writeData(wb, 5, Indicadores("PE"), colNames = TRUE)
writeData(wb, 6, Indicadores("AFRODES"), colNames = TRUE)
writeData(wb, 7, Indicadores("HLENGUA"), colNames = TRUE)
writeData(wb, 8, Indicadores("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 9, Indicadores("ALFABET"), colNames = TRUE)
writeData(wb, 10, Indicadores("CAUSA_MIG"), colNames = TRUE)
writeData(wb, 11, Indicadores("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 12, Indicadores("NIVACAD"), colNames = TRUE)
writeData(wb, 13, Indicadores("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 14, Indicadores("TIE_TRASLADO_TRAB"), colNames = TRUE)
writeData(wb, 15, Indicadores("MED_TRASLADO_TRAB1"), colNames = TRUE)
writeData(wb, 16, Indicadores("MED_TRASLADO_TRAB2"), colNames = TRUE)
writeData(wb, 17, Indicadores("MED_TRASLADO_TRAB3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),  "/Output/Municipio/03_Movilidad laboral/2020/SDEM/Indicadores sociodemograficos a nivel intramunicipal 2020.xlsx"), overwrite = TRUE)
```


#### Valores relativos

```{r}
#Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores_P <- function(Variable){
                  # Base de datos con filtro
                  data <- data %>%
                           filter(I_Migracion == 1)
                  
                  # Municipios
                  ### Municipios que no pertenecen en la muestra
                  municipios_nomuestra <- c("004012", "007125", "029048")
                  
                  #Clave de los municipios 2020 
                  municipios <- MUN %>%
                                 select(CVE_MUN) %>%
                                  unique() %>%
                                   filter(CVE_MUN %nin% municipios_nomuestra) %>%
                                    pull(CVE_MUN)
                  
                  # Estados 
                  estados <- ENT %>% pull(CVE_ENT)
  
                  # Variable que se dese analizar
                  X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                        unlist()
                  # Etiquetas para las columnnas
                  etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                                unlist()
  
                  # Poblaci贸n total
                  Pob.Total <- data %>%
                                as.data.frame() %>%
                                 filter(CVE_MUN %in% municipios) %>%
                                  group_by(CVE_ENT) %>%
                                   summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                    ungroup() %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
                  
                  #Poblaci贸n desagregada
                   # Filtro de la poblaci贸n desagregada
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]   
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN %in% municipios) %>%
                                         filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                          filter(get(Variable) %in% Var) %>%
                                           group_by(CVE_ENT) %>%
                                            summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                             set_names(c("CVE_ENT", paste0("Pob_", etiquetas[x])))
                    }, simplify = FALSE
                  )
                  
                  Pob.Objetivo <- left_join(ENT %>% select(CVE_ENT), 
                                            purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
  
                  # Poblaci贸n residente 
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]     
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN == CVE_MUN_TRABAJO)%>%
                                         filter(CVE_MUN %in% municipios) %>%
                                          filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                           filter(get(Variable) %in% Var) %>%
                                            group_by(CVE_ENT) %>%
                                             summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                              set_names(c("CVE_ENT", paste0("Residentes_", etiquetas[x])))
                    }, simplify = FALSE
                  )
  
                  Residentes <- left_join(ENT %>% select(CVE_ENT), 
                                           purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
                  
                  # Poblaci贸n Inmigrante
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]      
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                         filter(CVE_MUN %in% municipios) %>%
                                          filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                           filter(get(Variable) %in% Var) %>%
                                            group_by(CVE_ENT) %>%
                                             summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                              set_names(c("CVE_ENT", paste0("Inmigrantes_", etiquetas[x])))
                    }, simplify = FALSE
                  )
                  
                  Inmigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                            purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
                 
                  # Poblaci贸n Emigrante
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]      
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                         filter(CVE_MUN %in% municipios) %>%
                                          filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                           filter(get(Variable) %in% Var) %>%
                                            group_by(ENT_PAIS_TRAB) %>%
                                             summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                              set_names(c("CVE_ENT", paste0("Emigrantes_", etiquetas[x])))
                    }, simplify = FALSE
                  )
                  
                  Emigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                           purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
                  
                 # Tabla de resultados
                  Resultados <- Pob.Total %>%
                                 full_join(., Pob.Objetivo, by = c("CVE_ENT")) %>%
                                 full_join(., Residentes, by = c("CVE_ENT")) %>%
                                 full_join(., Inmigrantes, by = c("CVE_ENT")) %>%
                                 full_join(., Emigrantes, by = c("CVE_ENT")) 
                  return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "SITTRA")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "CAUSA_MIG")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "TIE_TRASLADO_TRAB")
addWorksheet(wb, "MED_TRASLADO_TRAB1")
addWorksheet(wb, "MED_TRASLADO_TRAB2")
addWorksheet(wb, "MED_TRASLADO_TRAB3")
writeData(wb, 1, Indicadores_P("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores_P("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores_P("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores_P("SITTRA"), colNames = TRUE)
writeData(wb, 5, Indicadores_P("PE"), colNames = TRUE)
writeData(wb, 6, Indicadores_P("AFRODES"), colNames = TRUE)
writeData(wb, 7, Indicadores_P("HLENGUA"), colNames = TRUE)
writeData(wb, 8, Indicadores_P("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 9, Indicadores_P("ALFABET"), colNames = TRUE)
writeData(wb, 10, Indicadores_P("CAUSA_MIG"), colNames = TRUE)
writeData(wb, 11, Indicadores_P("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 12, Indicadores_P("NIVACAD"), colNames = TRUE)
writeData(wb, 13, Indicadores_P("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 14, Indicadores_P("TIE_TRASLADO_TRAB"), colNames = TRUE)
writeData(wb, 15, Indicadores_P("MED_TRASLADO_TRAB1"), colNames = TRUE)
writeData(wb, 16, Indicadores_P("MED_TRASLADO_TRAB2"), colNames = TRUE)
writeData(wb, 17, Indicadores_P("MED_TRASLADO_TRAB3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),  "/Output/Municipio/03_Movilidad laboral/2020/SDEM/Indicadores sociodemograficos a nivel intramunicipal 2020_Porcentajes.xlsx"), overwrite = TRUE)
```


### Nivel intermunicipal {.tabset .tabset-pills}   

#### Valores absolutos 

```{r}
#Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores <- function(Variable){
                # Base de datos con filtro
                data <- data %>%
                         filter(I_Migracion == 2)
                
                # Municipios
                ### Municipios que no pertenecen en la muestra
                municipios_nomuestra <- c("004012", "007125", "029048")
                
                #Clave de los municipios 2020 
                municipios <- MUN %>%
                               select(CVE_MUN) %>%
                                unique() %>%
                                 filter(CVE_MUN %nin% municipios_nomuestra) %>%
                                  pull(CVE_MUN)
                
                # Estados 
                estados <- ENT %>% pull(CVE_ENT)

                # Variable que se dese analizar
                X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                      unlist()
                # Etiquetas para las columnnas
                etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                              unlist()

                # Poblaci贸n total
                Pob.Total <- data %>%
                              as.data.frame() %>%
                               filter(CVE_MUN %in% municipios) %>%
                                group_by(CVE_ENT) %>%
                                 summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                  ungroup() %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
                #Poblaci贸n desagregada
                 # Filtro de la poblaci贸n desagregada
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]   
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN %in% municipios) %>%
                                       filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ENT) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ENT", paste0("Pob_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Pob.Objetivo <- left_join(ENT %>% select(CVE_ENT), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 

                # Poblaci贸n residente 
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]     
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN == CVE_MUN_TRABAJO)%>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ENT) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ENT", paste0("Residentes_", etiquetas[x])))
                  }, simplify = FALSE
                )

                Residentes <- left_join(ENT %>% select(CVE_ENT), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE)
                
                # Poblaci贸n Inmigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ENT) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ENT", paste0("Inmigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Inmigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE)
               
                # Poblaci贸n Emigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                      filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(ENT_PAIS_TRAB) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ENT", paste0("Emigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Emigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
               # Tabla de resultados
                Resultados <- Pob.Total %>%
                               full_join(., Pob.Objetivo, by = c("CVE_ENT")) %>%
                               full_join(., Residentes, by = c("CVE_ENT")) %>%
                               full_join(., Inmigrantes, by = c("CVE_ENT")) %>%
                               full_join(., Emigrantes, by = c("CVE_ENT")) 
                return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "SITTRA")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "CAUSA_MIG")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "TIE_TRASLADO_TRAB")
addWorksheet(wb, "MED_TRASLADO_TRAB1")
addWorksheet(wb, "MED_TRASLADO_TRAB2")
addWorksheet(wb, "MED_TRASLADO_TRAB3")
writeData(wb, 1, Indicadores("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores("SITTRA"), colNames = TRUE)
writeData(wb, 5, Indicadores("PE"), colNames = TRUE)
writeData(wb, 6, Indicadores("AFRODES"), colNames = TRUE)
writeData(wb, 7, Indicadores("HLENGUA"), colNames = TRUE)
writeData(wb, 8, Indicadores("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 9, Indicadores("ALFABET"), colNames = TRUE)
writeData(wb, 10, Indicadores("CAUSA_MIG"), colNames = TRUE)
writeData(wb, 11, Indicadores("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 12, Indicadores("NIVACAD"), colNames = TRUE)
writeData(wb, 13, Indicadores("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 14, Indicadores("TIE_TRASLADO_TRAB"), colNames = TRUE)
writeData(wb, 15, Indicadores("MED_TRASLADO_TRAB1"), colNames = TRUE)
writeData(wb, 16, Indicadores("MED_TRASLADO_TRAB2"), colNames = TRUE)
writeData(wb, 17, Indicadores("MED_TRASLADO_TRAB3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),  "/Output/Municipio/03_Movilidad laboral/2020/SDEM/Indicadores sociodemograficos a nivel intermunicipal 2020.xlsx"), overwrite = TRUE)
```

#### Valores relativos

```{r}
#Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores_P <- function(Variable){
                  # Base de datos con filtro
                  data <- data %>%
                           filter(I_Migracion == 2)
                  # Municipios
                  ### Municipios que no pertenecen en la muestra
                  municipios_nomuestra <- c("004012", "007125", "029048")
                  
                  #Clave de los municipios 2020 
                  municipios <- MUN %>%
                                 select(CVE_MUN) %>%
                                  unique() %>%
                                   filter(CVE_MUN %nin% municipios_nomuestra) %>%
                                    pull(CVE_MUN)
                  
                  # Estados 
                  estados <- ENT %>% pull(CVE_ENT)
  
                  # Variable que se dese analizar
                  X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                        unlist()
                  # Etiquetas para las columnnas
                  etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                                unlist()
  
                  # Poblaci贸n total
                  Pob.Total <- data %>%
                                as.data.frame() %>%
                                 filter(CVE_MUN %in% municipios) %>%
                                  group_by(CVE_ENT) %>%
                                   summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                    ungroup() %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
                  
                  #Poblaci贸n desagregada
                   # Filtro de la poblaci贸n desagregada
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]   
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN %in% municipios) %>%
                                         filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                          filter(get(Variable) %in% Var) %>%
                                           group_by(CVE_ENT) %>%
                                            summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                             set_names(c("CVE_ENT", paste0("Pob_", etiquetas[x])))
                    }, simplify = FALSE
                  )
                  
                  Pob.Objetivo <- left_join(ENT %>% select(CVE_ENT), 
                                            purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
  
                  # Poblaci贸n residente 
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]     
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN == CVE_MUN_TRABAJO)%>%
                                         filter(CVE_MUN %in% municipios) %>%
                                          filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                           filter(get(Variable) %in% Var) %>%
                                            group_by(CVE_ENT) %>%
                                             summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                              set_names(c("CVE_ENT", paste0("Residentes_", etiquetas[x])))
                    }, simplify = FALSE
                  )
  
                  Residentes <- left_join(ENT %>% select(CVE_ENT), 
                                           purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
                  
                  # Poblaci贸n Inmigrante
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]      
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                         filter(CVE_MUN %in% municipios) %>%
                                          filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                           filter(get(Variable) %in% Var) %>%
                                            group_by(CVE_ENT) %>%
                                             summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                              set_names(c("CVE_ENT", paste0("Inmigrantes_", etiquetas[x])))
                    }, simplify = FALSE
                  )
                  
                  Inmigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                            purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
                 
                  # Poblaci贸n Emigrante
                  p <- sapply(1:length(X), function(x){
                                   Var <- X[x]      
                                    data %>%
                                     as.data.frame() %>%
                                      mutate(EDAD = as.numeric(.$EDAD)) %>%
                                       subset((EDAD >= 12 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                                        filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                                         filter(CVE_MUN %in% municipios) %>%
                                          filter(CVE_MUN_TRABAJO %in% municipios) %>%
                                           filter(get(Variable) %in% Var) %>%
                                            group_by(ENT_PAIS_TRAB) %>%
                                             summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                              set_names(c("CVE_ENT", paste0("Emigrantes_", etiquetas[x])))
                    }, simplify = FALSE
                  )
                  
                  Emigrantes <- left_join(ENT %>% select(CVE_ENT), 
                                           purrr::reduce(p, dplyr::full_join, by = 'CVE_ENT'), "CVE_ENT") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                   na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
                  
                 # Tabla de resultados
                  Resultados <- Pob.Total %>%
                                 full_join(., Pob.Objetivo, by = c("CVE_ENT")) %>%
                                 full_join(., Residentes, by = c("CVE_ENT")) %>%
                                 full_join(., Inmigrantes, by = c("CVE_ENT")) %>%
                                 full_join(., Emigrantes, by = c("CVE_ENT")) 
                  return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "SITTRA")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "CAUSA_MIG")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "TIE_TRASLADO_TRAB")
addWorksheet(wb, "MED_TRASLADO_TRAB1")
addWorksheet(wb, "MED_TRASLADO_TRAB2")
addWorksheet(wb, "MED_TRASLADO_TRAB3")
writeData(wb, 1, Indicadores_P("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores_P("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores_P("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores_P("SITTRA"), colNames = TRUE)
writeData(wb, 5, Indicadores_P("PE"), colNames = TRUE)
writeData(wb, 6, Indicadores_P("AFRODES"), colNames = TRUE)
writeData(wb, 7, Indicadores_P("HLENGUA"), colNames = TRUE)
writeData(wb, 8, Indicadores_P("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 9, Indicadores_P("ALFABET"), colNames = TRUE)
writeData(wb, 10, Indicadores_P("CAUSA_MIG"), colNames = TRUE)
writeData(wb, 11, Indicadores_P("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 12, Indicadores_P("NIVACAD"), colNames = TRUE)
writeData(wb, 13, Indicadores_P("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 14, Indicadores_P("TIE_TRASLADO_TRAB"), colNames = TRUE)
writeData(wb, 15, Indicadores_P("MED_TRASLADO_TRAB1"), colNames = TRUE)
writeData(wb, 16, Indicadores_P("MED_TRASLADO_TRAB2"), colNames = TRUE)
writeData(wb, 17, Indicadores_P("MED_TRASLADO_TRAB3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),  "/Output/Municipio/03_Movilidad laboral/2020/SDEM/Indicadores sociodemograficos a nivel intermunicipal 2020_Porcentajes.xlsx"), overwrite = TRUE)
```

