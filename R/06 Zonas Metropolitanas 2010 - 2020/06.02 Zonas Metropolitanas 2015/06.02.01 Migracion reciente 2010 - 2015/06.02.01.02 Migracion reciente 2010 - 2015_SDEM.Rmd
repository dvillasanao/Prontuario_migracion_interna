---
title: "Zonas Metropolitanas 2015"
subtitle: 'Migraci칩n reciente 2010 - 2015'
author: "Indicadores sociodemogr치ficos"
output:
   html_document:
      highlight: tango
      theme: flatly
      toc: yes
      toc_depth: 2
      toc_float:
        collapsed: yes
---

\usepackage{color}

```{=html}
<style>
code.r{
  font-size: 10px;
}
pre {
  font-size: 12px
}
</style>

<style>
body {
text-align: justify;
font-style: normal;
font-family: "Montserrat";
font-size: 12px
}
h1.title {
  font-size: 40px;
  color: #000D3B;
}
h1 {
  color: #B6854D;
}
h2 {
  color: #172984;
}
h3 {
  color: #172984;
}
</style>
```

```{=html}
<style>
.nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #0A2687;
}
.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
    color: #ffffff;
    background-color: #09C2BC;
}
</style>
```

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE, cache.lazy = FALSE, 
                         eval = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(digits = 2, encoding = "UTF8")
```   
 

```{r, echo=FALSE}
rm(list = ls())
```

```{r, echo=FALSE}
setwd(here::here())
```


```{r, echo=FALSE}
#Font Stlye
require(showtext)
library(extrafont)
# activar showtext
# SE cargan las funtes del sitema Windows (Pero tarda en correr)
#ttf_import('C:/Users/dvill/AppData/Local/Microsoft/Windows/Fonts/')
#fonts()
#extrafont::loadfonts(device = "win")
#font_import()
windowsFonts()
```


```{r, echo = FALSE}
# Librer칤as que se usaron en el documCVE_ENTo
require(chorddiag)
require(circlize)
require(Cairo)
require(haven)
require(Hmisc) # %nin%
require(dplyr)
require(survey)
require(srvyr)
require(stringr)
require(sna)
require(expss)
require(knitr)
require(kableExtra)
require(sjlabelled)
require(gt)
require(ggplot2)
require(ggpubr)
require(ggalluvial)
require(ggsankey)
require(ggrepel)
require(janitor)
require(tibble)
require(tidyr)
require(reshape2)
require(rlang)
require(openxlsx)
require(doMC)
registerDoMC(cores = 18)
```

**Encuesta Intercensal 2015**

La Encuesta Intercensal se guarda en un un archivo `.RData`. 

```{r, eval = FALSE}
data <- read_sav("~/Persona.-Encuesta Intercensal 2015.sav")
#data <- data %>%
 #        select(., c(1:96)) %>%
  #        select(-"filter_$")
save(data, 
      file = paste0(here::here(), "/Bases/Encuesta Intercensal_2015.RData"))
```

九덢잺A partir de aqu칤 se pueden correr los c칩didos 游녢.
Se carga el archivo `Migracion por Zonas Metropolitanas_2015.RData`.   

```{r}
load(file = paste0(here::here(), "/Bases/06_Migracion por Zonas Metropolitanas_2015.RData"))
```

**Zonas Metropolitanas 2015**

Se anexa la base de datos de las Zonas Metropolitanas 2015 a la base orginal

```{r}
# Se vuelve a cargar la base de datos para fines practicos
ZM_2015 <- read.xlsx(paste0(here::here(), "/Bases/Municipio/ZM_2015.xlsx"), sheet = "ZM_2015") %>%
            mutate(CVE_ENT = stringr::str_pad(.$CVE_ENT, width = 3, side = c("left"), pad = "0"),
                   CVE_MUN = stringr::str_pad(.$CVE_MUN, width = 6, side = c("left"), pad = "0"))
```


**Entidades y Municipios**

Se genera un vector con el nombre de las entidades llamado `estados` para facilitar los filtros en el documento.     
Se genera un vector con las abreviaturas de las entidades llamado `ent` para fines pr치cticos.     
Se genera un vector con las claves de los municipios, pero es importante hacer notar que tres municipios no entraron el muestreo del Cuestionario Ampliado.   

```{r}
# Claves de los municipios
estados <- sjlabelled::get_labels(mydata$CVE_ENT)
nom_estados <- c( "Aguascalientes", "Baja California" ,"Baja California Sur", "Campeche", "Coahuila de Zaragoza", "Colima", 
                  "Chiapas", "Chihuahua", "Ciudad de M칠xico", "Durango", "Guanajuato", "Guerrero", "Hidalgo", "Jalisco",        
                  "M칠xico", "Michoac치n de Ocampo", "Morelos", "Nayarit", "Nuevo Le칩n", "Oaxaca", "Puebla", "Quer칠taro", 
                  "Quintana Roo", "San Luis Potos칤", "Sinaloa", "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala", 
                  "Veracruz de Ignacio de la Llave", "Yucat치n", "Zacatecas")
est <- c("AGS", "BC", "BCS", "CAMP", "COAH", "COL", "CHIS", "CHIH", "CDMX", "DGO", "GTO", "GRO", "HGO",
         "JAL", "MEX", "MICH", "MOR", "NAY", "NL", "OAX", "PUE", "QRO", "QROO", "SLP","SIN","SON", "TAB", 
         "TAMS", "TLX", "VER", "YUC", "ZAC")

# Claves de los estados
ENT <- readRDS(file = paste0(here::here(), "/Bases/estados.RDS"))

# Claves de los municipios
MUN <- readRDS(paste0(here::here(), "/Bases/municipios_2015.RDS"))
nom_municipios <- sjlabelled::get_labels(MUN$NOM_MUN) %>% as.factor()
municipios <- sjlabelled::get_labels(MUN$CVE_MUN) %>% as.factor()
#saveRDS(MUN, file = paste0(here::here(), "/Bases/municipios_2015.RDS"))

# Claves de las zonas metropolitanas
zm <- sjlabelled::get_labels(mydata$CVE_ZM)[-2]
nom_zm <- sjlabelled::get_labels(mydata$NOM_ZM)[-2]
```


**Se reclasifican algunas variables**

```{r}
data <- mydata %>%
         mutate(PE = case_when(.$CONACT %in% c("10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20") & (.$EDAD >= 12 & .$EDAD <= 130) ~ 1,
                               .$CONACT %in% c("31", "32", "33", "34", "35") & (.$EDAD >= 12 & .$EDAD <= 130) ~ 2,
                               .$CONACT %in% c("99") & (.$EDAD >= 12 & .$EDAD <= 130) ~ 99)) %>%
         mutate(PE = labelled(x = .$PE, 
                                  labels = c(`Poblaci칩n economicamente activa` = 1,
                                             `Poblaci칩n no economicamente activa` = 2,
                                             `No especificado` = 99))) %>%
         mutate(GEDAD = case_when(.$EDAD >= 5 & .$EDAD <= 14 ~ 1,
                                  .$EDAD >= 15 & .$EDAD <= 29 ~ 2,
                                  .$EDAD >= 30 & .$EDAD <= 59 ~ 3,
                                  .$EDAD >= 60 & .$EDAD <= 130 ~ 4)) %>%
        mutate(GEDAD = labelled(x = .$GEDAD, 
                                labels = c(`5 a 14 a침os` = 1,
                                           `15 a 29 a침os` = 2,
                                           `30 a 59 a침os` = 3, 
                                           `60 a침os y m치s` = 4)))  %>%
        # Se genera una indicadora de zm 
        mutate(I_ZM_2015 = ifelse(is.na(.$CVE_ZM), '0', '1'),
               I_RES5A_ZM_2015 = ifelse(is.na(.$CVE_ZM_RES), '0', '1')) %>%
        # Se clasifican a los migrantes internos 
        mutate(I_ZM = case_when(.$CVE_MUN == .$CVE_MUN_RES ~ 'Pertenecen a la Zona Metropolitana', #Residentes
                                .$CVE_MUN != .$CVE_MUN_RES & .$I_ZM_2015 %in% '1' & .$I_RES5A_ZM_2015 %in% '1' & .$CVE_ZM == .$CVE_ZM_RES ~ "Pertenecen a la Zona Metropolitana", #Migrantes que residen en la misma zona metropolitana
                                .$CVE_MUN != .$CVE_MUN_RES & .$I_ZM_2015 %in% '1' & .$I_RES5A_ZM_2015 %in% '1' & .$CVE_ZM != .$CVE_ZM_RES ~ 'No pertenecen a la Zona Metropolitana', #Migrantes que residen en otra zona metropolitana
                                .$CVE_MUN != .$CVE_MUN_RES & .$I_ZM_2015 %in% '1' & .$I_RES5A_ZM_2015 %in% '0' ~ 'No pertenecen a la Zona Metropolitana', #Migrantes que residian fuera de la zona metropolitana
                                .$CVE_MUN != .$CVE_MUN_RES & .$I_ZM_2015 %in% '0' & .$I_RES5A_ZM_2015 %in% '1' ~ 'No pertenecen a la Zona Metropolitana', #Migrantes que residian dentro de una zona metropolitana
                                .$CVE_MUN != .$CVE_MUN_RES & .$I_ZM_2015 %in% '0' & .$I_RES5A_ZM_2015 %in% '0' ~ 'No pertenecen a la Zona Metropolitana' #Migrantes que no residen en la zona metropolitana
        ))
```

# Nivel metropolitano {.tabset .tabset-pills}   
 
## Indicadores sociodemogr치ficos {.tabset .tabset-pills}   

### Valores absolutos   

```{r}
Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores <- function(Variable){
               # Zonas metropolitanas
                 ZM <- ZM_2015 %>%
                        select(CVE_ZM, CVE_MUN, NOM_MUN) %>%
                         pull(CVE_MUN)
                 
                # Municipios
                municipios <- MUN %>% pull(CVE_MUN)
                
                # Estados 
                estados <- ENT %>% pull(CVE_ENT)

                # Variable que se dese analizar
                X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                      unlist()
                # Etiquetas para las columnnas
                etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                              unlist()

                # Poblaci칩n total
                Pob.Total <- data %>%
                              as.data.frame() %>%
                               filter(CVE_MUN %in% municipios) %>%
                                group_by(CVE_ZM) %>%
                                 summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                  ungroup() %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
                #Poblaci칩n desagregada
                 # Filtro de la poblaci칩n desagregada
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]   
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset(EDAD >= 5 & EDAD <= 130) %>%
                                      filter(CVE_MUN %in% municipios) %>%
                                       filter(CVE_MUN_RES %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ZM) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ZM", paste0("Pob_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Pob.Objetivo <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 

                # Poblaci칩n residente 
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]     
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset(EDAD >= 5 & EDAD <= 130) %>%
                                      filter(CVE_MUN == CVE_MUN_RES) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ZM) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ZM", paste0("Residentes_", etiquetas[x])))
                  }, simplify = FALSE
                )

                Residentes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
                # Poblaci칩n Inmigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset(EDAD >= 5 & EDAD <= 130) %>%
                                      filter(CVE_MUN != CVE_MUN_RES) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_RES %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ZM) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ZM", paste0("Inmigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Inmigrantes <- left_join(ZM_2015 %>% distinct(CVE_ZM),  
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
               
                # Poblaci칩n Emigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset(EDAD >= 5 & EDAD <= 130) %>%
                                      filter(CVE_MUN != CVE_MUN_RES) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_RES %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ZM_RES) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ZM", paste0("Emigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Emigrantes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
               # Tabla de resultados
                Resultados <- Pob.Total %>%
                               full_join(., Pob.Objetivo, by = c("CVE_ZM")) %>%
                               full_join(., Residentes, by = c("CVE_ZM")) %>%
                               full_join(., Inmigrantes, by = c("CVE_ZM")) %>%
                               full_join(., Emigrantes, by = c("CVE_ZM")) 
                return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
writeData(wb, 1, Indicadores("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores("PE"), colNames = TRUE)
writeData(wb, 5, Indicadores("AFRODES"), colNames = TRUE)
writeData(wb, 6, Indicadores("HLENGUA"), colNames = TRUE)
writeData(wb, 7, Indicadores("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 8, Indicadores("ALFABET"), colNames = TRUE)
writeData(wb, 9, Indicadores("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 10, Indicadores("NIVACAD"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),  "/Output/Municipio/06_Zonas Metropolitanas/2015/01_Migracion reciente/SDEM/Indicadores sociodemograficos a nivel metropolitano 2015.xlsx"), overwrite = TRUE)
```


### Valores relativos  

```{r}
Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores_P <- function(Variable){
                   # Zonas metropolitanas
                     ZM <- ZM_2015 %>%
                            select(CVE_ZM, CVE_MUN, NOM_MUN) %>%
                             pull(CVE_MUN)
                     
                    # Municipios
                    municipios <- MUN %>% pull(CVE_MUN)
                    
                    # Estados 
                    estados <- ENT %>% pull(CVE_ENT)
    
                    # Variable que se dese analizar
                    X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                          unlist()
                    # Etiquetas para las columnnas
                    etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                                  unlist()
    
                    # Poblaci칩n total
                    Pob.Total <- data %>%
                                  as.data.frame() %>%
                                   filter(CVE_MUN %in% municipios) %>%
                                    group_by(CVE_ZM) %>%
                                     summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                      ungroup() %>%
                                       adorn_totals(c("row"), 
                                                    fill = "-", 
                                                     na.rm = TRUE) 
                    
                    #Poblaci칩n desagregada
                     # Filtro de la poblaci칩n desagregada
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]   
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset(EDAD >= 5 & EDAD <= 130) %>%
                                          filter(CVE_MUN %in% municipios) %>%
                                           filter(CVE_MUN_RES %in% municipios) %>%
                                            filter(get(Variable) %in% Var) %>%
                                             group_by(CVE_ZM) %>%
                                              summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                               set_names(c("CVE_ZM", paste0("Pob_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Pob.Objetivo <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                              purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                  na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
    
                    # Poblaci칩n residente 
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]     
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset(EDAD >= 5 & EDAD <= 130) %>%
                                          filter(CVE_MUN == CVE_MUN_RES) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(get(Variable) %in% Var) %>%
                                             group_by(CVE_ZM) %>%
                                              summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                               set_names(c("CVE_ZM", paste0("Residentes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
    
                    Residentes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                            purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                na.rm = TRUE) %>%
                                    adorn_percentages(denominator = "row") 
                    
                    # Poblaci칩n Inmigrante
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]      
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset(EDAD >= 5 & EDAD <= 130) %>%
                                          filter(CVE_MUN != CVE_MUN_RES) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(CVE_MUN_RES %in% municipios) %>%
                                             filter(get(Variable) %in% Var) %>%
                                              group_by(CVE_ZM) %>%
                                               summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                                set_names(c("CVE_ZM", paste0("Inmigrantes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Inmigrantes <- left_join(ZM_2015 %>% distinct(CVE_ZM),  
                                              purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                    adorn_totals(c("row"), 
                                                 fill = "-", 
                                                 na.rm = TRUE) %>%
                                     adorn_percentages(denominator = "row")  
                   
                    # Poblaci칩n Emigrante
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]      
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset(EDAD >= 5 & EDAD <= 130) %>%
                                          filter(CVE_MUN != CVE_MUN_RES) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(CVE_MUN_RES %in% municipios) %>%
                                             filter(get(Variable) %in% Var) %>%
                                              group_by(CVE_ZM_RES) %>%
                                               summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                                set_names(c("CVE_ZM", paste0("Emigrantes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Emigrantes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                              purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                na.rm = TRUE) %>%
                                    adorn_percentages(denominator = "row") 
                    
                   # Tabla de resultados
                    Resultados <- Pob.Total %>%
                                   full_join(., Pob.Objetivo, by = c("CVE_ZM")) %>%
                                   full_join(., Residentes, by = c("CVE_ZM")) %>%
                                   full_join(., Inmigrantes, by = c("CVE_ZM")) %>%
                                   full_join(., Emigrantes, by = c("CVE_ZM")) 
                    return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
writeData(wb, 1, Indicadores_P("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores_P("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores_P("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores_P("PE"), colNames = TRUE)
writeData(wb, 5, Indicadores_P("AFRODES"), colNames = TRUE)
writeData(wb, 6, Indicadores_P("HLENGUA"), colNames = TRUE)
writeData(wb, 7, Indicadores_P("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 8, Indicadores_P("ALFABET"), colNames = TRUE)
writeData(wb, 9, Indicadores_P("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 10, Indicadores_P("NIVACAD"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(), "/Output/Municipio/06_Zonas Metropolitanas/2015/01_Migracion reciente/SDEM/Indicadores sociodemograficos a nivel metropolitano 2015_Porcentajes.xlsx"), overwrite = TRUE)
```


# Nivel intrametropolitano {.tabset .tabset-pills}   
 
## Indicadores sociodemogr치ficos {.tabset .tabset-pills}   

### Valores absolutos   

```{r}
Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores <- function(Variable){
               # Filtro de la base de datos
               data <- data %>%
                        filter(.$I_ZM %in% "Pertenecen a la Zona Metropolitana") 
               
               # Zonas metropolitanas
                 ZM <- ZM_2015 %>%
                        select(CVE_ZM, CVE_MUN, NOM_MUN) %>%
                         pull(CVE_MUN)
                 
                # Municipios
                municipios <- MUN %>% pull(CVE_MUN)
                
                # Estados 
                estados <- ENT %>% pull(CVE_ENT)

                # Variable que se dese analizar
                X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                      unlist()
                # Etiquetas para las columnnas
                etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                              unlist()

                # Poblaci칩n total
                Pob.Total <- data %>%
                              as.data.frame() %>%
                               filter(CVE_MUN %in% municipios) %>%
                                group_by(CVE_ZM) %>%
                                 summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                  ungroup() %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
                #Poblaci칩n desagregada
                 # Filtro de la poblaci칩n desagregada
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]   
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset(EDAD >= 5 & EDAD <= 130) %>%
                                      filter(CVE_MUN %in% municipios) %>%
                                       filter(CVE_MUN_RES %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ZM) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ZM", paste0("Pob_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Pob.Objetivo <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                           purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                 adorn_totals(c("row"), 
                                              fill = "-", 
                                              na.rm = TRUE) 

                # Poblaci칩n residente 
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]     
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset(EDAD >= 5 & EDAD <= 130) %>%
                                      filter(CVE_MUN == CVE_MUN_RES) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ZM) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ZM", paste0("Residentes_", etiquetas[x])))
                  }, simplify = FALSE
                )

                Residentes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                               adorn_totals(c("row"), 
                                            fill = "-", 
                                            na.rm = TRUE)  
                
                # Poblaci칩n Inmigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset(EDAD >= 5 & EDAD <= 130) %>%
                                      filter(CVE_MUN != CVE_MUN_RES) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_RES %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ZM) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ZM", paste0("Inmigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Inmigrantes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                adorn_totals(c("row"), 
                                             fill = "-", 
                                             na.rm = TRUE)  
               
                # Poblaci칩n Emigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset(EDAD >= 5 & EDAD <= 130) %>%
                                      filter(CVE_MUN != CVE_MUN_RES) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_RES %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ZM_RES) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ZM", paste0("Emigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Emigrantes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                               adorn_totals(c("row"), 
                                            fill = "-", 
                                            na.rm = TRUE) 
                
               # Tabla de resultados
                Resultados <- Pob.Total %>%
                               full_join(., Pob.Objetivo, by = c("CVE_ZM")) %>%
                               full_join(., Residentes, by = c("CVE_ZM")) %>%
                               full_join(., Inmigrantes, by = c("CVE_ZM")) %>%
                               full_join(., Emigrantes, by = c("CVE_ZM")) 
                return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
writeData(wb, 1, Indicadores("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores("PE"), colNames = TRUE)
writeData(wb, 5, Indicadores("AFRODES"), colNames = TRUE)
writeData(wb, 6, Indicadores("HLENGUA"), colNames = TRUE)
writeData(wb, 7, Indicadores("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 8, Indicadores("ALFABET"), colNames = TRUE)
writeData(wb, 9, Indicadores("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 10, Indicadores("NIVACAD"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),  "/Output/Municipio/06_Zonas Metropolitanas/2015/01_Migracion reciente/SDEM/Indicadores sociodemograficos a nivel intrametropolitano 2015.xlsx"), overwrite = TRUE)
```


### Valores relativos  

```{r}
Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores_P <- function(Variable){
                   # Filtro de la base de datos
                   data <- data %>%
                            filter(.$I_ZM %in% "Pertenecen a la Zona Metropolitana") 
                   
                   # Zonas metropolitanas
                     ZM <- ZM_2015 %>%
                            select(CVE_ZM, CVE_MUN, NOM_MUN) %>%
                             pull(CVE_MUN)
                     
                    # Municipios
                    municipios <- MUN %>% pull(CVE_MUN)
                    
                    # Estados 
                    estados <- ENT %>% pull(CVE_ENT)
    
                    # Variable que se dese analizar
                    X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                          unlist()
                    # Etiquetas para las columnnas
                    etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                                  unlist()
    
                    # Poblaci칩n total
                    Pob.Total <- data %>%
                                  as.data.frame() %>%
                                   filter(CVE_MUN %in% municipios) %>%
                                    group_by(CVE_ZM) %>%
                                     summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                      ungroup() %>%
                                       adorn_totals(c("row"), 
                                                    fill = "-", 
                                                     na.rm = TRUE) %>%
                                        adorn_percentages(denominator = "row") 
                    
                    #Poblaci칩n desagregada
                     # Filtro de la poblaci칩n desagregada
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]   
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset(EDAD >= 5 & EDAD <= 130) %>%
                                          filter(CVE_MUN %in% municipios) %>%
                                           filter(CVE_MUN_RES %in% municipios) %>%
                                            filter(get(Variable) %in% Var) %>%
                                             group_by(CVE_ZM) %>%
                                              summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                               set_names(c("CVE_ZM", paste0("Pob_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Pob.Objetivo <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                               purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                  na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
    
                    # Poblaci칩n residente 
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]     
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset(EDAD >= 5 & EDAD <= 130) %>%
                                          filter(CVE_MUN == CVE_MUN_RES) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(get(Variable) %in% Var) %>%
                                             group_by(CVE_ZM) %>%
                                              summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                               set_names(c("CVE_ZM", paste0("Residentes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
    
                    Residentes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                             purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                na.rm = TRUE) %>%
                                    adorn_percentages(denominator = "row")  
                    
                    # Poblaci칩n Inmigrante
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]      
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset(EDAD >= 5 & EDAD <= 130) %>%
                                          filter(CVE_MUN != CVE_MUN_RES) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(CVE_MUN_RES %in% municipios) %>%
                                             filter(get(Variable) %in% Var) %>%
                                              group_by(CVE_ZM) %>%
                                               summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                                set_names(c("CVE_ZM", paste0("Inmigrantes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Inmigrantes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                             purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                    adorn_totals(c("row"), 
                                                 fill = "-", 
                                                 na.rm = TRUE) %>%
                                     adorn_percentages(denominator = "row") 
                   
                    # Poblaci칩n Emigrante
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]      
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset(EDAD >= 5 & EDAD <= 130) %>%
                                          filter(CVE_MUN != CVE_MUN_RES) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(CVE_MUN_RES %in% municipios) %>%
                                             filter(get(Variable) %in% Var) %>%
                                              group_by(CVE_ZM_RES) %>%
                                               summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                                set_names(c("CVE_ZM", paste0("Emigrantes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Emigrantes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                             purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                na.rm = TRUE)  %>%
                                    adorn_percentages(denominator = "row") 
                    
                   # Tabla de resultados
                    Resultados <- Pob.Total %>%
                                   full_join(., Pob.Objetivo, by = c("CVE_ZM")) %>%
                                   full_join(., Residentes, by = c("CVE_ZM")) %>%
                                   full_join(., Inmigrantes, by = c("CVE_ZM")) %>%
                                   full_join(., Emigrantes, by = c("CVE_ZM")) 
                    return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
writeData(wb, 1, Indicadores_P("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores_P("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores_P("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores_P("PE"), colNames = TRUE)
writeData(wb, 5, Indicadores_P("AFRODES"), colNames = TRUE)
writeData(wb, 6, Indicadores_P("HLENGUA"), colNames = TRUE)
writeData(wb, 7, Indicadores_P("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 8, Indicadores_P("ALFABET"), colNames = TRUE)
writeData(wb, 9, Indicadores_P("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 10, Indicadores_P("NIVACAD"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(), "/Output/Municipio/06_Zonas Metropolitanas/2015/01_Migracion reciente/SDEM/Indicadores sociodemograficos a nivel intrametropolitano 2015_Porcentajes.xlsx"), overwrite = TRUE)
```


# Nivel intermetropolitano {.tabset .tabset-pills}   
 
## Indicadores sociodemogr치ficos {.tabset .tabset-pills}   

### Valores absolutos   

```{r}
Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores <- function(Variable){
               # Filtro de la base de datos
               data <- data %>%
                        filter(.$I_ZM %in% "No pertenecen a la Zona Metropolitana") 
               
               # Zonas metropolitanas
                 ZM <- ZM_2015 %>%
                        select(CVE_ZM, CVE_MUN, NOM_MUN) %>%
                         pull(CVE_MUN)
                 
                # Municipios
                municipios <- MUN %>% pull(CVE_MUN)
                
                # Estados 
                estados <- ENT %>% pull(CVE_ENT)

                # Variable que se dese analizar
                X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                      unlist()
                # Etiquetas para las columnnas
                etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                              unlist()

                # Poblaci칩n total
                Pob.Total <- data %>%
                              as.data.frame() %>%
                               filter(CVE_MUN %in% municipios) %>%
                                group_by(CVE_ZM) %>%
                                 summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                  ungroup() %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
                #Poblaci칩n desagregada
                 # Filtro de la poblaci칩n desagregada
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]   
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset(EDAD >= 5 & EDAD <= 130) %>%
                                      filter(CVE_MUN %in% municipios) %>%
                                       filter(CVE_MUN_RES %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ZM) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ZM", paste0("Pob_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Pob.Objetivo <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                           purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                 adorn_totals(c("row"), 
                                              fill = "-", 
                                              na.rm = TRUE) 

                # Poblaci칩n residente 
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]     
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset(EDAD >= 5 & EDAD <= 130) %>%
                                      filter(CVE_MUN == CVE_MUN_RES) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ZM) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ZM", paste0("Residentes_", etiquetas[x])))
                  }, simplify = FALSE
                )

                Residentes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                               adorn_totals(c("row"), 
                                            fill = "-", 
                                            na.rm = TRUE)  
                
                # Poblaci칩n Inmigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset(EDAD >= 5 & EDAD <= 130) %>%
                                      filter(CVE_MUN != CVE_MUN_RES) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_RES %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ZM) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ZM", paste0("Inmigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Inmigrantes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                adorn_totals(c("row"), 
                                             fill = "-", 
                                             na.rm = TRUE)  
               
                # Poblaci칩n Emigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset(EDAD >= 5 & EDAD <= 130) %>%
                                      filter(CVE_MUN != CVE_MUN_RES) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_RES %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ZM_RES) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ZM", paste0("Emigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Emigrantes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                               adorn_totals(c("row"), 
                                            fill = "-", 
                                            na.rm = TRUE) 
                
               # Tabla de resultados
                Resultados <- Pob.Total %>%
                               full_join(., Pob.Objetivo, by = c("CVE_ZM")) %>%
                               full_join(., Residentes, by = c("CVE_ZM")) %>%
                               full_join(., Inmigrantes, by = c("CVE_ZM")) %>%
                               full_join(., Emigrantes, by = c("CVE_ZM")) 
                return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
writeData(wb, 1, Indicadores("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores("PE"), colNames = TRUE)
writeData(wb, 5, Indicadores("AFRODES"), colNames = TRUE)
writeData(wb, 6, Indicadores("HLENGUA"), colNames = TRUE)
writeData(wb, 7, Indicadores("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 8, Indicadores("ALFABET"), colNames = TRUE)
writeData(wb, 9, Indicadores("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 10, Indicadores("NIVACAD"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),  "/Output/Municipio/06_Zonas Metropolitanas/2015/01_Migracion reciente/SDEM/Indicadores sociodemograficos a nivel intermetropolitano 2015.xlsx"), overwrite = TRUE)
```


### Valores relativos  

```{r}
Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores_P <- function(Variable){
                   # Filtro de la base de datos
                   data <- data %>%
                            filter(.$I_ZM %in% "No pertenecen a la Zona Metropolitana") 
                   
                   # Zonas metropolitanas
                     ZM <- ZM_2015 %>%
                            select(CVE_ZM, CVE_MUN, NOM_MUN) %>%
                             pull(CVE_MUN)
                     
                    # Municipios
                    municipios <- MUN %>% pull(CVE_MUN)
                    
                    # Estados 
                    estados <- ENT %>% pull(CVE_ENT)
    
                    # Variable que se dese analizar
                    X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                          unlist()
                    # Etiquetas para las columnnas
                    etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                                  unlist()
    
                    # Poblaci칩n total
                    Pob.Total <- data %>%
                                  as.data.frame() %>%
                                   filter(CVE_MUN %in% municipios) %>%
                                    group_by(CVE_ZM) %>%
                                     summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                      ungroup() %>%
                                       adorn_totals(c("row"), 
                                                    fill = "-", 
                                                     na.rm = TRUE) %>%
                                        adorn_percentages(denominator = "row") 
                    
                    #Poblaci칩n desagregada
                     # Filtro de la poblaci칩n desagregada
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]   
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset(EDAD >= 5 & EDAD <= 130) %>%
                                          filter(CVE_MUN %in% municipios) %>%
                                           filter(CVE_MUN_RES %in% municipios) %>%
                                            filter(get(Variable) %in% Var) %>%
                                             group_by(CVE_ZM) %>%
                                              summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                               set_names(c("CVE_ZM", paste0("Pob_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Pob.Objetivo <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                               purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                  na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
    
                    # Poblaci칩n residente 
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]     
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset(EDAD >= 5 & EDAD <= 130) %>%
                                          filter(CVE_MUN == CVE_MUN_RES) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(get(Variable) %in% Var) %>%
                                             group_by(CVE_ZM) %>%
                                              summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                               set_names(c("CVE_ZM", paste0("Residentes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
    
                    Residentes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                             purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                na.rm = TRUE) %>%
                                    adorn_percentages(denominator = "row")  
                    
                    # Poblaci칩n Inmigrante
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]      
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset(EDAD >= 5 & EDAD <= 130) %>%
                                          filter(CVE_MUN != CVE_MUN_RES) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(CVE_MUN_RES %in% municipios) %>%
                                             filter(get(Variable) %in% Var) %>%
                                              group_by(CVE_ZM) %>%
                                               summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                                set_names(c("CVE_ZM", paste0("Inmigrantes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Inmigrantes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                             purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                    adorn_totals(c("row"), 
                                                 fill = "-", 
                                                 na.rm = TRUE) %>%
                                     adorn_percentages(denominator = "row") 
                   
                    # Poblaci칩n Emigrante
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]      
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset(EDAD >= 5 & EDAD <= 130) %>%
                                          filter(CVE_MUN != CVE_MUN_RES) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(CVE_MUN_RES %in% municipios) %>%
                                             filter(get(Variable) %in% Var) %>%
                                              group_by(CVE_ZM_RES) %>%
                                               summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                                set_names(c("CVE_ZM", paste0("Emigrantes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Emigrantes <- left_join(ZM_2015 %>% distinct(CVE_ZM), 
                                             purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                na.rm = TRUE)  %>%
                                    adorn_percentages(denominator = "row") 
                    
                   # Tabla de resultados
                    Resultados <- Pob.Total %>%
                                   full_join(., Pob.Objetivo, by = c("CVE_ZM")) %>%
                                   full_join(., Residentes, by = c("CVE_ZM")) %>%
                                   full_join(., Inmigrantes, by = c("CVE_ZM")) %>%
                                   full_join(., Emigrantes, by = c("CVE_ZM")) 
                    return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "CONACT")
addWorksheet(wb, "PE")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "SITUA_CONYUGAL")
addWorksheet(wb, "NIVACAD")
writeData(wb, 1, Indicadores_P("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores_P("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores_P("CONACT"), colNames = TRUE)
writeData(wb, 4, Indicadores_P("PE"), colNames = TRUE)
writeData(wb, 5, Indicadores_P("AFRODES"), colNames = TRUE)
writeData(wb, 6, Indicadores_P("HLENGUA"), colNames = TRUE)
writeData(wb, 7, Indicadores_P("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 8, Indicadores_P("ALFABET"), colNames = TRUE)
writeData(wb, 9, Indicadores_P("SITUA_CONYUGAL"), colNames = TRUE)
writeData(wb, 10, Indicadores_P("NIVACAD"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(), "/Output/Municipio/06_Zonas Metropolitanas/2015/01_Migracion reciente/SDEM/Indicadores sociodemograficos a nivel intermetropolitano 2015_Porcentajes.xlsx"), overwrite = TRUE)
```


