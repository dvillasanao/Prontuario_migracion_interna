\usepackage{color}

```{=html}
<style>
code.r{
  font-size: 10px;
}
pre {
  font-size: 12px
}
</style>

<style>
body {
text-align: justify;
font-style: normal;
font-family: "Montserrat";
font-size: 12px
}
h1.title {
  font-size: 40px;
  color: #000D3B;
}
h1 {
  color: #B6854D;
}
h2 {
  color: #172984;
}
h3 {
  color: #172984;
}
</style>
```

```{=html}
<style>
.nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #0A2687;
}
.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
    color: #ffffff;
    background-color: #09C2BC;
}
</style>
```

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE, cache.lazy = FALSE, 
                         eval = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(digits = 2, encoding = "UTF8")
```   
 

```{r, echo=FALSE}
rm(list = ls())
```

```{r, echo=FALSE}
setwd(here::here())
```

```{r, echo=FALSE}
#Font Stlye
require(showtext)
library(extrafont)
# activar showtext
# SE cargan las funtes del sitema Windows (Pero tarda en correr)
#ttf_import('C:/Users/dvill/AppData/Local/Microsoft/Windows/Fonts/')
#fonts()
#extrafont::loadfonts(device = "win")
#font_import()
windowsFonts()
```

```{r, echo = FALSE}
# Librerías que se usaron en el documCVE_ENTo
require(chorddiag)
require(circlize)
require(Cairo)
require(haven)
require(Hmisc) # %nin%
require(dplyr)
require(survey)
require(srvyr)
require(stringr)
require(sna)
require(expss)
require(knitr)
require(kableExtra)
require(sjlabelled)
require(gt)
require(ggplot2)
require(ggpubr)
require(ggalluvial)
require(ggsankey)
require(ggrepel)
require(janitor)
require(tibble)
require(tidyr)
require(reshape2)
require(openxlsx)
require(rlang)
require(doMC)
registerDoMC(cores = 18)
```


**Cuestionario Ampliado del Censo de Población y Vivienda 2020**

El cuestionario ampliado se guarda en un un archivo `.RData`. 

```{r, eval = FALSE}
data <- read_sav("~/Personas_Censo 2020.SAV")
save(data, 
      file = paste0(here::here(), "/Bases/Censo_Personas_2020.RData"))
```


Se seleccionan las variables que se desean conservar para la realización de este documento y se guarda en un archivo `.RData` para practicidad del manejo de datos.

La variable `mydata` contiene **15 015 683 observaciones** y **27 variables**.

**Posibles variables que se pueden contemplar en la movilidad estudiantil**

-   `SEXO`
-   `NIVACAD` ¿Cuál fue el último año o grado aprobado por (NOMBRE) en la escuela?\
-   `TIE_TRASLADO_ESCU`
-   `MED_TRASLADO_ESC1`
-   `MED_TRASLADO_ESC2`\
-   `MED_TRASLADO_ESC3`
-   `NOMCAR_C`

✔️A partir de aquí se pueden correr los códidos 👇.
Se carga el archivo `Movilidad estudiantil_2020.RData`.

```{r}
load(file = paste0(here::here(), "/Bases/06_Migracion por Zonas Metropolitanas_2020.RData"))

# Para fines prácticos se genera un ponderador de uno 
mydata <- mydata %>%
           mutate(M = 1)  %>%
            mutate(NOM_ENT = as.factor(.$CVE_ENT)) %>%
             ungroup()

# Se vuelve a cargar la base de datos para fines practicos
ZM_2020 <- read.xlsx(paste0(here::here(), "/Bases/Municipio/ZM_2020.xlsx"), 
                      startRow = 7, 
                       skipEmptyRows = TRUE) %>%
            mutate(CVE_ENT = stringr::str_pad(.$CVE_ENT, width = 3, side = c("left"), pad = "0"),
                   CVE_MUN = stringr::str_pad(.$CVE_MUN, width = 6, side = c("left"), pad = "0"))
```

**Entidades y Municipios**

Se genera un vector con el nombre de las entidades llamado `estados` para facilitar los filtros en el documento.     
Se genera un vector con las abreviaturas de las entidades llamado `ent` para fines prácticos.     
Se genera un vector con las claves de los municipios, pero es importante hacer notar que tres municipios no entraron el muestreo del Cuestionario Ampliado.   

```{r}
# Claves de los municipios
estados <- sjlabelled::get_labels(mydata$CVE_ENT)
nom_estados <- c( "Aguascalientes", "Baja California" ,"Baja California Sur", "Campeche", "Coahuila de Zaragoza", "Colima", 
                  "Chiapas", "Chihuahua", "Ciudad de México", "Durango", "Guanajuato", "Guerrero", "Hidalgo", "Jalisco",        
                  "México", "Michoacán de Ocampo", "Morelos", "Nayarit", "Nuevo León", "Oaxaca", "Puebla", "Querétaro", 
                  "Quintana Roo", "San Luis Potosí", "Sinaloa", "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala", 
                  "Veracruz de Ignacio de la Llave", "Yucatán", "Zacatecas")
est <- c("AGS", "BC", "BCS", "CAMP", "COAH", "COL", "CHIS", "CHIH", "CDMX", "DGO", "GTO", "GRO", "HGO",
         "JAL", "MEX", "MICH", "MOR", "NAY", "NL", "OAX", "PUE", "QRO", "QROO", "SLP","SIN","SON", "TAB", 
         "TAMS", "TLX", "VER", "YUC", "ZAC")

# Claves de los estados
ENT <- readRDS(file = paste0(here::here(), "/Bases/estados.RDS"))

# Claves de los municipios
MUN <- readRDS(paste0(here::here(), "/Bases/municipios_2020.RDS"))
nom_municipios <- sjlabelled::get_labels(MUN$NOM_MUN) %>% as.factor()
municipios <- sjlabelled::get_labels(MUN$CVE_MUN) %>% as.factor()
#saveRDS(MUN, file = paste0(here::here(), "/Bases/municipios_2020.RDS"))

# Claves de las zonas metropolitanas
zm <- sjlabelled::get_labels(mydata$CVE_ZM)[-2]
nom_zm <- sjlabelled::get_labels(mydata$NOM_ZM)[-2]
```


**Se reclasifican algunas variables**

```{r}
data <- mydata %>%
         mutate(ESCOACUM = stringr::str_pad(.$ESCOACUM, width = 2, side = c("left"), pad = "0")) %>%
         mutate(G_ESCOACUM = case_when(.$ESCOACUM %in% c("00", "01", "02", "03", "04") ~ 1,
                                       .$ESCOACUM %in% c("05", "06", "07", "08") ~ 2,
                                       .$ESCOACUM %in% c("09", "10", "11") ~ 3,
                                       .$ESCOACUM %in% c("12", "13","14","15","16", "17", "18","19", "20", "21", "22", "23", "24") ~ 4)) %>%
         mutate(G_ESCOACUM = labelled(x = .$G_ESCOACUM,
                                     labels = c(`0 a 4` = 1,
                                                `5 a 8` = 2,
                                                `9 a 11` = 3,
                                                `12 y más` = 4))) %>%
         mutate(ESCOACUM = as.double(.$ESCOACUM)) %>%
         mutate(ESCOACUM = labelled(x = .$ESCOACUM,
                                     labels = c(`00` = 0, 
                                                `01` = 1,
                                                `02` = 2,
                                                `03` = 3,
                                                `04` = 4,
                                                `05` = 5,
                                                `06` = 6,
                                                `07` = 7,
                                                `08` = 8,
                                                `09` = 9,
                                                `10` = 10,
                                                `11` = 11,
                                                `12` = 12,
                                                `13` = 13,
                                                `14` = 14,
                                                `15` = 15,
                                                `16` = 16,
                                                `17` = 17,
                                                `18` = 18,
                                                `19` = 19,
                                                `20` = 20,
                                                `21` = 21,
                                                `22` = 22,
                                                `23` = 23,
                                                `24` = 24,
                                                `99` = 99))) %>%
         mutate(GEDAD = case_when(.$EDAD >= 5 & .$EDAD <= 14 ~ 1,
                                  .$EDAD >= 15 & .$EDAD <= 29 ~ 2,
                                  .$EDAD >= 30 & .$EDAD <= 59 ~ 3,
                                  .$EDAD >= 60 & .$EDAD <= 130 ~ 4)) %>%
          mutate(GEDAD = labelled(x = .$GEDAD, 
                                  labels = c(`5 a 14 años` = 1,
                                             `15 a 29 años` = 2,
                                             `30 a 59 años` = 3, 
                                             `60 años y más` = 4)))  %>%
          # Se genera una indicadora de zm 
        mutate(I_ZM_2020 = ifelse(is.na(.$CVE_ZM), '0', '1'),
               I_ASI_ZM_2020 = ifelse(is.na(.$CVE_ZM_ASI), '0', '1')) %>%
        # Se clasifican a los migrantes internos 
        mutate(I_ZM = case_when(.$CVE_MUN == .$CVE_MUN_ASI ~ 'Pertenecen a la Zona Metropolitana', #Estudian en el mismo municipio
                                .$CVE_MUN != .$CVE_MUN_ASI & .$I_ZM_2020 %in% '1' & .$I_ASI_ZM_2020 %in% '1' & .$CVE_ZM == .$CVE_ZM_ASI ~ "Pertenecen a la Zona Metropolitana", #Estudian en otro municipio dentro de la misma zona metropolitana
                                .$CVE_MUN != .$CVE_MUN_ASI & .$I_ZM_2020 %in% '1' & .$I_ASI_ZM_2020 %in% '1' & .$CVE_ZM != .$CVE_ZM_ASI ~ 'No pertenecen a la Zona Metropolitana', #Estudian en otro municipio pero de otra zona metropolitana
                                .$CVE_MUN != .$CVE_MUN_ASI & .$I_ZM_2020 %in% '1' & .$I_ASI_ZM_2020 %in% '0' ~ 'No pertenecen a la Zona Metropolitana', #Estudian en otro municipio que no pertenece a la zona metropolitana pero viven en una ZM
                                .$CVE_MUN != .$CVE_MUN_ASI & .$I_ZM_2020 %in% '0' & .$I_ASI_ZM_2020 %in% '1' ~ 'No pertenecen a la Zona Metropolitana', #Entran a trabajar a la zona metropolitana pero no pertecen a la ZM
                                .$CVE_MUN != .$CVE_MUN_ASI & .$I_ZM_2020 %in% '0' & .$I_ASI_ZM_2020 %in% '0' ~ 'No pertenecen a la Zona Metropolitana' #Estudian en otro municipio que no es ZM y no residen en una ZM
                                ))
```


# Nivel metropolitano {.tabset .tabset-pills}   
 
## Indicadores sociodemográficos {.tabset .tabset-pills}   

### Valores absolutos   

```{r}
Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores <- function(Variable){
               # Zonas metropolitanas
                 ZM <- ZM_2020 %>%
                        select(CVE_ZM, CVE_MUN, NOM_MUN) %>%
                         pull(CVE_MUN)
                 
                # Municipios
                municipios <- MUN %>% pull(CVE_MUN)
                
                # Estados 
                estados <- ENT %>% pull(CVE_ENT)

                # Variable que se dese analizar
                X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                      unlist()
                # Etiquetas para las columnnas
                etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                              unlist()

                # Población total
                Pob.Total <- data %>%
                              as.data.frame() %>%
                               filter(CVE_MUN %in% municipios) %>%
                                group_by(CVE_ZM) %>%
                                 summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                  ungroup() %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
                #Población desagregada
                 # Filtro de la población desagregada
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]   
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 3 & EDAD <= 130)) %>%
                                      filter(CVE_MUN %in% municipios) %>%
                                       filter(CVE_MUN_ASI %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ZM) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ZM", paste0("Pob_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Pob.Objetivo <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 

                # Población residente 
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]     
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 3 & EDAD <= 130)) %>%
                                      filter(CVE_MUN == CVE_MUN_ASI) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ZM) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ZM", paste0("Residentes_", etiquetas[x])))
                  }, simplify = FALSE
                )

                Residentes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
                # Población Inmigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 3 & EDAD <= 130)) %>%
                                      filter(CVE_MUN != CVE_MUN_ASI) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_ASI %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ZM) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ZM", paste0("Inmigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Inmigrantes <- left_join(ZM_2020 %>% distinct(CVE_ZM),  
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
               
                # Población Emigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 3 & EDAD <= 130)) %>%
                                      filter(CVE_MUN != CVE_MUN_ASI) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_ASI %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ZM_ASI) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ZM", paste0("Emigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Emigrantes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                          purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
               # Tabla de resultados
                Resultados <- Pob.Total %>%
                               full_join(., Pob.Objetivo, by = c("CVE_ZM")) %>%
                               full_join(., Residentes, by = c("CVE_ZM")) %>%
                               full_join(., Inmigrantes, by = c("CVE_ZM")) %>%
                               full_join(., Emigrantes, by = c("CVE_ZM")) 
                return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "TIE_TRASLADO_ESCU")
addWorksheet(wb, "MED_TRASLADO_ESC1")
addWorksheet(wb, "MED_TRASLADO_ESC2")
addWorksheet(wb, "MED_TRASLADO_ESC3")
writeData(wb, 1, Indicadores("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores("AFRODES"), colNames = TRUE)
writeData(wb, 4, Indicadores("HLENGUA"), colNames = TRUE)
writeData(wb, 5, Indicadores("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 6, Indicadores("ALFABET"), colNames = TRUE)
writeData(wb, 7, Indicadores("NIVACAD"), colNames = TRUE)
writeData(wb, 8, Indicadores("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 9, Indicadores("TIE_TRASLADO_ESCU"), colNames = TRUE)
writeData(wb, 10, Indicadores("MED_TRASLADO_ESC1"), colNames = TRUE)
writeData(wb, 11, Indicadores("MED_TRASLADO_ESC2"), colNames = TRUE)
writeData(wb, 12, Indicadores("MED_TRASLADO_ESC3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here:: here(),  "/Output/Municipio/06_Zonas Metropolitanas/2020/04_Movilidad estudiantil/SDEM/Indicadores sociodemograficos a nivel metropolitano 2020.xlsx"), overwrite = TRUE)
```


### Valores relativos  

```{r}
Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores_P <- function(Variable){
                   # Zonas metropolitanas
                     ZM <- ZM_2020 %>%
                            select(CVE_ZM, CVE_MUN, NOM_MUN) %>%
                             pull(CVE_MUN)
                     
                    # Municipios
                    municipios <- MUN %>% pull(CVE_MUN)
                    
                    # Estados 
                    estados <- ENT %>% pull(CVE_ENT)
    
                    # Variable que se dese analizar
                    X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                          unlist()
                    # Etiquetas para las columnnas
                    etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                                  unlist()
    
                    # Población total
                    Pob.Total <- data %>%
                                  as.data.frame() %>%
                                   filter(CVE_MUN %in% municipios) %>%
                                    group_by(CVE_ZM) %>%
                                     summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                      ungroup() %>%
                                       adorn_totals(c("row"), 
                                                    fill = "-", 
                                                     na.rm = TRUE) 
                    
                    #Población desagregada
                     # Filtro de la población desagregada
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]   
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 3 & EDAD <= 130)) %>%
                                          filter(CVE_MUN %in% municipios) %>%
                                           filter(CVE_MUN_ASI %in% municipios) %>%
                                            filter(get(Variable) %in% Var) %>%
                                             group_by(CVE_ZM) %>%
                                              summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                               set_names(c("CVE_ZM", paste0("Pob_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Pob.Objetivo <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                              purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                  na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
    
                    # Población residente 
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]     
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 3 & EDAD <= 130)) %>%
                                          filter(CVE_MUN == CVE_MUN_ASI) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(get(Variable) %in% Var) %>%
                                             group_by(CVE_ZM) %>%
                                              summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                               set_names(c("CVE_ZM", paste0("Residentes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
    
                    Residentes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                            purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                na.rm = TRUE) %>%
                                    adorn_percentages(denominator = "row") 
                    
                    # Población Inmigrante
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]      
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 3 & EDAD <= 130)) %>%
                                          filter(CVE_MUN != CVE_MUN_ASI) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(CVE_MUN_ASI %in% municipios) %>%
                                             filter(get(Variable) %in% Var) %>%
                                              group_by(CVE_ZM) %>%
                                               summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                                set_names(c("CVE_ZM", paste0("Inmigrantes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Inmigrantes <- left_join(ZM_2020 %>% distinct(CVE_ZM),  
                                              purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                    adorn_totals(c("row"), 
                                                 fill = "-", 
                                                 na.rm = TRUE) %>%
                                     adorn_percentages(denominator = "row")  
                   
                    # Población Emigrante
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]      
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 3 & EDAD <= 130)) %>%
                                          filter(CVE_MUN != CVE_MUN_ASI) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(CVE_MUN_ASI %in% municipios) %>%
                                             filter(get(Variable) %in% Var) %>%
                                              group_by(CVE_ZM_ASI) %>%
                                               summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                                set_names(c("CVE_ZM", paste0("Emigrantes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Emigrantes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                              purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                na.rm = TRUE) %>%
                                    adorn_percentages(denominator = "row") 
                    
                   # Tabla de resultados
                    Resultados <- Pob.Total %>%
                                   full_join(., Pob.Objetivo, by = c("CVE_ZM")) %>%
                                   full_join(., Residentes, by = c("CVE_ZM")) %>%
                                   full_join(., Inmigrantes, by = c("CVE_ZM")) %>%
                                   full_join(., Emigrantes, by = c("CVE_ZM")) 
                    return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "TIE_TRASLADO_ESCU")
addWorksheet(wb, "MED_TRASLADO_ESC1")
addWorksheet(wb, "MED_TRASLADO_ESC2")
addWorksheet(wb, "MED_TRASLADO_ESC3")
writeData(wb, 1, Indicadores_P("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores_P("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores_P("AFRODES"), colNames = TRUE)
writeData(wb, 4, Indicadores_P("HLENGUA"), colNames = TRUE)
writeData(wb, 5, Indicadores_P("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 6, Indicadores_P("ALFABET"), colNames = TRUE)
writeData(wb, 7, Indicadores_P("NIVACAD"), colNames = TRUE)
writeData(wb, 8, Indicadores_P("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 9, Indicadores_P("TIE_TRASLADO_ESCU"), colNames = TRUE)
writeData(wb, 10, Indicadores_P("MED_TRASLADO_ESC1"), colNames = TRUE)
writeData(wb, 11, Indicadores_P("MED_TRASLADO_ESC2"), colNames = TRUE)
writeData(wb, 12, Indicadores_P("MED_TRASLADO_ESC3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(), "/Output/Municipio/06_Zonas Metropolitanas/2020/04_Movilidad estudiantil/SDEM/Indicadores sociodemograficos a nivel metropolitano 2020_Porcentajes.xlsx"), overwrite = TRUE)
```
 

# Nivel intrametropolitano {.tabset .tabset-pills}   
 
## Indicadores sociodemográficos {.tabset .tabset-pills}   

### Valores absolutos   

```{r}
Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores <- function(Variable){
               # Filtro de la base de datos
               data <- data %>%
                        filter(.$I_ZM %in% "Pertenecen a la Zona Metropolitana") 
               
               # Zonas metropolitanas
                 ZM <- ZM_2020 %>%
                        select(CVE_ZM, CVE_MUN, NOM_MUN) %>%
                         pull(CVE_MUN)
                 
                # Municipios
                municipios <- MUN %>% pull(CVE_MUN)
                
                # Estados 
                estados <- ENT %>% pull(CVE_ENT)

                # Variable que se dese analizar
                X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                      unlist()
                # Etiquetas para las columnnas
                etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                              unlist()

                # Población total
                Pob.Total <- data %>%
                              as.data.frame() %>%
                               filter(CVE_MUN %in% municipios) %>%
                                group_by(CVE_ZM) %>%
                                 summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                  ungroup() %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
                #Población desagregada
                 # Filtro de la población desagregada
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]   
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 3 & EDAD <= 130)) %>%
                                      filter(CVE_MUN %in% municipios) %>%
                                       filter(CVE_MUN_ASI %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ZM) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ZM", paste0("Pob_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Pob.Objetivo <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                           purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                 adorn_totals(c("row"), 
                                              fill = "-", 
                                              na.rm = TRUE) 

                # Población residente 
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]     
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 3 & EDAD <= 130)) %>%
                                      filter(CVE_MUN == CVE_MUN_ASI) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ZM) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ZM", paste0("Residentes_", etiquetas[x])))
                  }, simplify = FALSE
                )

                Residentes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                               adorn_totals(c("row"), 
                                            fill = "-", 
                                            na.rm = TRUE)  
                
                # Población Inmigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 3 & EDAD <= 130)) %>%
                                      filter(CVE_MUN != CVE_MUN_ASI) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_ASI %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ZM) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ZM", paste0("Inmigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Inmigrantes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                adorn_totals(c("row"), 
                                             fill = "-", 
                                             na.rm = TRUE)  
               
                # Población Emigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 3 & EDAD <= 130)) %>%
                                      filter(CVE_MUN != CVE_MUN_ASI) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_ASI %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ZM_ASI) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ZM", paste0("Emigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Emigrantes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                               adorn_totals(c("row"), 
                                            fill = "-", 
                                            na.rm = TRUE) 
                
               # Tabla de resultados
                Resultados <- Pob.Total %>%
                               full_join(., Pob.Objetivo, by = c("CVE_ZM")) %>%
                               full_join(., Residentes, by = c("CVE_ZM")) %>%
                               full_join(., Inmigrantes, by = c("CVE_ZM")) %>%
                               full_join(., Emigrantes, by = c("CVE_ZM")) 
                return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "NOMCAR_C")
addWorksheet(wb, "TIE_TRASLADO_ESCU")
addWorksheet(wb, "MED_TRASLADO_ESC1")
addWorksheet(wb, "MED_TRASLADO_ESC2")
addWorksheet(wb, "MED_TRASLADO_ESC3")
writeData(wb, 1, Indicadores("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores("AFRODES"), colNames = TRUE)
writeData(wb, 4, Indicadores("HLENGUA"), colNames = TRUE)
writeData(wb, 5, Indicadores("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 6, Indicadores("ALFABET"), colNames = TRUE)
writeData(wb, 7, Indicadores("NIVACAD"), colNames = TRUE)
writeData(wb, 8, Indicadores("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 9, Indicadores("TIE_TRASLADO_ESCU"), colNames = TRUE)
writeData(wb, 10, Indicadores("MED_TRASLADO_ESC1"), colNames = TRUE)
writeData(wb, 11, Indicadores("MED_TRASLADO_ESC2"), colNames = TRUE)
writeData(wb, 12, Indicadores("MED_TRASLADO_ESC3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),  "/Output/Municipio/06_Zonas Metropolitanas/2020/04_Movilidad estudiantil/SDEM/Indicadores sociodemograficos a nivel intrametropolitano 2020.xlsx"), overwrite = TRUE)
```


### Valores relativos  

```{r}
Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores_P <- function(Variable){
                   # Filtro de la base de datos
                   data <- data %>%
                            filter(.$I_ZM %in% "Pertenecen a la Zona Metropolitana") 
                   
                   # Zonas metropolitanas
                     ZM <- ZM_2020 %>%
                            select(CVE_ZM, CVE_MUN, NOM_MUN) %>%
                             pull(CVE_MUN)
                     
                    # Municipios
                    municipios <- MUN %>% pull(CVE_MUN)
                    
                    # Estados 
                    estados <- ENT %>% pull(CVE_ENT)
    
                    # Variable que se dese analizar
                    X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                          unlist()
                    # Etiquetas para las columnnas
                    etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                                  unlist()
    
                    # Población total
                    Pob.Total <- data %>%
                                  as.data.frame() %>%
                                   filter(CVE_MUN %in% municipios) %>%
                                    group_by(CVE_ZM) %>%
                                     summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                      ungroup() %>%
                                       adorn_totals(c("row"), 
                                                    fill = "-", 
                                                     na.rm = TRUE) %>%
                                        adorn_percentages(denominator = "row") 
                    
                    #Población desagregada
                     # Filtro de la población desagregada
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]   
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 3 & EDAD <= 130)) %>%
                                          filter(CVE_MUN %in% municipios) %>%
                                           filter(CVE_MUN_ASI %in% municipios) %>%
                                            filter(get(Variable) %in% Var) %>%
                                             group_by(CVE_ZM) %>%
                                              summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                               set_names(c("CVE_ZM", paste0("Pob_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Pob.Objetivo <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                               purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                  na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
    
                    # Población residente 
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]     
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 3 & EDAD <= 130)) %>%
                                          filter(CVE_MUN == CVE_MUN_ASI) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(get(Variable) %in% Var) %>%
                                             group_by(CVE_ZM) %>%
                                              summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                               set_names(c("CVE_ZM", paste0("Residentes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
    
                    Residentes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                             purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                na.rm = TRUE) %>%
                                    adorn_percentages(denominator = "row")  
                    
                    # Población Inmigrante
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]      
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 3 & EDAD <= 130)) %>%
                                          filter(CVE_MUN != CVE_MUN_ASI) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(CVE_MUN_ASI %in% municipios) %>%
                                             filter(get(Variable) %in% Var) %>%
                                              group_by(CVE_ZM) %>%
                                               summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                                set_names(c("CVE_ZM", paste0("Inmigrantes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Inmigrantes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                             purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                    adorn_totals(c("row"), 
                                                 fill = "-", 
                                                 na.rm = TRUE) %>%
                                     adorn_percentages(denominator = "row") 
                   
                    # Población Emigrante
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]      
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 3 & EDAD <= 130)) %>%
                                          filter(CVE_MUN != CVE_MUN_ASI) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(CVE_MUN_ASI %in% municipios) %>%
                                             filter(get(Variable) %in% Var) %>%
                                              group_by(CVE_ZM_ASI) %>%
                                               summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                                set_names(c("CVE_ZM", paste0("Emigrantes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Emigrantes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                             purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                na.rm = TRUE)  %>%
                                    adorn_percentages(denominator = "row") 
                    
                   # Tabla de resultados
                    Resultados <- Pob.Total %>%
                                   full_join(., Pob.Objetivo, by = c("CVE_ZM")) %>%
                                   full_join(., Residentes, by = c("CVE_ZM")) %>%
                                   full_join(., Inmigrantes, by = c("CVE_ZM")) %>%
                                   full_join(., Emigrantes, by = c("CVE_ZM")) 
                    return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "TIE_TRASLADO_ESCU")
addWorksheet(wb, "MED_TRASLADO_ESC1")
addWorksheet(wb, "MED_TRASLADO_ESC2")
addWorksheet(wb, "MED_TRASLADO_ESC3")
writeData(wb, 1, Indicadores_P("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores_P("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores_P("AFRODES"), colNames = TRUE)
writeData(wb, 4, Indicadores_P("HLENGUA"), colNames = TRUE)
writeData(wb, 5, Indicadores_P("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 6, Indicadores_P("ALFABET"), colNames = TRUE)
writeData(wb, 7, Indicadores_P("NIVACAD"), colNames = TRUE)
writeData(wb, 8, Indicadores_P("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 9, Indicadores_P("TIE_TRASLADO_ESCU"), colNames = TRUE)
writeData(wb, 10, Indicadores_P("MED_TRASLADO_ESC1"), colNames = TRUE)
writeData(wb, 11, Indicadores_P("MED_TRASLADO_ESC2"), colNames = TRUE)
writeData(wb, 12, Indicadores_P("MED_TRASLADO_ESC3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(), "/Output/Municipio/06_Zonas Metropolitanas/2020/04_Movilidad estudiantil/SDEM/Indicadores sociodemograficos a nivel intrametropolitano 2020_Porcentajes.xlsx"), overwrite = TRUE)
```


# Nivel intermetropolitano {.tabset .tabset-pills}   
 
## Indicadores sociodemográficos {.tabset .tabset-pills}   

### Valores absolutos   

```{r}
Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores <- function(Variable){
               # Filtro de la base de datos
               data <- data %>%
                        filter(.$I_ZM %in% "No pertenecen a la Zona Metropolitana") 
               
               # Zonas metropolitanas
                 ZM <- ZM_2020 %>%
                        select(CVE_ZM, CVE_MUN, NOM_MUN) %>%
                         pull(CVE_MUN)
                 
                # Municipios
                municipios <- MUN %>% pull(CVE_MUN)
                
                # Estados 
                estados <- ENT %>% pull(CVE_ENT)

                # Variable que se dese analizar
                X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                      unlist()
                # Etiquetas para las columnnas
                etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                              unlist()

                # Población total
                Pob.Total <- data %>%
                              as.data.frame() %>%
                               filter(CVE_MUN %in% municipios) %>%
                                group_by(CVE_ZM) %>%
                                 summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                  ungroup() %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                 na.rm = TRUE) 
                
                #Población desagregada
                 # Filtro de la población desagregada
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]   
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 3 & EDAD <= 130)) %>%
                                      filter(CVE_MUN %in% municipios) %>%
                                       filter(CVE_MUN_ASI %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ZM) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ZM", paste0("Pob_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Pob.Objetivo <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                           purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                 adorn_totals(c("row"), 
                                              fill = "-", 
                                              na.rm = TRUE) 

                # Población residente 
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]     
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 3 & EDAD <= 130)) %>%
                                      filter(CVE_MUN == CVE_MUN_ASI) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(get(Variable) %in% Var) %>%
                                         group_by(CVE_ZM) %>%
                                          summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                           set_names(c("CVE_ZM", paste0("Residentes_", etiquetas[x])))
                  }, simplify = FALSE
                )

                Residentes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                               adorn_totals(c("row"), 
                                            fill = "-", 
                                            na.rm = TRUE)  
                
                # Población Inmigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 3 & EDAD <= 130)) %>%
                                      filter(CVE_MUN != CVE_MUN_ASI) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_ASI %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ZM) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ZM", paste0("Inmigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Inmigrantes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                adorn_totals(c("row"), 
                                             fill = "-", 
                                             na.rm = TRUE)  
               
                # Población Emigrante
                p <- sapply(1:length(X), function(x){
                                 Var <- X[x]      
                                  data %>%
                                   as.data.frame() %>%
                                    mutate(EDAD = as.numeric(.$EDAD)) %>%
                                     subset((EDAD >= 3 & EDAD <= 130)) %>%
                                      filter(CVE_MUN != CVE_MUN_ASI) %>%
                                       filter(CVE_MUN %in% municipios) %>%
                                        filter(CVE_MUN_ASI %in% municipios) %>%
                                         filter(get(Variable) %in% Var) %>%
                                          group_by(CVE_ZM_ASI) %>%
                                           summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                            set_names(c("CVE_ZM", paste0("Emigrantes_", etiquetas[x])))
                  }, simplify = FALSE
                )
                
                Emigrantes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                         purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                               adorn_totals(c("row"), 
                                            fill = "-", 
                                            na.rm = TRUE) 
                
               # Tabla de resultados
                Resultados <- Pob.Total %>%
                               full_join(., Pob.Objetivo, by = c("CVE_ZM")) %>%
                               full_join(., Residentes, by = c("CVE_ZM")) %>%
                               full_join(., Inmigrantes, by = c("CVE_ZM")) %>%
                               full_join(., Emigrantes, by = c("CVE_ZM")) 
                return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "TIE_TRASLADO_ESCU")
addWorksheet(wb, "MED_TRASLADO_ESC1")
addWorksheet(wb, "MED_TRASLADO_ESC2")
addWorksheet(wb, "MED_TRASLADO_ESC3")
writeData(wb, 1, Indicadores("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores("AFRODES"), colNames = TRUE)
writeData(wb, 4, Indicadores("HLENGUA"), colNames = TRUE)
writeData(wb, 5, Indicadores("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 6, Indicadores("ALFABET"), colNames = TRUE)
writeData(wb, 7, Indicadores("NIVACAD"), colNames = TRUE)
writeData(wb, 8, Indicadores("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 9, Indicadores("TIE_TRASLADO_ESCU"), colNames = TRUE)
writeData(wb, 10, Indicadores("MED_TRASLADO_ESC1"), colNames = TRUE)
writeData(wb, 11, Indicadores("MED_TRASLADO_ESC2"), colNames = TRUE)
writeData(wb, 12, Indicadores("MED_TRASLADO_ESC3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),  "/Output/Municipio/06_Zonas Metropolitanas/2020/04_Movilidad estudiantil/SDEM/Indicadores sociodemograficos a nivel intermetropolitano 2020.xlsx"), overwrite = TRUE)
```


### Valores relativos  

```{r}
Variable <- "SEXO"
#Variable <- "NIVACAD"
#Clave <- "20.01"
#Clave <- "30.01"

Indicadores_P <- function(Variable){
                   # Filtro de la base de datos
                   data <- data %>%
                            filter(.$I_ZM %in% "No pertenecen a la Zona Metropolitana") 
                   
                   # Zonas metropolitanas
                     ZM <- ZM_2020 %>%
                            select(CVE_ZM, CVE_MUN, NOM_MUN) %>%
                             pull(CVE_MUN)
                     
                    # Municipios
                    municipios <- MUN %>% pull(CVE_MUN)
                    
                    # Estados 
                    estados <- ENT %>% pull(CVE_ENT)
    
                    # Variable que se dese analizar
                    X <- get_values(data[, paste(Variable)], drop.na = TRUE) %>%
                          unlist()
                    # Etiquetas para las columnnas
                    etiquetas <- get_labels(data[, paste(Variable)], drop.na = TRUE) %>%
                                  unlist()
    
                    # Población total
                    Pob.Total <- data %>%
                                  as.data.frame() %>%
                                   filter(CVE_MUN %in% municipios) %>%
                                    group_by(CVE_ZM) %>%
                                     summarise(Pob.Total = sum(FACTOR, na.rm = TRUE)) %>%
                                      ungroup() %>%
                                       adorn_totals(c("row"), 
                                                    fill = "-", 
                                                     na.rm = TRUE) %>%
                                        adorn_percentages(denominator = "row") 
                    
                    #Población desagregada
                     # Filtro de la población desagregada
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]   
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 3 & EDAD <= 130)) %>%
                                          filter(CVE_MUN %in% municipios) %>%
                                           filter(CVE_MUN_ASI %in% municipios) %>%
                                            filter(get(Variable) %in% Var) %>%
                                             group_by(CVE_ZM) %>%
                                              summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                               set_names(c("CVE_ZM", paste0("Pob_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Pob.Objetivo <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                               purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                     adorn_totals(c("row"), 
                                                  fill = "-", 
                                                  na.rm = TRUE) %>%
                                      adorn_percentages(denominator = "row") 
    
                    # Población residente 
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]     
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 3 & EDAD <= 130)) %>%
                                          filter(CVE_MUN == CVE_MUN_ASI) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(get(Variable) %in% Var) %>%
                                             group_by(CVE_ZM) %>%
                                              summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                               set_names(c("CVE_ZM", paste0("Residentes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
    
                    Residentes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                             purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                na.rm = TRUE) %>%
                                    adorn_percentages(denominator = "row")  
                    
                    # Población Inmigrante
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]      
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 3 & EDAD <= 130)) %>%
                                          filter(CVE_MUN != CVE_MUN_ASI) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(CVE_MUN_ASI %in% municipios) %>%
                                             filter(get(Variable) %in% Var) %>%
                                              group_by(CVE_ZM) %>%
                                               summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                                set_names(c("CVE_ZM", paste0("Inmigrantes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Inmigrantes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                             purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                    adorn_totals(c("row"), 
                                                 fill = "-", 
                                                 na.rm = TRUE) %>%
                                     adorn_percentages(denominator = "row") 
                   
                    # Población Emigrante
                    p <- sapply(1:length(X), function(x){
                                     Var <- X[x]      
                                      data %>%
                                       as.data.frame() %>%
                                        mutate(EDAD = as.numeric(.$EDAD)) %>%
                                         subset((EDAD >= 3 & EDAD <= 130)) %>%
                                          filter(CVE_MUN != CVE_MUN_ASI) %>%
                                           filter(CVE_MUN %in% municipios) %>%
                                            filter(CVE_MUN_ASI %in% municipios) %>%
                                             filter(get(Variable) %in% Var) %>%
                                              group_by(CVE_ZM_ASI) %>%
                                               summarise(sum(FACTOR, na.rm = TRUE)) %>%
                                                set_names(c("CVE_ZM", paste0("Emigrantes_", etiquetas[x])))
                      }, simplify = FALSE
                    )
                    
                    Emigrantes <- left_join(ZM_2020 %>% distinct(CVE_ZM), 
                                             purrr::reduce(p, dplyr::full_join, by = 'CVE_ZM'), "CVE_ZM") %>%
                                   adorn_totals(c("row"), 
                                                fill = "-", 
                                                na.rm = TRUE)  %>%
                                    adorn_percentages(denominator = "row") 
                    
                   # Tabla de resultados
                    Resultados <- Pob.Total %>%
                                   full_join(., Pob.Objetivo, by = c("CVE_ZM")) %>%
                                   full_join(., Residentes, by = c("CVE_ZM")) %>%
                                   full_join(., Inmigrantes, by = c("CVE_ZM")) %>%
                                   full_join(., Emigrantes, by = c("CVE_ZM")) 
                    return(Resultados)
}
#tabla <- Indicadores("SEXO")
```

```{r}
require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "SEXO")
addWorksheet(wb, "GEDAD")
addWorksheet(wb, "AFRODES")
addWorksheet(wb, "HLENGUA")
addWorksheet(wb, "PERTE_INDIGENA")
addWorksheet(wb, "ALFABET")
addWorksheet(wb, "NIVACAD")
addWorksheet(wb, "G_ESCOACUM")
addWorksheet(wb, "TIE_TRASLADO_ESCU")
addWorksheet(wb, "MED_TRASLADO_ESC1")
addWorksheet(wb, "MED_TRASLADO_ESC2")
addWorksheet(wb, "MED_TRASLADO_ESC3")
writeData(wb, 1, Indicadores_P("SEXO"), colNames = TRUE)
writeData(wb, 2, Indicadores_P("GEDAD"), colNames = TRUE)
writeData(wb, 3, Indicadores_P("AFRODES"), colNames = TRUE)
writeData(wb, 4, Indicadores_P("HLENGUA"), colNames = TRUE)
writeData(wb, 5, Indicadores_P("PERTE_INDIGENA"), colNames = TRUE)
writeData(wb, 6, Indicadores_P("ALFABET"), colNames = TRUE)
writeData(wb, 7, Indicadores_P("NIVACAD"), colNames = TRUE)
writeData(wb, 8, Indicadores_P("G_ESCOACUM"), colNames = TRUE)
writeData(wb, 9, Indicadores_P("TIE_TRASLADO_ESCU"), colNames = TRUE)
writeData(wb, 10, Indicadores_P("MED_TRASLADO_ESC1"), colNames = TRUE)
writeData(wb, 11, Indicadores_P("MED_TRASLADO_ESC2"), colNames = TRUE)
writeData(wb, 12, Indicadores_P("MED_TRASLADO_ESC3"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(), "/Output/Municipio/06_Zonas Metropolitanas/2020/04_Movilidad estudiantil/SDEM/Indicadores sociodemograficos a nivel intermetropolitano 2020_Porcentajes.xlsx"), overwrite = TRUE)
```





