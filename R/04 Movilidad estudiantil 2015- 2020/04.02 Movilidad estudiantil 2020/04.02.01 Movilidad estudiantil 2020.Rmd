---
title: "Movilidad Estudiantil 2020"
author: "CONAPO"
output:
   html_document:
      highlight: tango
      theme: flatly
      toc: yes
      toc_depth: 2
      toc_float:
        collapsed: yes
---

\usepackage{color}

```{=html}
<style>
code.r{
  font-size: 10px;
}
pre {
  font-size: 12px
}
</style>

<style>
body {
text-align: justify;
font-style: normal;
font-family: "Montserrat";
font-size: 12px
}
h1.title {
  font-size: 40px;
  color: #000D3B;
}
h1 {
  color: #B6854D;
}
h2 {
  color: #172984;
}
h3 {
  color: #172984;
}
</style>
```

```{=html}
<style>
.nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #0A2687;
}
.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
    color: #ffffff;
    background-color: #09C2BC;
}
</style>
```

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE, cache.lazy = FALSE, 
                         eval = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(digits = 2, encoding = "UTF8")
```   
 

```{r, echo=FALSE}
rm(list = ls())
```

```{r, echo=FALSE}
setwd(here::here())
```

```{r, echo=FALSE}
#Font Stlye
require(showtext)
library(extrafont)
# activar showtext
# SE cargan las funtes del sitema Windows (Pero tarda en correr)
#ttf_import('C:/Users/dvill/AppData/Local/Microsoft/Windows/Fonts/')
#fonts()
#extrafont::loadfonts(device = "win")
#font_import()
windowsFonts()
```

```{r, echo = FALSE}
# Librer칤as que se usaron en el documCVE_ENTo
require(chorddiag)
require(circlize)
require(Cairo)
require(haven)
require(Hmisc) # %nin%
require(dplyr)
require(survey)
require(srvyr)
require(stringr)
require(sna)
require(expss)
require(knitr)
require(kableExtra)
require(sjlabelled)
require(gt)
require(ggplot2)
require(ggpubr)
require(ggalluvial)
require(ggsankey)
require(ggrepel)
require(janitor)
require(tibble)
require(tidyr)
require(reshape2)
require(openxlsx)
require(doMC)
registerDoMC(cores = 18)
```


**Cuestionario Ampliado del Censo de Poblaci칩n y Vivienda 2020**

El cuestionario ampliado se guarda en un un archivo `.RData`.

```{r, eval = FALSE}
data <- read_sav("~/Personas_Censo 2020.SAV")
save(data, 
      file = paste0(here::here(), "/Bases/Censo_Personas_2020.RData"))
```

Se seleccionan las variables que se desean conservar para la realizaci칩n de este documento y se guarda en un archivo `.RData` para practicidad del manejo de datos.

La variable `mydata` contiene **15 015 683 observaciones** y **27 variables**.

**Posibles variables que se pueden contemplar en la movilidad estudiantil**

-   `SEXO`
-   `NIVACAD` 쮺u치l fue el 칰ltimo a침o o grado aprobado por (NOMBRE) en la escuela?\
-   `TIE_TRASLADO_ESCU`
-   `MED_TRASLADO_ESC1`
-   `MED_TRASLADO_ESC2`\
-   `MED_TRASLADO_ESC3`
-   `NOMCAR_C`

```{r, eval = FALSE}
load(paste0(here::here(), "/Bases/Censo_Personas_2020.RData"))

mydata <- data %>%
           select(CVE_ENT, ENT, MUN, CVE_MUN, ENT_PAIS_ASI, MUN_ASI, CVE_MUN_ASI, EDAD, SEXO, 
                  AFRODES,  HLENGUA, QDIALECT_INALI, ELENGUA, PERTE_INDIGENA, ALFABET, ASISTEN, NIVACAD, 
                  ESCOLARI, ESCOACUM,  NOMCAR_C, TIE_TRASLADO_ESCU, MED_TRASLADO_ESC1, MED_TRASLADO_ESC2, MED_TRASLADO_ESC3,  
                  FACTOR, ESTRATO, UPM)
save(mydata, file = paste0(here::here(), "/Bases/04_Movilidad estudiantil_2020.RData"))
```

九덢잺A partir de aqu칤 se pueden correr los c칩didos 游녢.
Se carga el archivo `Movilidad estudiantil_2020.RData`.

```{r}
load(file = paste0(here::here(), "/Bases/04_Movilidad estudiantil_2020.RData"))

#Para fines pr치cticos se genera un ponderador de uno 
mydata <- mydata %>%
           select(CVE_ENT, ENT, MUN, CVE_MUN, ENT_PAIS_ASI, MUN_ASI, CVE_MUN_ASI, EDAD, FACTOR, ESTRATO, UPM) %>%
            mutate(M = 1)  %>%
             mutate(NOM_ENT = as.factor(.$CVE_ENT)) %>%
              ungroup()
```

**Entidades**

Se genera un vector con el nombre de las entidades llamado `estados` para facilitar los filtros en el documento.\
Se genera un vector con las abreviaturas de las entidades llamado `ent` para fines pr치cticos.\
Se genera un vector con las claves de los municipios, pero es importante hacer notar que tres municipios no entraron el muestreo del Cuestionario Ampliado.

```{r}
# Claves de los estados
estados <- sjlabelled::get_labels(mydata$CVE_ENT)
nom_estados <- c( "Aguascalientes", "Baja California" ,"Baja California Sur", "Campeche", "Coahuila de Zaragoza", "Colima", 
                  "Chiapas", "Chihuahua", "Ciudad de M칠xico", "Durango", "Guanajuato", "Guerrero", "Hidalgo", "Jalisco",        
                  "M칠xico", "Michoac치n de Ocampo", "Morelos", "Nayarit", "Nuevo Le칩n", "Oaxaca", "Puebla", "Quer칠taro", 
                  "Quintana Roo", "San Luis Potos칤", "Sinaloa", "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala", 
                  "Veracruz de Ignacio de la Llave", "Yucat치n", "Zacatecas")
est <- c("AGS", "BC", "BCS", "CAMP", "COAH", "COL", "CHIS", "CHIH", "CDMX", "DGO", "GTO", "GRO", "HGO",
         "JAL", "MEX", "MICH", "MOR", "NAY", "NL", "OAX", "PUE", "QRO", "QROO", "SLP","SIN","SON", "TAB", 
         "TAMS", "TLX", "VER", "YUC", "ZAC")

# Claves de los municipios
MUN <- readRDS(paste0(here::here(), "/Bases/municipios_2020.RDS"))
nom_municipios <- sjlabelled::get_labels(MUN$NOM_MUN) %>% as.factor()
municipios <- sjlabelled::get_labels(MUN$CVE_MUN) %>% as.factor()

# Se le asignan las etiquetas a los nombres de los estados 
levels(mydata$NOM_ENT) <- estados
```


**Poblaci칩n estudiantil de 3 a침os y m치s**

Se identifica a la poblaci칩n estudiantil de 3 a침os y m치s.

`filter(EDAD >= 3 & EDAD <= 130)'.`

```{r}
Pob.3ymas <- mydata %>%
              as.data.frame() %>%
               mutate(EDAD = as.numeric(.$EDAD)) %>%
                subset(EDAD >= 3 & EDAD <= 130) %>%
                 filter(ENT_PAIS_ASI %in% estados)  # Filtro del lugar de trabajo dentro del pa칤s. 
```

**Poblaci칩n de 3 a침os y m치s**

```{r, echo = FALSE}
# Poblaci칩n de 3 a침os y m치s
tabla <- Pob.3ymas %>%
          summarise(Pob_3ymas = sum(.$FACTOR))

as.integer(tabla) %>%  
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none"))) %>%
   gt() %>% 
    tab_header(title = "Poblaci칩n de 3 a침os y m치s") %>%
     tab_options(heading.title.font.size = 12, 
                 heading.align = "center",
                 heading.subtitle.font.size = 10,
                 table.align = "center",
                 column_labels.font.weight = "bold",
                 table.font.names = 'montserrat',
                 table.font.size = 8) %>%  
       as_raw_html()
```


# Nivel estatal {.tabset .tabset-pills}

## Movilidad estudiantil {.tabset .tabset-pills}

Se utiliza la paqueter칤a `survey` para poder trabajar con la muestra del cuestionario ampliado, en la cual se selecciona a la poblaci칩n de 3 a침os y m치s.

```{r, eval = FALSE}
options(survey.lonely.psu = "adjust")

MC <- mydata %>%
       as.data.frame() %>%
        mutate(EDAD = as.numeric(.$EDAD)) %>%
         subset(EDAD >= 3 & EDAD <= 130) %>%  
          filter(ENT_PAIS_ASI %in% estados) %>%
           svydesign(data = ., id = ~ UPM, strata = ~ESTRATO, weight = ~FACTOR, nest = T)

saveRDS(MC, file = paste0(here::here(), "/Output/Estado/04_Movilidad estudiantil/2020/MC_estado.RDS"))
```

Se genera una matriz cruzada de movilidad estudiantil a nivel estatal, utilizando la funci칩n `svytable` de la paqueter칤a `survey`.

```{r}
MC <- readRDS(file = paste0(here::here(), "/Output/Estado/04_Movilidad estudiantil/2020/MC_estado.RDS"))

Migrantes <- svytable(~ENT_PAIS_ASI + CVE_ENT, design = MC) 
```

La funci칩n `cross_cases()` de la paqueter칤a `expss`  se utiliza para crear tablas de contingencia cruzadas a partir de dos o m치s variables categ칩ricas. Utilizando el comando `weight`, permite ponderar las observaciones "factores de expansi칩n" en la tabla.   

Se quita la diagonal a la matriz cruadrada con la funci칩n `diag.remove()` de la paqueter칤a `sna`, donde esta funci칩n reemplaza los elementos de la diagonal principal de una matriz por un valor nulo o por el valor especifico.   

```{r}
Migrantes <- Migrantes %>%
              as.data.frame() %>%
               expss::cross_cases(CVE_ENT, ENT_PAIS_ASI, weight = Freq) %>%
                as.data.frame() %>%
                 slice(-33) %>% 
                  select(-row_labels) 

rownames(Migrantes)<- nom_estados
colnames(Migrantes) <- nom_estados

save(Migrantes, file = paste0(here::here(), "/Bases/Estado/04_Movilidad estudiantil/2020/Matriz de MEst a nivel estatal 2020.RData"))
 
wb <- createWorkbook()
addWorksheet(wb, "MEstudiantil 2020")
writeData(wb, 1, Migrantes, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(), "/Bases/Estado/04_Movilidad estudiantil/2020/Matriz de MEst a nivel estatal 2020.xlsx"), overwrite = TRUE)
```

**Matriz de movilidad estudiantil a nivel estatal, 2020**

::: {style="height:500px;overflow:auto;"}
```{r, echo = FALSE}
load(file = paste0(here::here(), "/Bases/Estado/04_Movilidad estudiantil/2020/Matriz de MEst a nivel estatal 2020.RData"))

tabla <- Migrantes %>%
          as.data.frame() %>%
           tibble::rownames_to_column(var = "Entidad") 

tabla %>%  
 gt() %>% 
  tab_header(title = "Matriz de movilidad estudiantil, 2020", 
             subtitle = "Nivel estatal") %>%
   tab_options(heading.title.font.size = 12, 
               heading.align = "center",
               heading.subtitle.font.size = 10,
               data_row.padding = px(1),
               column_labels.font.weight = "bold",
               column_labels.padding = px(10), 
               table.font.names = 'montserrat',
               table.font.size = 8) %>%
    tab_style(style = list(cell_text(align = "center",
                                     weight = 'bold')),
              locations = list(cells_title(groups = c("title")))) %>%
  
     tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
      sub_missing(columns = everything(), missing_text = "0") %>%
       as_raw_html()
```
:::

## Gr치fico din치mico

Gr치fico din치mico de movilidad estudiantil a nivel estatal.

```{r, fig.width=7, fig.height=5, fig.align='center'}
#devtools::install_github("mattflor/chorddiag")
require(chorddiag)

load(file = paste0(here::here(), "/Bases/Estado/04_Movilidad estudiantil/2020/Matriz de MEst a nivel estatal 2020.RData"))

tabla <- Migrantes %>%
          sna::diag.remove(remove.val = 0) 

# Paleta de colores
#paleta <- colorRampPalette(pals::ocean.matter(100))(50)
paleta <- c("#000C7D", "#001599", "#0022B0", "#0035BB", "#004AB4", "#005EA3", "#00708D", "#078472","#3E9A85", "#49A980", "#58B877", "#70C669", "#94D25D", "#BBDA60", "#DDE379", "#DEE53E", "#DBCE33", "#D6B92A", "#D1A521", "#CA911A")

p <- chorddiag(tabla, 
               groupColors = paleta, 
               groupnamePadding = 10, 
               height = 500, 
               width = 500,
               margin = 100,
               groupThickness = 0.07,
               groupPadding = 0.8,
               groupnameFontsize = 10,
               fadeLevel = 1,
               chordedgeColor = "#D0D0CF", 
               showTicks = TRUE)

p

require(htmlwidgets)
htmlwidgets::saveWidget(p, paste0(here::here(), "/Graficos/Estado/04_Movilidad estudiantil/2020/MEst a nivel estatal 2020.html"), selfcontained = TRUE)
#require(webshot)
#webshot(url = paste0(here::here(), "/Graficos/Estado/04_Movilidad estudiantil/2020/MEst a nivel estatal 2020.html"),
 #         file = paste0(here::here(), "/Graficos/Estado/04_Movilidad estudiantil/2020/MEst a nivel estatal 2020.png"),
  #                cliprect = "viewport")
```

## Gr치ficos {.tabset .tabset-pills}

### ChordDiagram

```{r, eval = FALSE}
#paleta <- colorRampPalette(pals::ocean.matter(100))(50)
paleta <- colorRampPalette(c("#000C7D", "#001599", "#0022B0", "#0035BB", "#004AB4", "#005EA3", "#00708D", "#078472","#3E9A85", "#49A980", "#58B877", "#70C669", "#94D25D", "#BBDA60", "#DDE379", "#DEE53E", "#DBCE33", "#D6B92A", "#D1A521", "#CA911A"))(50)

load(file = paste0(here::here(), "/Bases/Estado/04_Movilidad estudiantil/2020/Matriz de MEst a nivel estatal 2020.RData"))

tabla <- Migrantes %>%
          sna::diag.remove(remove.val = 0)  

rownames(tabla) <- stringr::str_wrap(nom_estados, 100)
colnames(tabla) <- stringr::str_wrap(nom_estados, 100)

# Paleta de colores
groupColors <- setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla), rownames(tabla))))),
                         nm = str_sort(unique(c(colnames(tabla), rownames(tabla))), numeric = TRUE))
```

```{r, fig.height=20, fig.width=20, eval = FALSE, class.source = "fold-hide"}
#svglite::svglite(paste0(here::here(), "/Graficos/Estado/04_Movilidad estudiantil/2020/ChordDiagram de MEst a nivel estatal.svg"), width = 20, height = 20)
cairo_pdf(paste0(here::here(), "/Graficos/Estado/04_Movilidad estudiantil/2020/ChordDiagram de MEst a nivel estatal.pdf"),
          width = 7, height = 7, 
          family = "Montserrat Medium",
          fallback_resolution = 400,
          onefile = TRUE)

circos.clear()
circos.par(start.degree = 90, 
           gap.degree = 2, 
           clock.wise = FALSE,
           #track.margin = c(-0.07, 0.07),  # c칤rculo exterior | circulo interior
           track.margin = c(-0.07, 0.1),
           points.overflow.warning = FALSE)

par(mar = rep(0, 4))

chordDiagram(x  = tabla, 
             grid.col = groupColors,
             order = str_sort(unique(c(colnames(tabla), rownames(tabla)))),
             keep.diagonal = FALSE,
             transparency =  0.4,
             directional = 1,
             direction.type = c("arrows", "diffHeight"), 
             diffHeight  = -0.04, # adjust the starting end of the link
             annotationTrack = "grid", 
             annotationTrackHeight = c(0.05, 0.1),
             preAllocateTracks = 1, 
             big.gap = 40, # Gap between row sectors and column sectors.
             link.arr.type = "big.arrow", 
             link.lwd = 3,    # Line width width for link borders
             link.lty = 1,
             link.visible = TRUE,
             link.largest.ontop = TRUE)

# Add text and axis
circos.trackPlotRegion(track.index = 1,
                       track.height = 0.05,
                       bg.border = NA, 
                       panel.fun = function(x, y) {
                                                   xlim = get.cell.meta.data("xlim")
                                                   ylim = get.cell.meta.data("ylim")
                                                   sector.name = get.cell.meta.data("sector.index")
                                                  # Add names to the sector. 
                                                   circos.text(x = mean(xlim), 
                                                               y = ylim[1] + 0.1, 
                                                               labels = sector.name, 
                                                               facing = "clockwise",
                                                               niceFacing = TRUE, 
                                                               adj = c(-0.05, 0.5), #Ajuste de las etiquetas (x, y)
                                                               cex = fontsize(9),
                                                               col = "#000C7D",
                                                               font = 1)
                                                  # Add graduation on axis
                                                   circos.axis(h = "top",
                                                               labels = c(0, 10, 20, 50, 100, 200, 300, 400, 500, seq(1000, 20000, by = 1000)),
                                                               major.tick.length = 0.5,
                                                               minor.ticks = 4, 
                                                               labels.cex = fontsize(6),
                                                               sector.index = sector.name,
                                                               track.index = 2,
                                                               labels.niceFacing = TRUE,
                                                               labels.pos.adjust = c(0, 0.8))
                                                }
  )
dev.off()
```

#### Gr치ficos por estados

Se filtran los flujos migratorios que son exclusivos de los estados y que visualmente sean m치s interpretables.

```{r, results = FALSE, eval = FALSE}
load(file = paste0(here::here(), "/Bases/Estado/04_Movilidad estudiantil/2020/Matriz de MEst a nivel estatal 2020.RData"))

tabla <- Migrantes %>%
          sna::diag.remove(remove.val = 0) 

rownames(tabla) <- stringr::str_wrap(nom_estados, 100)
colnames(tabla) <- stringr::str_wrap(nom_estados, 100)


# Nombre de los estados 
estado <- stringr::str_wrap(nom_estados, 100)

filtro_est <- Migrantes %>%
               as.data.frame() %>%
                tibble::rownames_to_column(var = "rn") %>% 
                 melt(., id.vars = "rn", variable.name = "cn") %>%
                  mutate_if(is.factor, as.character) 

### Sacar el promedio de los flujos migratiorios para determinar como se van a grupar los estados 
#### Es importante correr la tabla1[[x]] sin filtros para determinar el n칰mero promedio de flujos de migraci칩n
### Filtro <<<<  filter(value > 0 & rn != estado[x])
#filtro_mig <- sapply(1:32, function(x)
                      #mean(tail(sort(tabla1[[x]]), 5), na.rm = TRUE))
#p <- data.frame(estados = est,
 #             filtro_estados = filtro_mig)
#write.table(p, file = paste0(here::here(), "/Bases/Estado/04_Movilidad estudiantil/2020/Filtro a nivel estatal.txt"))
#write.xlsx(p, file = paste0(here::here(), "/Bases/Estado/04_Movilidad estudiantil/2020/Filtro a nivel estatal.xlsx"))

filtro_mig <- read.xlsx(paste0(here::here(), "/Bases/Estado/04_Movilidad estudiantil/2020/Filtro a nivel estatal.xlsx"), colNames = TRUE) %>% 
               pull(filtro_estados)

tabla1 <- lapply(1:32, function(x){
                         filtro_rn  <- filtro_est %>%
                                        mutate(value = ifelse(.$rn %in% estado[x] | .$cn %in% estado[x], value, 0)) %>%
                                         group_by(rn) %>%
                                          summarise(Inm = sum(value, na.rm = TRUE))

                         filtro_cn  <- filtro_est %>%
                                        mutate(value = ifelse(.$rn %in% estado[x] | .$cn %in% estado[x], value, 0)) %>%
                                         group_by(cn) %>%
                                          summarise(Emg = sum(value, na.rm = TRUE))

                         filtro <- filtro_rn %>%
                                    full_join(., filtro_cn, by = c("rn" = "cn")) %>%
                                     mutate(value = sum_row(.$Inm, .$Emg, na.rm = TRUE)) %>%
                                      filter(value > filtro_mig[x] & rn != estado[x]) %>%
                                       pull(rn)

                          tabla  %>%
                           as.data.frame() %>%
                            tibble::rownames_to_column(var = "rn") %>%
                             melt(., id.vars = "rn", variable.name = "cn") %>%
                              mutate_if(is.factor, as.character) %>%
                               mutate(value = ifelse(.$rn %in% estado[x] | .$cn %in% estado[x], value, 0)) %>%
                                mutate(rn = case_when(.$rn %in% estado[x] ~ .$rn,
                                                      .$rn %in% filtro ~ .$rn,
                                                      .$rn %nin% filtro ~ "Otros estados"),
                                       cn = case_when(.$cn %in% estado[x] ~.$cn, 
                                                      .$cn %in% filtro ~ .$cn,
                                                      .$cn %nin% filtro ~ "Otros estados")) %>%
                                 dcast(., rn ~ cn, value.var = "value", sum,  na.rm = TRUE) %>%                                               
                                  column_to_rownames(., var = "rn") 
  }
)

## Se guardan las matrices de movilidad estudiantil para analizarlos despu칠s. 
wb <- createWorkbook()
for(i in 1:32){
     tabla <- tabla1[[i]] %>%
                as.data.frame() %>%
                 adorn_totals(c("row", "col"), 
                               fill = "-", 
                                na.rm = TRUE, 
                                 name = "Total",,,,contains(colnames(tabla1[[i]])))
                 
     addWorksheet(wb, paste(est[i]))
     writeData(wb, i, tabla, colNames = TRUE, rowNames = TRUE)
     saveWorkbook(wb, 
                  file = paste0(here::here(), "/Output/Estado/04_Movilidad estudiantil/2020/Matriz MEst por estados_2020_Reduccion.xlsx"), 
               overwrite = TRUE)
}
saveRDS(tabla1, file = paste0(here::here(), "/Output/Estado/04_Movilidad estudiantil/2020/Tabla MEst por estados.RDS"))
```

```{r tablas de matrices}
tabla1 <- readRDS(file = paste0(here::here(), "/Output/Estado/04_Movilidad estudiantil/2020/Tabla MEst por estados.RDS"))

totales <- lapply(1:length(estados), function(x){
                #Se agrupan los totales
                 full_join(
                           tabla1[[x]] %>%
                            as.data.frame() %>%
                             adorn_totals(c("row", "col"), 
                                          fill = "-", 
                                          na.rm = TRUE, 
                                           ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                              slice(nrow(.)) %>% 
                               t() %>%
                                as.data.frame()%>%
                                 rownames_to_column(var = "name")  %>% 
                                  rename("Total_Filas" = "1"),
                           tabla1[[x]] %>%
                            as.data.frame() %>%
                             adorn_totals(c("row", "col"), 
                                          fill = "-", 
                                          na.rm = TRUE, 
                                           ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                              rownames_to_column(var = "name") %>%
                               select(name, Total) %>%
                                mutate(name = str_replace(.$name, "1$", "Total")), 
                           by = c("name")
                           ) %>%
                           rename("CVE_ENT" = "name",
                                  "Entran por estudio" = "Total_Filas", # Poblaci칩n que entra a la entidad para estudiar 
                                  "Salen por estudio" = "Total") %>% # Poblaci칩n que sale de su entidad de residencia y entra a otra demarcaci칩n por motivos de estudios
                            select(`Entran por estudio`, CVE_ENT, `Salen por estudio`)
  }
)
porcentajes <- lapply(1:length(estados), function(x){
                           #Se agrupan los porcentajes
                           full_join(
                                     tabla1[[x]] %>%
                                      as.data.frame() %>%
                                       adorn_totals(c("col", "row"), 
                                                    fill = "0", 
                                                    na.rm = TRUE, 
                                                    name = "Total",
                                                    ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                        adorn_percentages("col",
                                                          na.rm = TRUE) %>% 
                                         rownames_to_column(var = "name") %>%
                                          select(name, Total) %>%
                                           mutate(name = str_replace(.$name, "1$", "Total")),
                                     tabla1[[x]] %>%
                                      as.data.frame() %>%
                                       adorn_totals(c("row"), 
                                                    fill = "0", 
                                                    na.rm = TRUE, 
                                                    name = "Total", 
                                                    ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                        adorn_percentages("row", 
                                                          na.rm = TRUE, 
                                                         ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                         slice(nrow(.)) %>% 
                                          t() %>%
                                           as.data.frame()%>%
                                            rownames_to_column(var = "name")  %>% 
                                             rename("Total_Filas" = "1"), 
                                     by = c("name")
                                          ) %>%
                                      rename("CVE_ENT" = "name",
                                             "Entran por estudio%" = "Total_Filas", # Poblaci칩n que entra a la entidad para estudiar 
                                             "Salen por estudio%" = "Total") %>% # Poblaci칩n que sale de su entidad de residencia y entra a otra demarcaci칩n por motivos de estudios
                                       select(`Entran por estudio%`, CVE_ENT, `Salen por estudio%`)
                                   
  }
)

# Se guardan los totales de las matrices reducidas 
wb <- createWorkbook()
for(i in 1:32){
     addWorksheet(wb, paste(est[i]))
     writeData(wb, i, totales[[i]], colNames = TRUE, startCol = 1)
     writeData(wb, i, porcentajes[[i]], colNames = TRUE, startCol = 5)
     saveWorkbook(wb, 
                  file = paste0(here::here(),  "/Output/Estado/04_Movilidad estudiantil/2020/Matriz MEst por estados_2020_Reduccion_Totales.xlsx"), 
               overwrite = TRUE)
}
```

```{r}
tabla1 <- readRDS(file = paste0(here::here(), "/Output/Estado/04_Movilidad estudiantil/2020/Tabla MEst por estados.RDS"))

# Paleta de colores
#paleta <- rev(colorRampPalette(wesanderson::wes_palette("Rushmore1"))(50)) 
paleta <- colorRampPalette(c("#000C7D", "#001599", "#0022B0", "#0035BB", "#004AB4", "#005EA3", "#00708D", "#078472","#3E9A85", "#49A980", "#58B877", "#70C669", "#94D25D", "#BBDA60", "#DEE53E", "#DBCE33", "#D6B92A", "#D1A521", "#CA911A"))(50)

tabla2 <- lapply(1:length(estados), function(x){ 
                    # Paleta de colores
                       groupColors <- setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))))),
                                               nm = str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))
                        circos.clear()
                         chordDiagram(x  = tabla1[[x]] %>% as.matrix(), 
                                       transparency = 0.4,
                                        order = str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE),
                                         grid.col = groupColors)  %>% 
                          pull(col)
  }
)
```


```{r grafico estatal, eval = FALSE, results='hide'}
cairo_pdf(paste0(here::here(), "/Graficos/Estado/04_Movilidad estudiantil/2020/ChordDiagram de MEst para cada estado.pdf"),
          width = 8,
          height = 8, 
          family = "Montserrat Medium",
          fallback_resolution = 400,
          onefile = TRUE)

for(i in 1:length(estados)){
  
# Paleta de colores
groupColors <- setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]]))))),
                        nm = str_sort(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]]))), numeric = TRUE))

circos.clear()
circos.par(start.degree = 90, 
           gap.degree = 2, 
           clock.wise = FALSE,
           #track.margin = c(-0.07, 0.07),  # c칤rculo exterior | circulo interior
           track.margin = c(-0.07, 0.1),
           points.overflow.warning = FALSE)

par(mar = rep(0, 4))

chordDiagram(x  =  tabla1[[i]] %>% as.matrix(), 
             grid.col = groupColors,
             col = tabla2[[i]],
             order = str_sort(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]])))),
             keep.diagonal = FALSE,
             transparency =  0,
             directional = 1,
             direction.type = c("arrows", "diffHeight"), 
             diffHeight  = -0.04, # adjust the starting end of the link
             annotationTrack = "grid", 
             annotationTrackHeight = c(0.05, 0.1),
             preAllocateTracks = 1, 
             big.gap = 40, # Gap between row sectors and column sectors.
             link.arr.type = "big.arrow", 
             link.lwd = 3,    # Line width width for link borders
             link.lty = 1,
             link.visible = TRUE,
             link.largest.ontop = TRUE)

# Add text and axis
circos.trackPlotRegion(track.index = 1,
                       track.height = 0.05,
                       bg.border = NA, 
                       panel.fun = function(x, y) {
                                                   xlim = get.cell.meta.data("xlim")
                                                   ylim = get.cell.meta.data("ylim")
                                                   sector.name = get.cell.meta.data("sector.index")
                                                  # Add names to the sector. 
                                                   circos.text(x = mean(xlim), 
                                                               y = ylim[1] + 0.1, 
                                                               labels = sector.name, 
                                                               facing = "clockwise",
                                                               niceFacing = TRUE, 
                                                               adj = c(-0.05, 0.5), #Ajuste de las etiquetas (x, y)
                                                               cex = fontsize(9),
                                                               col = "#000C7D",
                                                               font = 1)
                                                  # Add graduation on axis
                                                   circos.axis(h = "top",
                                                               labels = c(0, 10, 20, 50, 100, 200, 300, 400, 500, seq(1000, 20000, by = 1000)),
                                                               major.tick.length = 0.5,
                                                               minor.ticks = 4, 
                                                               labels.cex = fontsize(6),
                                                               sector.index = sector.name,
                                                               track.index = 2,
                                                               labels.niceFacing = TRUE,
                                                               labels.pos.adjust = c(0, 0.8))
                                                }
  )
}
dev.off()
```

**Etiquetas**

```{r}
etiquetas  <- lapply(1:length(estados), function(x){
                        p <-  tabla1[[x]] %>% 
                               as.data.frame() %>%
                                tibble::rownames_to_column(var = "rn") %>%
                                 melt(., id.vars = "rn", variable.name = "cn") %>%
                                  as.data.frame() %>% 
                                   mutate(rn = str_wrap(.$rn, 100),
                                          cn = str_wrap(.$cn, 100)) %>%
                                    ggplot() + 
                                     geom_bar(aes(x = value, fill = rn))  + 
                                      geom_bar(aes(x = value, fill = cn))  + 
                                       theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                                             text = element_text(family = "Montserrat Medium"),
                                             axis.text = element_blank(),
                                             axis.title = element_blank(),
                                             strip.text = element_text(size = 9, face = "bold", family = "Montserrat Medium"),  
                                             legend.key.size = unit(0.4, "cm"), 
                                             legend.spacing.y = unit(0.4, "cm"),
                                             legend.text = element_text(size = 7, family = "Montserrat Medium"),
                                             legend.title = element_text(size = 8 , family = "Montserrat Medium")) + 
                                        scale_fill_manual(values = colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]])))))) + 
                                         guides(fill = guide_legend(ncol = 1)) + 
                                          labs(fill = stringr::str_wrap(paste(nom_estados[x]), 100),
                                               color = stringr::str_wrap(paste(nom_estados[x]), 100))
                         leg <- get_legend(p)
                         as_ggplot(leg)
 })

cairo_pdf(paste0(here::here(), "/Graficos/Estado/04_Movilidad estudiantil/2020/Etiquetas a nivel estatal.pdf"), 
          width = 7, height = 8, 
          fallback_resolution = 400,
          family = "montserrat", onefile = TRUE)
for(i in 1:length(estados)){
  print(etiquetas[i])
}
dev.off()
```



### Gr치fico Sankey

#### Poblaci칩n estudiantil de 3 a침os y m치s

Se genera la variable `Pob.3ymas` sin ning칰n filtro y se desagrega a nivel estatal para futuros c치lculos.

```{r, eval = FALSE}
load(file = paste0(here::here(), "/Bases/Estado/04_Movilidad estudiantil/2020/Matriz de MEst a nivel estatal 2020.RData"))

Migrantes <- Migrantes %>%
              sna::diag.remove(remove.val = 0)  

rownames(Migrantes) <- stringr::str_wrap(nom_estados, 50)
colnames(Migrantes) <- stringr::str_wrap(nom_estados, 50)

# Matiz movilidad interna
tabla <- Migrantes %>% 
          as.data.frame() %>%
           tibble::rownames_to_column(var = "rn") %>%
            melt(., id.vars = "rn", variable.name = "cn") %>%
             as_tibble() %>%
              mutate(rn = forcats::fct_relevel(.$rn, nom_estados),
                     cn = forcats::fct_relevel(.$cn, nom_estados)) %>%
               filter(value >= 0)  
```


```{r, eval = FALSE}
p <- tabla %>% 
       ggplot(aes(axis1 = rn, 
                   axis2 = cn, 
                    y = value),  # c("value", "freq", "tasa")
               reverse = FALSE, 
                na.rm = TRUE) +
        geom_alluvium(aes(fill = rn),
                       curve_type = "quintic", 
                        color = "transparent", 
                         alpha = 0.85, 
                          lwd = 0.001, 
                           width = 1/5,
                            reverse = FALSE) +
          geom_stratum(aes(fill = cn), 
                        color = "white", 
                         alpha = 0.65,  
                          lwd = 0.001, 
                           width = 1/5,
                            reverse = FALSE) +
           geom_text_repel(aes(label = ifelse(after_stat(x) == 1, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""), 
                               fontface =  ifelse(after_stat(x) == 1, 'bold', 'plain')),
                            stat = "stratum", 
                             size = 3, 
                              direction = "y", 
                               nudge_x = -.2,
                                min.segment.length = unit(1, "lines"),
                                 force = 1,
                                  force_pull = 0,
                                   family = "montserrat",
                                    reverse = FALSE) +
            geom_text_repel(aes(label = ifelse(after_stat(x)  == 2, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                fontface =  ifelse(after_stat(x) == 2, 'bold', 'plain')),
                             stat = "stratum", 
                              size = 3,
                               direction = "y", 
                                nudge_x = .2, 
                                 force = 1,
                                  force_pull = 0,
                                   family = "montserrat",
                                    reverse = FALSE) +
             theme_void() + 
              theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                     text = element_text(family = "montserrat"),
                      axis.text = element_blank(),
                       axis.title = element_blank(),
                        strip.text = element_text(size = 10, face = "bold", family = "montserrat"),
                         legend.key.size = unit(0.5, "cm"),
                          legend.text = element_text(size = 8, family = "montserrat"),
                           legend.position = c(1, .5)) + 
               scale_x_discrete(expand = c(-0.1, 0.35)) +
                scale_fill_viridis_d(option = "A") +
                 guides(fill = guide_legend(ncol = 1, na.translate = F)) + 
                  labs(fill = "", 
                       color = "")

path = paste0(here::here(), "/Graficos/Estado/04_Movilidad estudiantil/2020/GSankey de MEst a nivel estatal.pdf")
ggexport(p, width = 18, height = 10, dpi = 400, filename = path)
```

**Desagregado por estado**

```{r, eval = FALSE}
load(file = paste0(here::here(), "/Bases/Estado/04_Movilidad estudiantil/2020/Matriz de MEst a nivel estatal 2020.RData"))

# Se cambian las equiquetas de los estados 
estados <- est 

rownames(Migrantes) <- estados
colnames(Migrantes) <- estados

tabla <- Migrantes %>%
          sna::diag.remove(remove.val = 0) %>%
           as.data.frame() %>%
            tibble::rownames_to_column(var = "rn") %>% 
             melt(., id.vars = "rn", variable.name = "cn") %>%
              mutate_if(is.factor, as.character) %>%
               mutate(value = ifelse((.$rn != .$cn) & (.$rn %in% estados | .$cn %in% estados), value, 0)) %>%
                mutate(rn = forcats::fct_relevel(.$rn, estados),
                       cn = forcats::fct_relevel(.$cn, estados)) 
```

```{r, eval = FALSE}
p <- lapply(1:32, function(x){
                   tabla <- tabla %>%
                             mutate(rn = forcats::fct_relevel(.$rn, estados),
                                    cn = forcats::fct_relevel(.$cn, estados)) %>%
                              mutate(value = ifelse(.$rn %in% estados[x] | .$cn %in% estados[x], value, 0)) 
 
                    tabla %>% 
                     ggplot(aes(axis1 = rn, 
                                 axis2 = cn, 
                                  y = value),  # c("value", "freq", "tasa")
                             reverse = FALSE, 
                              na.rm = TRUE) + 
                      geom_alluvium(aes(fill = rn),  
                                     color = "transparent", 
                                      alpha = 0.8, 
                                       lwd = 0.001, 
                                        width = 1/5,
                                         reverse = FALSE) +
                       geom_stratum(aes(fill = rn), 
                                     color = "#F1F1F1", 
                                      alpha = 1, 
                                       lwd = 0.001, 
                                        width = 1/5,
                                         reverse = FALSE) +
                         geom_text_repel(aes(label = ifelse(after_stat(x)  == 1, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                             fontface =  ifelse(after_stat(x) == 1, 'bold', 'plain')),
                                           stat = "stratum", 
                                            size = 3,
                                             direction = "y", 
                                              nudge_x = -.2, 
                                               force = 1,
                                                        force_pull = 0,
                                                         family = "montserrat",
                                                          reverse = FALSE) +
                          geom_text_repel(aes(label = ifelse(after_stat(x)  == 2, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                              fontface =  ifelse(after_stat(x) == 2, 'bold', 'plain')),
                                           stat = "stratum", 
                                            size = 3,
                                             direction = "y", 
                                              nudge_x = .2, 
                                               force = 1,
                                                force_pull = 0,
                                                 family = "montserrat",
                                                  reverse = FALSE) +
                            theme_void() + 
                             theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                                    text = element_text(family = "montserrat"),
                                     axis.text = element_blank(),
                                      axis.title = element_blank(),
                                       strip.text = element_text(size = 10, face = "bold", family = "montserrat"),
                                        legend.key.size = unit(0.5, "cm"),
                                         legend.text = element_text(size = 9, family = "montserrat"),
                                          legend.position = c(1, .5)) + 
                              scale_x_discrete(expand = c(-0.1, 0.35)) +
                               scale_fill_viridis_d(option = "A", end = 0.9, begin = 0.2) +
                                guides(fill = guide_legend(ncol = 1, na.translate = F)) + 
                                 labs(fill = "", 
                                      color = "")
              }
)

path = paste0(here::here(), "/Graficos/Estado/04_Movilidad estudiantil/2020/GSankey de MEst desagregado por estados_Absolutos.pdf")
ggexport(list = p, width = 14, height = 10, dpi = 400, filename = path)
```

## Indicadores {.tabset .tabset-pills}

Se realizan c치lculos generales de movilidad\
+ Residentes\
+ Inmigrantes\
+ Emigrantes\
+ $\%$ Inmigrantes\
+ $\%$ Emigrante\
+ Migraci칩n bruta\
+ Migraci칩n Neta\
+ $\%$ Tasa de movilidad bruta\
+ $\%$ Tasa de movilidad neta

Se trabaja con la matriz cuadrada, la cual de esta manera no se satura computacionalmente


```{r}
################################################################################
############################ Poblaci칩n total ###################################
Pob.Total <- mydata %>%
              as.data.frame() %>%
               group_by(CVE_ENT) %>%
                summarise(Pob.Total = sum(FACTOR)) 

################################################################################
###################### Pob. estudiantil de 3 a침os y m치s ########################
estados <- sjlabelled::get_labels(mydata$CVE_ENT)

Pob.3ymas <- mydata %>%
              as.data.frame() %>%
               mutate(EDAD = as.numeric(.$EDAD)) %>%
                subset((EDAD >= 3 & EDAD <= 130)) %>%
                 #filter(ENT_PAIS_ASI %in% estados) %>%
                  group_by(CVE_ENT) %>%
                   summarise(Pob.3ymas = sum(FACTOR)) 

################################################################################
########################### Residentes #########################################
load(file = paste0(here::here(), "/Bases/Estado/04_Movilidad estudiantil/2020/Matriz de MEst a nivel estatal 2020.RData"))

rownames(Migrantes) <- str_pad(rep(1:32), width = 3, pad = "0")
colnames(Migrantes) <- str_pad(rep(1:32), width = 3, pad = "0")

Residentes <- Migrantes %>%
               rownames_to_column() %>%
                gather(CVE_ENT, Value, -rowname)%>%
                 filter(rowname == CVE_ENT) %>%
                  select(-rowname) %>%
                   droplevels() %>%
                    rename("Residentes" = "Value") 

################################################################################
############################### Inmigrantes ####################################

## Poblaci칩n que sale de su entidad de residencia y entra a otra demarcaci칩n por motivos de estudios
Inmigrantes <- Migrantes %>% 
                sna::diag.remove(remove.val = 0) %>%
                 as.data.frame() %>%
                  tibble::rownames_to_column(var = "CVE_ENT") %>%
                   melt(., id.vars = "CVE_ENT", variable.name = "ENT_PAIS_ASI") %>%
                    mutate_at(vars(3), as.numeric) %>%
                     as_tibble() %>%
                      filter(CVE_ENT != ENT_PAIS_ASI) %>%
                       group_by(CVE_ENT) %>%
                        summarise(Inmigrantes = sum(value, na.rm = TRUE))

################################################################################
############################### Emigrantes #####################################

## Poblaci칩n que entra a la entidad para estudiar 
Emigrantes <- Migrantes %>% 
               sna::diag.remove(remove.val = 0) %>%
                as.data.frame() %>%
                 tibble::rownames_to_column(var = "CVE_ENT") %>%
                  melt(., id.vars = "CVE_ENT", variable.name = "ENT_PAIS_ASI") %>%
                   mutate_at(vars(3), as.numeric) %>%
                    as_tibble() %>%
                     filter(CVE_ENT != ENT_PAIS_ASI) %>%
                      group_by(ENT_PAIS_ASI) %>%
                       summarise(Emigrantes = sum(value, na.rm = TRUE)) %>%
                        rename("CVE_ENT" = "ENT_PAIS_ASI")

tabla <- Pob.Total %>%
          left_join(., Pob.3ymas, by = c("CVE_ENT")) %>%
          left_join(., Residentes, by = c("CVE_ENT")) %>%
          left_join(., Inmigrantes, by = c("CVE_ENT")) %>%
          left_join(., Emigrantes, by = c("CVE_ENT")) %>%
            mutate(Mig.Neta = .$Inmigrantes - .$Emigrantes,
                   Mig.Bruta = .$Inmigrantes + .$Emigrantes, 
                   Tasa.Inmig = ((.$Inmigrantes/ 5) /((.$Pob.Total + .$Pob.3ymas) / 2))*1000,
                   Tasa.Emig = ((.$Emigrantes/ 5) /((.$Pob.Total + .$Pob.3ymas) / 2))*1000,
                   Tasa.Mig = Tasa.Inmig - Tasa.Emig, 
                   Eficacia = Mig.Neta - Mig.Bruta)

write.xlsx(tabla, file = paste0(here::here(), "/Output/Estado/04_Movilidad estudiantil/2020/Indicadores de MEst a nivel estatal 2020.xlsx"), overwrite = TRUE)

save(tabla, file = paste0(here::here(), "/Output/Estado/04_Movilidad estudiantil/2020/Indicadores de MEst a nivel estatal 2020.RData"))
```

```{r, echo = FALSE}
load(file = paste0(here::here(), "/Output/Estado/04_Movilidad estudiantil/2020/Indicadores de MEst a nivel estatal 2020.RData"))

tabla %>%  
 as.data.frame() %>%
  gt() %>% 
   tab_header(title = "Indicadores de  movilidad estudiantil", 
              subtitle = "Nivel estatal") %>%
    tab_options(heading.title.font.size = 12, 
                heading.align = "center",
                heading.subtitle.font.size = 10,
                data_row.padding = px(1),
                column_labels.font.weight = "bold",
                column_labels.padding = px(10), 
                table.font.names = 'montserrat',
                table.font.size = 8) %>%
     tab_style(style = list(cell_text(align = "center",
                                      weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
      fmt_integer(columns = c(2:8, 12), sep_mark = " ") %>%
       fmt_number(columns = c(9:11), decimals = 1) %>%
        sub_missing(columns = everything(), missing_text = "0") %>%
         tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
          as_raw_html()
```

# Nivel municipal {.tabset .tabset-pills}

## Movilidad estudiantil {.tabset .tabset-pills}

### Matrices 

```{r, eval = FALSE}
### Municipios que no pertenecen en la muestra
municipios_nomuestra <- c("004012", "007125", "029048")

#Clave de los municipios 2020 
municipios <- MUN %>%
               select(CVE_MUN) %>%
                unique() %>%
                 filter(CVE_MUN %nin% municipios_nomuestra) %>%
                  pull(CVE_MUN)

Pob.3ymas <- mydata %>%
              mutate(CVE_MUN_ASI = paste0(ENT_PAIS_ASI, MUN_ASI)) %>%
               mutate(ENT_PAIS_ASI = case_when(.$ENT_PAIS_ASI %in% estados ~.$ENT_PAIS_ASI,
                                               .$ENT_PAIS_ASI %nin% estados ~ "888", #Residencia en otro pa칤s
                                               .$ENT_PAIS_ASI %in% "997" ~ "997",
                                               .$ENT_PAIS_ASI %in% "998" ~ "998",
                                               .$ENT_PAIS_ASI %in% "997" ~ "999"),
                      CVE_MUN_ASI = case_when(.$CVE_MUN_ASI %in% municipios ~.$CVE_MUN_ASI,
                                             #### Se excluyen los municipios que no fueron muestreados
                                              .$CVE_MUN_ASI %in% municipios_nomuestra ~ "777",
                                               nchar(.$CVE_MUN_ASI) == 3 ~ "888",  #Asistencia escolar en otro pa칤s
                                              .$CVE_MUN_ASI %in% "997999" ~ '997999',
                                              .$ENT_PAIS_ASI %in% "997" ~ "997",
                                              .$ENT_PAIS_ASI %in% "998" ~ "998",
                                              .$ENT_PAIS_ASI %in% "999" ~ "999",
                                              .$MUN_ASI %in% "999" ~ "999")) %>%
                mutate(EDAD = as.numeric(.$EDAD)) %>%
                 subset(EDAD >= 3 & EDAD <= 130) %>%
                  select(FACTOR, ESTRATO, UPM, CVE_MUN, CVE_MUN_ASI, EDAD) %>%
                   filter(CVE_MUN_ASI %in% municipios) 

MC <- Pob.3ymas %>%
       svydesign(data = ., id = ~ UPM, strata = ~ESTRATO, weight = ~FACTOR, nest = T)

saveRDS(MC, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/MC_municipal.RDS"))
```

```{r, eval = FALSE}
MC <- readRDS(file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/MC_municipal.RDS"))

Migrantes <- svytable(~CVE_MUN_ASI + CVE_MUN, design = MC) 
```


Se genera la matriz cuadrada y se le asignan los nombres de los estados.

```{r, eval = FALSE}
Migrantes <- Migrantes %>%
              as.data.frame() %>%
               expss::cross_cases(CVE_MUN, CVE_MUN_ASI, weight = Freq) %>%
                as.data.frame() %>%
                 rename("CVE_MUN" = "row_labels") %>% 
                  arrange(CVE_MUN) %>%
                   slice(-1) 

rownames <- Migrantes %>% 
             mutate(CVE_MUN = substr(.$CVE_MUN, 9, 16)) %>% 
              pull(CVE_MUN)

colnames <- names(Migrantes) %>% 
             as.data.frame() %>% 
              slice(-1) %>% 
               rename("CVE_MUN" = ".") %>%
                mutate(`CVE_MUN` = substr(.$CVE_MUN, 13, 18)) %>%
                 pull(CVE_MUN)

# Se elimina la variable CVE_MUN
Migrantes <- Migrantes %>%
              select(-CVE_MUN)

rownames(Migrantes) <- rownames 
colnames(Migrantes) <- colnames

saveRDS(Migrantes, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel municipal 2020.RDS"))
save(Migrantes, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel municipal 2020.RData"))

require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "M.estudiantil")
writeData(wb, 1, Migrantes %>% as.data.frame() %>% tibble::rownames_to_column(var = "CVE_MUN"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(), "/Bases/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel municipal 2020.xlsx"), overwrite = TRUE)
```

**Matriz de movilidad estudiantil hace 3 a침os a nivel municipal, 2015 - 2020**

<div style="height:500px;overflow:auto;">

```{r, echo = FALSE}
load(paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel municipal 2020.RData"))

tabla <- Migrantes %>%
          as.data.frame() %>%
           tibble::rownames_to_column(var = "CVE_MUN") %>%
            mutate_if(is.numeric, as.numeric)

tabla[1:30, 1:30] %>%  
 gt() %>% 
  tab_header(title = "Matriz de movilidad estudiantil", 
             subtitle = "Nivel municipal") %>%
   tab_options(heading.title.font.size = 12, 
               heading.align = "center",
               heading.subtitle.font.size = 10,
               data_row.padding = px(1),
               column_labels.font.weight = "bold",
               column_labels.padding = px(10), 
               table.font.names = 'montserrat',
               table.font.size = 8) %>%
    tab_style(style = list(cell_text(align = "center",
                                     weight = 'bold')),
              locations = list(cells_title(groups = c("title")))) %>%
     sub_missing(columns = everything(), missing_text = "0") %>%
      tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
       as_raw_html()
```

### Gr치ficos {.tabset .tabset-pills}

#### ChordDiagram 

Se filtran los flujos migratorios que son exclusivos de los estados y que visualmente sean m치s interpretables.

```{r, results = FALSE, eval = FALSE}
# Matriz cuadrada a nivel municipal 
load(paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel municipal 2020.RData"))

rownames <- rownames(Migrantes) %>% 
             as.data.frame() %>%
              rename("CVE_MUN" = ".") %>%
               left_join(., MUN %>% select(CVE_MUN, NOM_MUN)) %>%
                mutate(CVE_MUN = stringr::str_wrap(paste(.$CVE_MUN, .$NOM_MUN), 100)) %>%
                 pull(CVE_MUN)

colnames <- colnames(Migrantes) %>% 
             as.data.frame() %>%
              rename("CVE_MUN" = ".") %>%
               left_join(., MUN %>% select(CVE_MUN, NOM_MUN)) %>%
                mutate(CVE_MUN = stringr::str_wrap(paste(.$CVE_MUN, .$NOM_MUN), 100)) %>%
                 pull(CVE_MUN)

rownames(Migrantes) <- rownames
colnames(Migrantes) <- colnames

# Nombre de los estados 
estado <- stringr::str_wrap(nom_estados, 100)

# Clave de los municipios 
### Municipios que no pertenecen en la muestra
municipios_nomuestra <- c("004012", "007125", "029048")

municipios <- MUN %>% 
               filter(CVE_MUN %nin% municipios_nomuestra) %>%
                mutate(municipios = stringr::str_wrap(paste(.$CVE_MUN, .$NOM_MUN), 100)) %>%
                 pull(municipios)

################################################################################
################################## Filtro ######################################
Inmigrantes  <- Migrantes %>%
                 as.data.frame() %>%
                  tibble::rownames_to_column(var = "rn") %>% 
                   melt(., id.vars = "rn", variable.name = "cn") %>%
                    mutate_if(is.factor, as.character) %>%
                     mutate(value = ifelse((.$rn != .$cn) & (.$rn %in% municipios | .$cn %in% municipios), value, 0)) %>%
                      filter(value > 0) %>%
                       group_by(rn) %>% 
                        summarise(Inmigrantes = sum(value, na.rm = TRUE)) 

Emigrantes <- Migrantes %>%
               as.data.frame() %>%
                tibble::rownames_to_column(var = "rn") %>% 
                 melt(., id.vars = "rn", variable.name = "cn") %>%
                  mutate_if(is.factor, as.character) %>%
                   mutate(value = ifelse((.$rn != .$cn) & (.$rn %in% municipios | .$cn %in% municipios), value, 0)) %>%
                    filter(value > 0) %>%
                     group_by(cn) %>% 
                      summarise(Emigrantes = sum(value, na.rm = TRUE))     

################################## Filtro ######################################
filtro  <- Inmigrantes %>%
            full_join(., Emigrantes, by = c("rn" = "cn")) %>%
             mutate(value = sum_row(Inmigrantes, Emigrantes, na.rm = TRUE))

filtro_est <- Migrantes %>%
               as.data.frame() %>%
                tibble::rownames_to_column(var = "rn") %>% 
                 melt(., id.vars = "rn", variable.name = "cn") %>%
                  mutate_if(is.factor, as.character) %>%
                   filter(value > 0)

### Sacar el promedio de los flujos migratiorios para determinar como se van a grupar los estados 
#### Es importante correr la tabla1[[x]] sin filtros para determinar el n칰mero promedio de flujos de migraci칩n
#### Filtro <<<<< filter(value < 0) %>% 
#p <- data.frame(estados = est,
 #               filtro_municipio = filtro_mig,
  #              filtro_estado = filtro_out)
#write.xlsx(p, file = paste0(here::here(), "/Bases/Municipio/04_Movilidad estudiantil/2020/Filtro a nivel municipal.xlsx"), overwrite = TRUE)

#### Filtro de municipios
filtro_mig <- read.xlsx(paste0(here::here(), "/Bases/Municipio/04_Movilidad estudiantil/2020/Filtro a nivel municipal.xlsx"), colNames = TRUE) %>%
               pull(filtro_municipio)

#### Filtro de estados 
filtro_out <- read.xlsx(paste0(here::here(), "/Bases/Municipio/04_Movilidad estudiantil/2020/Filtro a nivel municipal.xlsx"), colNames = TRUE) %>%
               pull(filtro_estado)

tabla <- Migrantes %>%
          as.data.frame() %>%
           sna::diag.remove(remove.val = 0) %>%
            melt(., id.vars = "rn", variable.name = "cn") %>%
             mutate(Var1 = str_pad(.$Var1, width = 6, side = c("left"), pad = "0"),
                    Var2 = str_pad(.$Var2, width = 6, side = c("left"), pad = "0")) %>%
              rename("rn" = "Var1", 
                     "cn" = "Var2") %>%
               filter(value > 0)

## Se generan los filtros correspondientes a la matriz cuadrada por estados 
tabla1 <-  lapply(1:32, function(x){
                         # filtro de municipios
                         filtro <- filtro %>%
                                    filter(substr(.$rn, 1, 3) == estados[x]) %>%
                                     filter(value < filtro_mig[x]) %>%
                                      pull(rn)
                         
                         # filtro de estados
                         filtro_rn  <- filtro_est %>%
                                        mutate(value = ifelse(substr(.$rn, 1, 3) == estados[x] | substr(.$cn, 1, 3) == estados[x], value, 0)) %>%
                                         mutate(rn = substr(.$rn, 1, 3)) %>%
                                          group_by(rn) %>%
                                           summarise(Inm = sum(value, na.rm = TRUE))

                         filtro_cn  <- filtro_est %>%
                                        mutate(value = ifelse(substr(.$rn, 1, 3) == estados[x] | substr(.$cn, 1, 3) == estados[x], value, 0)) %>%
                                         mutate(cn = substr(.$cn, 1, 3)) %>%
                                          group_by(cn) %>%
                                           summarise(Emg = sum(value, na.rm = TRUE))

                         filtro_estados <- filtro_rn %>%
                                            full_join(., filtro_cn, by = c("rn" = "cn")) %>%
                                             mutate(value = sum_row(.$Inm, .$Emg, na.rm = TRUE)) %>%
                                              filter(value > filtro_out[x] & rn != estado[x]) %>%
                                               pull(rn)
                         tabla %>%
                         # Se reestructura la clave de municipios y se seleccionan solo los municipios que superan el filtro de municipios
                           # Se reestructuran a los municipios que superan al filtro de estados
                          mutate(rn = case_when(.$rn %in% filtro ~ paste0(estados[x], " Otros municipios"), 
                                                substr(.$rn, 1, 3) %in% estados[x] & .$rn %nin% filtro ~ .$rn, 
                                                substr(.$rn, 1, 3) %nin% estados[x] & substr(.$rn, 1, 3) %in% filtro_estados ~ str_wrap(paste0(nom_estados[as.numeric(substr(.$rn, 1, 3))]), 50),
                                                substr(.$rn, 1, 3) %nin% estados[x] & substr(.$rn, 1, 3) %nin% filtro_estados ~ "Otros estados"),
                                 cn = case_when(.$cn %in% filtro ~ paste0(estados[x], " Otros municipios"), 
                                                substr(.$cn, 1, 3) %in% estados[x] & .$cn %nin% filtro ~ .$cn, 
                                                substr(.$cn, 1, 3) %nin% estados[x] & substr(.$cn, 1, 3) %in% filtro_estados ~ str_wrap(paste0(nom_estados[as.numeric(substr(.$cn, 1, 3))]), 50),
                                                substr(.$cn, 1, 3) %nin% estados[x] & substr(.$cn, 1, 3) %nin% filtro_estados ~ "Otros estados"))  %>%
                          # Se seleccionan los valores de la entidad seleccionada
                           mutate(value = ifelse(substr(.$rn, 1, 3) %in% estados[x] | substr(.$cn, 1, 3) %in% estados[x], value, 0)) %>% 
                            filter(value > 0) %>%
                             dcast(., rn ~ cn, value.var = "value", sum,  na.rm = TRUE) %>%
                              column_to_rownames(., var = "rn") 
  }
)

## Se sacan los flujos migratorios que pertencen a otros estados
#tabla_estados <- sapply(1:32, function(i){
#                                tabla1[[i]] %>%
#                                 as.data.frame() %>%
#                                  adorn_totals(c("row", "col"), 
#                                                fill = "-", 
#                                                 na.rm = TRUE, 
#                                                  ,,,,contains(colnames(tabla1[[i]]))) %>% 
#                                    select(`Otros estados`) %>%
#                                     slice(nrow(.)) %>%
#                                      mutate(`Otros estados` = .$`Otros estados`/30) %>%
#                                       pull(`Otros estados`)
#})

## Se sacan los flujos migratorios que pertencen a otros municipios
#tabla_municipios <- sapply(1:32, function(i){
#                                   tabla1[[i]] %>%
#                                    as.data.frame() %>%
#                                     select(-c(`Otros estados`)) %>%
#                                      adorn_totals(c("row", "col"), 
#                                                    fill = "-", 
#                                                     na.rm = TRUE, 
#                                                      ,,,,contains(colnames(tabla1[[i]]))) %>% 
#                                       slice(nrow(.)) %>%
#                                        mutate(Total = .$Total/50) %>%
#                                        pull(Total)
#})

## Se guardan las matrices de movilidad estudiantil para analizarlos despu칠s. 
wb <- createWorkbook()
for(i in 1:32){
     tabla <- tabla1[[i]] %>%
                as.data.frame() %>%
                 adorn_totals(c("row", "col"), 
                               fill = "-", 
                                na.rm = TRUE, 
          ,,,,contains(colnames(tabla1[[i]])))
                 
     addWorksheet(wb, paste(est[i]))
     writeData(wb, i, tabla, colNames = TRUE, rowNames = TRUE)
     saveWorkbook(wb, 
                  file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz MEst a nivel municipal_Reduccion.xlsx"), 
               overwrite = TRUE)
}

saveRDS(tabla1, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Tabla MEst a nivel municipal.RDS"))
```

```{r tablas de matrices}
tabla1 <- readRDS(file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Tabla MEst a nivel municipal.RDS"))

totales <- lapply(1:length(estados), function(x){
                #Se agrupan los totales
                 full_join( 
                           tabla1[[x]] %>%
                            as.data.frame() %>%
                             adorn_totals(c("row", "col"), 
                                          fill = "-", 
                                          na.rm = TRUE, 
                                           ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                              slice(nrow(.)) %>% 
                               t() %>%
                                as.data.frame()%>%
                                 rownames_to_column(var = "name")  %>% 
                                  rename("Total_Filas" = "1"),
                           tabla1[[x]] %>%
                            as.data.frame() %>%
                             adorn_totals(c("row", "col"), 
                                          fill = "-", 
                                          na.rm = TRUE, 
                                           ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                              rownames_to_column(var = "name") %>%
                               select(name, Total) %>%
                                mutate(name = str_replace(.$name, "1$", "Total")), 
                           by = c("name")
                           ) %>%
                           rename("CVE_MUN" = "name",
                                  "Entran por trabajo" = "Total_Filas", # Poblaci칩n que entra a la entidad para trabajar
                                  "Salen por trabajo" = "Total") %>% # Poblaci칩n que sale de su entidad de residencia y entra a otra demarcaci칩n por motivos de trabajo
                            select(`Entran por trabajo`, CVE_MUN, `Salen por trabajo`)
  }
)
porcentajes <- lapply(1:length(estados), function(x){
                           #Se agrupan los porcentajes
                           full_join(
                                     tabla1[[x]] %>%
                                      as.data.frame() %>%
                                       adorn_totals(c("col", "row"), 
                                                    fill = "0", 
                                                    na.rm = TRUE, 
                                                    name = "Total",
                                                    ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                        adorn_percentages("col",
                                                          na.rm = TRUE) %>% 
                                         rownames_to_column(var = "name") %>%
                                          select(name, Total) %>%
                                           mutate(name = str_replace(.$name, "1$", "Total")),
                                     tabla1[[x]] %>%
                                      as.data.frame() %>%
                                       adorn_totals(c("row"), 
                                                    fill = "0", 
                                                    na.rm = TRUE, 
                                                    name = "Total", 
                                                    ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                        adorn_percentages("row", 
                                                          na.rm = TRUE, 
                                                         ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                         slice(nrow(.)) %>% 
                                          t() %>%
                                           as.data.frame()%>%
                                            rownames_to_column(var = "name")  %>% 
                                             rename("Total_Filas" = "1"), 
                                     by = c("name")
                                          ) %>%
                                     rename("CVE_MUN" = "name",
                                            "Entran por trabajo%" = "Total_Filas", # Poblaci칩n que entra a la entidad para trabajar
                                            "Salen por trabajo%" = "Total") %>% # Poblaci칩n que sale de su entidad de residencia y entra a otra demarcaci칩n por motivos de trabajo
                                      select(`Entran por trabajo%`, CVE_MUN, `Salen por trabajo%`)
                                   
  }
)

# Se guardan los totales de las matrices reducidas 
wb <- createWorkbook()
for(i in 1:32){
     addWorksheet(wb, paste(est[i]))
     writeData(wb, i, totales[[i]], colNames = TRUE, startCol = 1)
     writeData(wb, i, porcentajes[[i]], colNames = TRUE, startCol = 5)
     saveWorkbook(wb, 
                  file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz MEst a nivel municipal_Reduccion_Totales.xlsx"), 
               overwrite = TRUE)
}
```

**Dada la magnitud de municipios en algunos estados se seleccionan solo algunos de ellos.**

```{r}
tabla1 <- readRDS(file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Tabla MEst a nivel municipal.RDS"))

# Paleta de colores
#paleta <- rev(colorRampPalette(wesanderson::wes_palette("Rushmore1"))(50)) 
paleta <- colorRampPalette(c("#000C7D", "#001599", "#0022B0", "#0035BB", "#004AB4", "#005EA3", "#00708D", "#078472","#3E9A85", "#49A980", "#58B877", "#70C669", "#94D25D", "#BBDA60", "#DEE53E", "#DBCE33", "#D6B92A", "#D1A521", "#CA911A"))(50)

tabla2 <- lapply(1:length(estados), function(x){ 
                    # Paleta de colores
                       groupColors <- setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))))),
                                               nm = str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))
                        circos.clear()
                         chordDiagram(x  = tabla1[[x]] %>% as.matrix(), 
                                       transparency = 0.4,
                                        order = str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE),
                                         grid.col = groupColors)  %>% 
                          pull(col)
  }
)
```

```{r grafico municipal, eval = FALSE, results='hide'}
cairo_pdf(paste0(here::here(), "/Graficos/Municipio/04_Movilidad estudiantil/2020/ChordDiagram de MEst desagregado por estado.pdf"),
          width = 15,
          height = 10, 
          family = "Montserrat Medium",
          fallback_resolution = 400,
          onefile = TRUE)
for(i in 1:length(estados)){
# Paleta de colores
groupColors <- setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]]))))),
                        nm = str_sort(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]]))), numeric = TRUE))

circos.clear()
circos.par(start.degree = 90, 
           gap.degree = 2, 
           clock.wise = FALSE,
           #track.margin = c(-0.07, 0.07),  # c칤rculo exterior | circulo interior
           track.margin = c(-0.07, 0.1),
           points.overflow.warning = FALSE)

par(mar = rep(0, 4))

chordDiagram(x  =  tabla1[[i]] %>% as.matrix(), 
             grid.col = groupColors,
             col = tabla2[[i]],
             order = str_sort(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]])))),
             keep.diagonal = FALSE,
             transparency =  0,
             directional = 1,
             direction.type = c("arrows", "diffHeight"), 
             diffHeight  = -0.04, # adjust the starting end of the link
             annotationTrack = "grid", 
             annotationTrackHeight = c(0.05, 0.1),
             preAllocateTracks = 1, 
             big.gap = 40, # Gap between row sectors and column sectors.
             link.arr.type = "big.arrow", 
             link.lwd = 3,    # Line width width for link borders
             link.lty = 1,
             link.visible = TRUE,
             link.largest.ontop = TRUE)

# Add text and axis
circos.trackPlotRegion(track.index = 1,
                       track.height = 0.05,
                       bg.border = NA, 
                       panel.fun = function(x, y) {
                                                   xlim = get.cell.meta.data("xlim")
                                                   ylim = get.cell.meta.data("ylim")
                                                   sector.name = get.cell.meta.data("sector.index")
                                                  # Add names to the sector. 
                                                   circos.text(x = mean(xlim), 
                                                               y = ylim[1] + 0.1, 
                                                               labels = sector.name, 
                                                               facing = "clockwise",
                                                               niceFacing = TRUE, 
                                                               adj = c(-0.05, 0.5), #Ajuste de las etiquetas (x, y)
                                                               cex = fontsize(9),
                                                               col = "#000C7D",
                                                               font = 1)
                                                  # Add graduation on axis
                                                   circos.axis(h = "top",
                                                               labels = c(0, 10, 20, 50, 100, 200, 300, 400, 500, seq(1000, 200000, by = 1000)),
                                                               major.tick.length = 0.5,
                                                               minor.ticks = 4, 
                                                               labels.cex = fontsize(6),
                                                               sector.index = sector.name,
                                                               track.index = 2,
                                                               labels.niceFacing = TRUE,
                                                               labels.pos.adjust = c(0, 0.8))
                                                }
  )
}
dev.off()
```

**Etiquetas**

```{r etiquetas_municipal}
etiquetas  <- lapply(1:length(estados), function(x){
                        p <-  tabla1[[x]] %>% 
                               as.data.frame() %>%
                                tibble::rownames_to_column(var = "rn") %>%
                                 melt(., id.vars = "rn", variable.name = "cn") %>%
                                  as.data.frame() %>% 
                                   mutate(rn = str_wrap(.$rn, 100),
                                          cn = str_wrap(.$cn, 100)) %>%
                                    ggplot() + 
                                     geom_bar(aes(x = value, fill = rn))  + 
                                      geom_bar(aes(x = value, fill = cn))  + 
                                       theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                                             text = element_text(family = "Montserrat Medium"),
                                             axis.text = element_blank(),
                                             axis.title = element_blank(),
                                             strip.text = element_text(size = 9, face = "bold", family = "Montserrat Medium"),  
                                             legend.key.size = unit(0.4, "cm"), 
                                             legend.spacing.y = unit(0.4, "cm"),
                                             legend.text = element_text(size = 7, family = "Montserrat Medium"),
                                             legend.title = element_text(size = 8 , family = "Montserrat Medium")) + 
                                        scale_fill_manual(values = colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]])))))) + 
                                         guides(fill = guide_legend(ncol = 1)) + 
                                          labs(fill = stringr::str_wrap(paste(estado[x]), 100),
                                               color = stringr::str_wrap(paste(estado[x]), 100))
                         leg <- get_legend(p)
                         as_ggplot(leg)
 })

cairo_pdf(paste0(here::here(), "/Graficos/Municipio/04_Movilidad estudiantil/2020/Etiquetas a nivel municipal.pdf"), 
          width = 7, height = 10, 
          fallback_resolution = 400,
          family = "montserrat", onefile = TRUE)
for(i in 1:length(estados)){
  print(etiquetas[i])
}
dev.off()
```


### Indicadores {.tabset .tabset-pills}

Se realizan c치lculos generales de movilidad\
+ Residentes\
+ Inmigrantes\
+ Emigrantes\
+ $\%$ Inmigrantes\
+ $\%$ Emigrante\
+ Migraci칩n bruta\
+ Migraci칩n Neta\
+ $\%$ Tasa de movilidad bruta\
+ $\%$ Tasa de movilidad neta

Dada la cantidad de datos a calcular para la obtenci칩n de los indicadores. La obtenci칩n de los indicadores se realiza de manera directa, es decir, partiendo de la matriz cuadrada original.

```{r, eval = FALSE}
################################################################################
############################ Poblaci칩n total ###################################
Pob.Total <- mydata %>%
              as.data.frame() %>%
               group_by(CVE_MUN) %>%
                summarise(Pob.Total = sum(FACTOR)) 

################################################################################
###################### Pob. estudiantil de 3 a침os y m치s ########################
Pob.3ymas <- mydata %>%
              as.data.frame() %>%
               mutate(EDAD = as.numeric(.$EDAD)) %>%
                subset(EDAD >= 3 & EDAD <= 130) %>%
                 group_by(CVE_MUN) %>%
                  summarise(Pob.3ymas = sum(FACTOR)) 

################################################################################
########################### Residentes #########################################
load(paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel municipal 2020.RData"))

Residentes <- Migrantes %>%
               rownames_to_column() %>%
                gather(CVE_MUN, Value ,-rowname)%>%
                 filter(rowname == CVE_MUN) %>%
                  select(-rowname) %>%
                   droplevels() %>%
                    rename("Residentes" = "Value") 

################################################################################
############################### Inmigrantes ####################################
Inmigrantes <- Migrantes %>% 
                as.data.frame() %>%
                 tibble::rownames_to_column(var = "CVE_MUN") %>%
                  melt(., id.vars = "CVE_MUN", variable.name = "CVE_MUN_ASI") %>%
                   mutate_at(vars(3), as.numeric) %>%
                    as_tibble() %>%
                     filter(CVE_MUN != CVE_MUN_ASI) %>%
                      group_by(CVE_MUN) %>%
                       summarise(Inmigrantes = sum(value, na.rm = TRUE))

################################################################################
############################### Emigrantes #####################################

## Poblaci칩n que entra a la entidad para estudiar 
Emigrantes <- Migrantes %>% 
               as.data.frame() %>%
                tibble::rownames_to_column(var = "CVE_MUN") %>%
                 melt(., id.vars = "CVE_MUN", variable.name = "CVE_MUN_ASI") %>%
                  mutate_at(vars(3), as.numeric) %>%
                   as_tibble() %>%
                    filter(CVE_MUN != CVE_MUN_ASI) %>%
                     group_by(CVE_MUN_ASI) %>%
                      summarise(Emigrantes = sum(value, na.rm = TRUE)) %>%
                       rename("CVE_MUN" = "CVE_MUN_ASI") 

tabla <- Pob.Total %>%
          left_join(., Pob.3ymas, by = c("CVE_MUN")) %>%
          left_join(., Residentes, by = c("CVE_MUN")) %>%
          left_join(., Inmigrantes, by = c("CVE_MUN")) %>%
          left_join(., Emigrantes, by = c("CVE_MUN")) %>%
            mutate(Mig.Neta = .$Inmigrantes - .$Emigrantes,
                   Mig.Bruta = .$Inmigrantes + .$Emigrantes, 
                   Tasa.Inmig = ((.$Inmigrantes/ 5) /((.$Pob.Total + .$Pob.3ymas) / 2)) * 1000,
                   Tasa.Emig = ((.$Emigrantes/ 5) /((.$Pob.Total + .$Pob.3ymas) / 2)) * 1000,
                   Tasa.Mig = Tasa.Inmig - Tasa.Emig, 
                   Eficacia = Mig.Neta - Mig.Bruta)

write.xlsx(tabla, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Indicadores de movilidad estudiantil a nivel municipal 2020.xlsx"), overwrite = TRUE)

save(tabla, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Indicadores de movilidad estudiantil a nivel municipal 2020.RData"))
```

```{r, echo = FALSE}
load(file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Indicadores de movilidad estudiantil a nivel municipal 2020.RData"))

tabla[1:20,] %>%  
 as.data.frame() %>%
  gt() %>% 
   tab_header(title = "Indicadores de  movilidad estudiantil", 
              subtitle = "Nivel municipal") %>%
    tab_options(heading.title.font.size = 12, 
                heading.align = "center",
                heading.subtitle.font.size = 10,
                data_row.padding = px(1),
                column_labels.font.weight = "bold",
                column_labels.padding = px(10), 
                table.font.names = 'montserrat',
                table.font.size = 8) %>%
      tab_style(style = list(cell_text(align = "center",
                                       weight = 'bold')),
                locations = list(cells_title(groups = c("title")))) %>%
       fmt_integer(columns = c(2:8, 12), sep_mark = " ") %>%
        fmt_number(columns = c(11), decimals = 1) %>%
         sub_missing(columns = everything(), missing_text = "0") %>%
          tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
           as_raw_html()
```


## Movilidad intramunicipal {.tabset .tabset-pills}

### Matrices 

```{r, eval = FALSE}
### Municipios que no pertenecen en la muestra
municipios_nomuestra <- c("004012", "007125", "029048")

#Clave de los municipios 2020 
municipios <- MUN %>%
               select(CVE_MUN) %>%
                unique() %>%
                 filter(CVE_MUN %nin% municipios_nomuestra) %>%
                  pull(CVE_MUN)

Pob.3ymas <- mydata %>%
              mutate(CVE_MUN_ASI = paste0(ENT_PAIS_ASI, MUN_ASI)) %>%
               mutate(ENT_PAIS_ASI = case_when(.$ENT_PAIS_ASI %in% estados ~.$ENT_PAIS_ASI,
                                               .$ENT_PAIS_ASI %nin% estados ~ "888", #Residencia en otro pa칤s
                                               .$ENT_PAIS_ASI %in% "997" ~ "997",
                                               .$ENT_PAIS_ASI %in% "998" ~ "998",
                                               .$ENT_PAIS_ASI %in% "997" ~ "999"),
                      CVE_MUN_ASI = case_when(.$CVE_MUN_ASI %in% municipios ~.$CVE_MUN_ASI,
                                             #### Se excluyen los municipios que no fueron muestreados
                                              .$CVE_MUN_ASI %in% municipios_nomuestra ~ "777",
                                               nchar(.$CVE_MUN_ASI) == 3 ~ "888",  #Asistencia escolar en otro pa칤s
                                              .$CVE_MUN_ASI %in% "997999" ~ '997999',
                                              .$ENT_PAIS_ASI %in% "997" ~ "997",
                                              .$ENT_PAIS_ASI %in% "998" ~ "998",
                                              .$ENT_PAIS_ASI %in% "999" ~ "999",
                                              .$MUN_ASI %in% "999" ~ "999")) %>%
                mutate(I_Migracion = case_when(.$CVE_ENT == .$ENT_PAIS_ASI & .$ENT_PAIS_ASI %in% estados ~ 1,
                                               .$CVE_ENT != .$ENT_PAIS_ASI & .$ENT_PAIS_ASI %in% estados ~ 2,
                                               .$ENT_PAIS_ASI %nin% estados ~ 3)) %>%
                 mutate(EDAD = as.numeric(.$EDAD)) %>%
                  subset(EDAD >= 3 & EDAD <= 130) %>%
                   select(FACTOR, ESTRATO, UPM, CVE_MUN, CVE_MUN_ASI, EDAD, I_Migracion) %>%
                    filter(CVE_MUN_ASI %in% municipios & I_Migracion == 1) 

MC <- Pob.3ymas %>%
       svydesign(data = ., id = ~ UPM, strata = ~ESTRATO, weight = ~FACTOR, nest = T)

saveRDS(MC, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/MC_intramunicipal.RDS"))
```

```{r, eval = FALSE}
MC <- readRDS(file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/MC_intramunicipal.RDS"))

Migrantes <- svytable(~CVE_MUN_ASI + CVE_MUN, design = MC) 
```

Se genera la matriz cuadrada y se le asignan los nombres de los estados.

```{r, eval = FALSE}
Migrantes <- Migrantes %>%
              as.data.frame() %>%
               expss::cross_cases(CVE_MUN, CVE_MUN_ASI, weight = Freq) %>%
                as.data.frame() %>%
                 rename("CVE_MUN" = "row_labels") %>% 
                  arrange(CVE_MUN) %>%
                   slice(-1) 

rownames <- Migrantes %>% 
             mutate(CVE_MUN = substr(.$CVE_MUN, 9, 16)) %>% 
              pull(CVE_MUN)

colnames <- names(Migrantes) %>% 
             as.data.frame() %>% 
              slice(-1) %>% 
               rename("CVE_MUN" = ".") %>%
                mutate(`CVE_MUN` = substr(.$CVE_MUN, 13, 18)) %>%
                 pull(CVE_MUN)

# Se elimina la variable CVE_MUN
Migrantes <- Migrantes %>%
              select(-CVE_MUN)

rownames(Migrantes) <- rownames 
colnames(Migrantes) <- colnames

saveRDS(Migrantes, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel intramunicipal 2020.RDS"))
save(Migrantes, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel intramunicipal 2020.RData"))

require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "M.Intramunicipal")
writeData(wb, 1, Migrantes %>% as.data.frame() %>% tibble::rownames_to_column(var = "CVE_MUN"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(), "/Bases/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel intramunicipal 2020.xlsx"), overwrite = TRUE)
```

**Matriz de movilidad estudiantil hace 5 a침os a nivel municipal, 2015 - 2020**

<div style="height:500px;overflow:auto;">

```{r, echo = FALSE}
load(paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel intramunicipal 2020.RData"))

tabla <- Migrantes %>%
          as.data.frame() %>%
           tibble::rownames_to_column(var = "CVE_MUN") %>%
            mutate_if(is.numeric, as.numeric)

tabla[1:30, 1:30] %>%  
 gt() %>% 
  tab_header(title = "Matriz de movilidad estudiantil", 
             subtitle = "Nivel intramunicipal") %>%
   tab_options(heading.title.font.size = 12, 
               heading.align = "center",
               heading.subtitle.font.size = 10,
               data_row.padding = px(1),
               column_labels.font.weight = "bold",
               column_labels.padding = px(10), 
               table.font.names = 'montserrat',
               table.font.size = 8) %>%
    tab_style(style = list(cell_text(align = "center",
                                     weight = 'bold')),
              locations = list(cells_title(groups = c("title")))) %>%
     sub_missing(columns = everything(), missing_text = "0") %>%
      tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
       as_raw_html()
```

### Gr치ficos {.tabset .tabset-pills}

#### ChordDiagram 

Se filtran los flujos migratorios que son exclusivos de los estados y que visualmente sean m치s interpretables.

```{r, results = FALSE, eval = FALSE}
# Matriz cuadrada a nivel municipal 
load(paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel intramunicipal 2020.RData"))

rownames <- rownames(Migrantes) %>% 
             as.data.frame() %>%
              rename("CVE_MUN" = ".") %>%
               left_join(., MUN %>% select(CVE_MUN, NOM_MUN)) %>%
                mutate(CVE_MUN = stringr::str_wrap(paste(.$CVE_MUN, .$NOM_MUN), 100)) %>%
                 pull(CVE_MUN)

colnames <- colnames(Migrantes) %>% 
             as.data.frame() %>%
              rename("CVE_MUN" = ".") %>%
               left_join(., MUN %>% select(CVE_MUN, NOM_MUN)) %>%
                mutate(CVE_MUN = stringr::str_wrap(paste(.$CVE_MUN, .$NOM_MUN), 100)) %>%
                 pull(CVE_MUN)

rownames(Migrantes) <- rownames
colnames(Migrantes) <- colnames

# Nombre de los estados 
estado <- stringr::str_wrap(nom_estados, 100)

# Clave de los municipios 
### Municipios que no pertenecen en la muestra
municipios_nomuestra <- c("004012", "007125", "029048")

municipios <- MUN %>% 
               filter(CVE_MUN %nin% municipios_nomuestra) %>%
                mutate(municipios = stringr::str_wrap(paste(.$CVE_MUN, .$NOM_MUN), 100)) %>%
                 pull(municipios)


################################################################################
################################## Filtro ######################################
Inmigrantes  <- Migrantes %>%
                 as.data.frame() %>%
                  tibble::rownames_to_column(var = "rn") %>% 
                   melt(., id.vars = "rn", variable.name = "cn") %>%
                    mutate_if(is.factor, as.character) %>%
                     mutate(value = ifelse((.$rn != .$cn) & (substr(.$rn, 1, 3) %in% estados | substr(.$cn, 1, 3) %in% estados), value, 0)) %>%
                      filter(value > 0) %>%
                       group_by(rn) %>% 
                        summarise(Inmigrantes = sum(value, na.rm = TRUE)) 

Emigrantes <- Migrantes %>%
               as.data.frame() %>%
                tibble::rownames_to_column(var = "rn") %>% 
                 melt(., id.vars = "rn", variable.name = "cn") %>%
                  mutate_if(is.factor, as.character) %>%
                   mutate(value = ifelse((.$rn != .$cn) & (substr(.$rn, 1, 3) %in% estados | substr(.$cn, 1, 3) %in% estados), value, 0)) %>%
                    filter(value > 0) %>%
                     group_by(cn) %>% 
                      summarise(Emigrantes = sum(value, na.rm = TRUE))   

### Sacar el promedio de los flujos migratiorios para determinar como se van a grupar los estados 
#### Es importante correr la tabla1[[x]] sin filtros para determinar el n칰mero promedio de flujos de migraci칩n
#### Filtro <<<<< filter(value < 0) %>% 
#p <- data.frame(estados = est,
 #               filtro_municipio = filtro_mig)
#write.table(p, file = paste0(here::here(), "/Bases/Municipio/04_Movilidad estudiantil/2020/Filtro a nivel intramunicipal.txt"), col.names = TRUE)
#write.xlsx(p, file = paste0(here::here(), "/Bases/Municipio/04_Movilidad estudiantil/2020/Filtro a nivel intramunicipal.xlsx"), overwrite = TRUE)

#### Filtro de municipios
filtro_mig <- read.xlsx(paste0(here::here(), "/Bases/Municipio/04_Movilidad estudiantil/2020/Filtro a nivel intramunicipal.xlsx"), colNames = TRUE) %>%
               pull(filtro_municipio)

################################################################################
## Se generan los filtros correspondientes a la matriz cuadrada por estados 
tabla <- Migrantes %>%
          as.data.frame() %>%
           tibble::rownames_to_column(var = "rn") %>%
            melt(., id.vars = "rn", variable.name = "cn") %>%
             mutate_if(is.factor, as.character) %>%
              filter(value > 0)

tabla1 <-  lapply(1:32, function(x){
                   filtro  <- Inmigrantes %>%
                               full_join(., Emigrantes, by = c("rn" = "cn")) %>%
                                mutate(value = sum_row(Inmigrantes, Emigrantes, na.rm = TRUE)) %>%
                                 filter(value < filtro_mig[x]) %>% 
                                  pull(rn)
                   tabla %>%
                    mutate(rn = case_when(substr(.$rn, 1, 3) %in% estados[x] & .$rn %in% filtro ~ paste0("Otros municipios (", estados[x], ")"),
                                          substr(.$rn, 1, 3) %in% estados[x]  & .$rn %nin% filtro ~ .$rn,
                                          substr(.$rn, 1, 3) %nin% estados[x] ~ substr(.$rn, 1, 3)),
                           cn = case_when(substr(.$cn, 1, 3) %in% estados[x] & .$cn %in% filtro ~ paste0("Otros municipios (", estados[x], ")"),
                                          substr(.$cn, 1, 3) %in% estados[x] & .$cn %nin% filtro ~ .$cn,
                                          substr(.$cn, 1, 3) %nin% estados[x] ~ substr(.$cn, 1, 3))) %>%
                     mutate(value = ifelse(.$rn != .$cn, .$value, 0)) %>%
                      filter(value > 0) %>%
                       dcast(., rn ~ cn, value.var = "value", sum,  na.rm = TRUE) %>%
                        column_to_rownames(., var = "rn") 
  }
)

################################################################################
#tabla_municipios <- sapply(1:32, function(x)
#                                   tabla1[[x]] %>%
#                                     as.data.frame() %>%
#                                      adorn_totals(c("col"), 
#                                                    fill = "-", 
#                                                     na.rm = TRUE, 
#                                                      ,,,,contains(rownames(tabla1[[x]]))) %>%
#                                        select(Total) %>% 
#                                         summarise(mean = mean(Total)) %>%
#                                          pull(mean))

## Se sacan los flujos migratorios que pertencen a otros municipios

## Se guardan las matrices de movilidad estudiantil para analizarlos despu칠s. 
wb <- createWorkbook()
for(i in 1:32){
         tabla <- tabla1[[i]] %>%
                    as.data.frame() %>%
                     adorn_totals(c("row", "col"), 
                                   fill = "-", 
                                    na.rm = TRUE, 
              ,,,,contains(colnames(tabla1[[i]])))
                     
         addWorksheet(wb, paste(est[i]))
         writeData(wb, i, tabla, colNames = TRUE, rowNames = TRUE)
         saveWorkbook(wb, 
                      file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz MEst nivel intramunicipal_Reduccion.xlsx"), 
                   overwrite = TRUE)
}

saveRDS(tabla1, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Tabla MEst a nivel intramunicipal.RDS"))
```

```{r tablas de matrices}
tabla1 <- readRDS(file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Tabla MEst a nivel intramunicipal.RDS"))

totales <- lapply(1:length(estados), function(x){
                #Se agrupan los totales
                 full_join(
                           tabla1[[x]] %>%
                            as.data.frame() %>%
                             adorn_totals(c("row", "col"), 
                                          fill = "-", 
                                          na.rm = TRUE, 
                                           ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                              slice(nrow(.)) %>% 
                               t() %>%
                                as.data.frame()%>%
                                 rownames_to_column(var = "name")  %>% 
                                  rename("Total_Filas" = "1"),
                           tabla1[[x]] %>%
                            as.data.frame() %>%
                             adorn_totals(c("row", "col"), 
                                          fill = "-", 
                                          na.rm = TRUE, 
                                           ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                              rownames_to_column(var = "name") %>%
                               select(name, Total) %>%
                                mutate(name = str_replace(.$name, "1$", "Total")), 
                           by = c("name")
                           ) %>%
                           rename("CVE_MUN" = "name",
                                  "Entran por trabajo" = "Total_Filas", # Poblaci칩n que entra a la entidad para trabajar
                                  "Salen por trabajo" = "Total") %>% # Poblaci칩n que sale de su entidad de residencia y entra a otra demarcaci칩n por motivos de trabajo
                            select(`Entran por trabajo`, CVE_MUN, `Salen por trabajo`)
  }
)
porcentajes <- lapply(1:length(estados), function(x){
                           #Se agrupan los porcentajes
                           full_join(
                                     tabla1[[x]] %>%
                                      as.data.frame() %>%
                                       adorn_totals(c("col", "row"), 
                                                    fill = "0", 
                                                    na.rm = TRUE, 
                                                    name = "Total",
                                                    ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                        adorn_percentages("col",
                                                          na.rm = TRUE) %>% 
                                         rownames_to_column(var = "name") %>%
                                          select(name, Total) %>%
                                           mutate(name = str_replace(.$name, "1$", "Total")),
                                     tabla1[[x]] %>%
                                      as.data.frame() %>%
                                       adorn_totals(c("row"), 
                                                    fill = "0", 
                                                    na.rm = TRUE, 
                                                    name = "Total", 
                                                    ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                        adorn_percentages("row", 
                                                          na.rm = TRUE, 
                                                         ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                         slice(nrow(.)) %>% 
                                          t() %>%
                                           as.data.frame()%>%
                                            rownames_to_column(var = "name")  %>% 
                                             rename("Total_Filas" = "1"), 
                                     by = c("name")
                                          ) %>%
                                     rename("CVE_MUN" = "name",
                                            "Entran por trabajo%" = "Total_Filas", # Poblaci칩n que entra a la entidad para trabajar
                                            "Salen por trabajo%" = "Total") %>% # Poblaci칩n que sale de su entidad de residencia y entra a otra demarcaci칩n por motivos de trabajo
                                      select(`Entran por trabajo%`, CVE_MUN, `Salen por trabajo%`)
                                   
  }
)

# Se guardan los totales de las matrices reducidas 
wb <- createWorkbook()
for(i in 1:32){
     addWorksheet(wb, paste(est[i]))
     writeData(wb, i, totales[[i]], colNames = TRUE, startCol = 1)
     writeData(wb, i, porcentajes[[i]], colNames = TRUE, startCol = 5)
     saveWorkbook(wb, 
                  file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz MEst nivel intramunicipal_Reduccion_Totales.xlsx"), 
               overwrite = TRUE)
}
```


**Dada la magnitud de municipios en algunos estados se seleccionan solo algunos de ellos.**

```{r, eval = FALSE}
tabla1 <- readRDS(file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Tabla MEst a nivel intramunicipal.RDS"))

# Paleta de colores
#paleta <- rev(colorRampPalette(wesanderson::wes_palette("Rushmore1"))(50)) 
paleta <- colorRampPalette(c("#000C7D", "#001599", "#0022B0", "#0035BB", "#004AB4", "#005EA3", "#00708D", "#078472","#3E9A85", "#49A980", "#58B877", "#70C669", "#94D25D", "#BBDA60", "#DEE53E", "#DBCE33", "#D6B92A", "#D1A521", "#CA911A"))(50)

tabla2 <- lapply(1:length(estados), function(x){ 
                    # Paleta de colores
                       groupColors <- setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))))),
                                               nm = str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))
                        circos.clear()
                         chordDiagram(x  = tabla1[[x]] %>% as.matrix(), 
                                       transparency = 0.4,
                                        order = str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE),
                                         grid.col = groupColors)  %>% 
                          pull(col)
  }
)
```


```{r grafico intramunicipal, eval = FALSE, results='hide'}
cairo_pdf(paste0(here::here(), "/Graficos/Municipio/04_Movilidad estudiantil/2020/ChordDiagram de MEst desagregado a nivel intramunicipal.pdf"),
          width = 15,
          height = 10, 
          family = "Montserrat Medium",
          fallback_resolution = 400,
          onefile = TRUE)
for(i in 1:length(estados)){
# Paleta de colores
groupColors <- setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]]))))),
                        nm = str_sort(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]]))), numeric = TRUE))

circos.clear()
circos.par(start.degree = 90, 
           gap.degree = 2, 
           clock.wise = FALSE,
           #track.margin = c(-0.07, 0.07),  # c칤rculo exterior | circulo interior
           track.margin = c(-0.07, 0.1),
           points.overflow.warning = FALSE)

par(mar = rep(0, 4))

chordDiagram(x  =  tabla1[[i]] %>% as.matrix(), 
             grid.col = groupColors,
             col = tabla2[[i]],
             order = str_sort(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]])))),
             keep.diagonal = FALSE,
             transparency =  0,
             directional = 1,
             direction.type = c("arrows", "diffHeight"), 
             diffHeight  = -0.04, # adjust the starting end of the link
             annotationTrack = "grid", 
             annotationTrackHeight = c(0.05, 0.1),
             preAllocateTracks = 1, 
             big.gap = 40, # Gap between row sectors and column sectors.
             link.arr.type = "big.arrow", 
             link.lwd = 3,    # Line width width for link borders
             link.lty = 1,
             link.visible = TRUE,
             link.largest.ontop = TRUE)

# Add text and axis
circos.trackPlotRegion(track.index = 1,
                       track.height = 0.05,
                       bg.border = NA, 
                       panel.fun = function(x, y) {
                                                   xlim = get.cell.meta.data("xlim")
                                                   ylim = get.cell.meta.data("ylim")
                                                   sector.name = get.cell.meta.data("sector.index")
                                                  # Add names to the sector. 
                                                   circos.text(x = mean(xlim), 
                                                               y = ylim[1] + 0.1, 
                                                               labels = sector.name, 
                                                               facing = "clockwise",
                                                               niceFacing = TRUE, 
                                                               adj = c(-0.05, 0.5), #Ajuste de las etiquetas (x, y)
                                                               cex = fontsize(9),
                                                               col = "#000C7D",
                                                               font = 1)
                                                  # Add graduation on axis
                                                   circos.axis(h = "top",
                                                               labels = c(0, 10, 20, 50, 100, 200, 300, 400, 500, seq(1000, 200000, by = 1000)),
                                                               major.tick.length = 0.5,
                                                               minor.ticks = 4, 
                                                               labels.cex = fontsize(6),
                                                               sector.index = sector.name,
                                                               track.index = 2,
                                                               labels.niceFacing = TRUE,
                                                               labels.pos.adjust = c(0, 0.8))
                                                }
  )
}
dev.off()
```


**Etiquetas**

```{r etiquetas_intramunicipal}
etiquetas  <- lapply(1:length(estados), function(x){
                        p <-  tabla1[[x]] %>% 
                               as.data.frame() %>%
                                tibble::rownames_to_column(var = "rn") %>%
                                 melt(., id.vars = "rn", variable.name = "cn") %>%
                                  as.data.frame() %>% 
                                   mutate(rn = str_wrap(.$rn, 100),
                                          cn = str_wrap(.$cn, 100)) %>%
                                    ggplot() + 
                                     geom_bar(aes(x = value, fill = rn))  + 
                                      geom_bar(aes(x = value, fill = cn))  + 
                                       theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                                             text = element_text(family = "Montserrat Medium"),
                                             axis.text = element_blank(),
                                             axis.title = element_blank(),
                                             strip.text = element_text(size = 9, face = "bold", family = "Montserrat Medium"),  
                                             legend.key.size = unit(0.4, "cm"), 
                                             legend.spacing.y = unit(0.4, "cm"),
                                             legend.text = element_text(size = 7, family = "Montserrat Medium"),
                                             legend.title = element_text(size = 8 , family = "Montserrat Medium")) + 
                                        scale_fill_manual(values = colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]])))))) + 
                                         guides(fill = guide_legend(ncol = 1)) + 
                                          labs(fill = stringr::str_wrap(paste(estado[x]), 100),
                                               color = stringr::str_wrap(paste(estado[x]), 100))
                         leg <- get_legend(p)
                         as_ggplot(leg)
 })

cairo_pdf(paste0(here::here(), "/Graficos/Municipio/04_Movilidad estudiantil/2020/Etiquetas a nivel intramunicipal.pdf"), 
          width = 7, height = 8, 
          fallback_resolution = 400,
          family = "montserrat", onefile = TRUE)
for(i in 1:length(estados)){
  print(etiquetas[i])
}
dev.off()
```


#### Gr치fico Sankey

```{r, eval = FALSE}
# Matriz cuadrada a nivel municipal 
load(paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel intramunicipal 2020.RData"))

tabla <- Migrantes %>%
          as.data.frame() %>%
           tibble::rownames_to_column(var = "rn") %>%
            melt(., id.vars = "rn", variable.name = "cn") %>%
             mutate_if(is.factor, as.character)

################################################################################
################################## Filtro ######################################
Inmigrantes  <- Migrantes %>%
                 as.data.frame() %>%
                  tibble::rownames_to_column(var = "rn") %>% 
                   melt(., id.vars = "rn", variable.name = "cn") %>%
                    mutate_if(is.factor, as.character) %>%
                     mutate(value = ifelse((.$rn != .$cn) & (substr(.$rn, 1, 3) %in% estados | substr(.$cn, 1, 3) %in% estados), value, 0)) %>%
                      filter(value > 0) %>%
                       group_by(rn) %>% 
                        summarise(Inmigrantes = sum(value, na.rm = TRUE)) 

Emigrantes <- Migrantes %>%
               as.data.frame() %>%
                tibble::rownames_to_column(var = "rn") %>% 
                 melt(., id.vars = "rn", variable.name = "cn") %>%
                  mutate_if(is.factor, as.character) %>%
                   mutate(value = ifelse((.$rn != .$cn) & (substr(.$rn, 1, 3) %in% estados | substr(.$cn, 1, 3) %in% estados), value, 0)) %>%
                    filter(value > 0) %>%
                     group_by(cn) %>% 
                      summarise(Emigrantes = sum(value, na.rm = TRUE))     

################################## Filtro ######################################
# Se utiliza el filtro de arriba
################################################################################

tabla1 <- lapply(1:32, function(x){
                   filtro  <- Inmigrantes %>%
                                full_join(., Emigrantes, by = c("rn" = "cn")) %>%
                                 mutate(value = sum_row(Inmigrantes, Emigrantes, na.rm = TRUE)) %>%
                                  filter(value < filtro_mig[x]) %>% 
                                   pull(rn)
                   tabla %>%
                    mutate(rn = case_when(substr(.$rn, 1, 3) %in% estados[x] & .$rn %in% filtro ~ paste0("Otros municipios (", estados[x], ")"),
                                          substr(.$rn, 1, 3) %in% estados[x]  & .$rn %nin% filtro ~ .$rn,
                                          substr(.$rn, 1, 3) %nin% estados[x] ~ substr(.$rn, 1, 3)),
                           cn = case_when(substr(.$cn, 1, 3) %in% estados[x] & .$cn %in% filtro ~ paste0("Otros municipios (", estados[x], ")"),
                                          substr(.$cn, 1, 3) %in% estados[x] & .$cn %nin% filtro ~ .$cn,
                                          substr(.$cn, 1, 3) %nin% estados[x] ~ substr(.$cn, 1, 3))) %>%

                     mutate(value = ifelse(.$rn != .$cn, .$value, 0)) %>%
                      filter(value > 0) 
  }
)
```


```{r, eval = FALSE}
p <- lapply(1:32, function(x){
             tabla1[[x]] %>% 
              ggplot(aes(axis1 = rn, 
                          axis2 = cn, 
                           y = value),  # c("value", "freq", "tasa")
                      reverse = FALSE, 
                       na.rm = TRUE) +
               geom_alluvium(aes(fill = rn),
                              curve_type = "quintic", 
                               color = "transparent", 
                                alpha = 0.85, 
                                 lwd = 0.001, 
                                  width = 1/5,
                                   reverse = FALSE) +
                 geom_stratum(aes(fill = cn), 
                               color = "white", 
                                alpha = 0.65,  
                                 lwd = 0.001, 
                                  width = 1/5,
                                   reverse = FALSE) +
                  geom_text_repel(aes(label = ifelse(after_stat(x) == 1, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""), 
                                       fontface =  ifelse(after_stat(x) == 1, 'bold', 'plain')),
                                   stat = "stratum", 
                                    size = 3, 
                                     direction = "y", 
                                      nudge_x = -.2,
                                       min.segment.length = unit(1, "lines"),
                                        force = 1,
                                         force_pull = 0,
                                          family = "montserrat",
                                           reverse = FALSE) +
                   geom_text_repel(aes(label = ifelse(after_stat(x)  == 2, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                        fontface =  ifelse(after_stat(x) == 2, 'bold', 'plain')),
                                    stat = "stratum", 
                                     size = 3,
                                      direction = "y", 
                                       nudge_x = .2, 
                                        force = 1,
                                         force_pull = 0,
                                          family = "montserrat",
                                           reverse = FALSE) +
                     theme_void() + 
                      theme(plot.margin = margin(t = 1, r = 5, b = 1, l = 0, "cm"),
                             text = element_text(family = "montserrat"),
                              axis.text = element_blank(),
                               axis.title = element_blank(),
                                strip.text = element_text(size = 10, face = "bold", family = "montserrat"),
                                 legend.key.size = unit(0.5, "cm"),
                                  legend.text = element_text(size = 7, family = "montserrat"),
                                   legend.position = c(1.02, .5)) + 
                       scale_x_discrete(expand = c(-0.1, 0.5)) +
                        scale_fill_viridis_d(option = "A", end = 1, begin = 0.2) +
                         guides(fill = guide_legend(ncol = 1, na.translate = F)) + 
                          labs(fill = "", 
                               color = "")
  }
)

path = paste0(here::here(), "/Graficos/Municipio/04_Movilidad estudiantil/2020/GSankey de MEst desagregado a nivel intramunicipal.pdf")
ggexport(list = p, width = 18, height = 10, dpi = 400, filename = path)
```


### Indicadores {.tabset .tabset-pills}

Se realizan c치lculos generales de movilidad\
+ Residentes\
+ Inmigrantes\
+ Emigrantes\
+ $\%$ Inmigrantes\
+ $\%$ Emigrante\
+ Migraci칩n bruta\
+ Migraci칩n Neta\
+ $\%$ Tasa de movilidad bruta\
+ $\%$ Tasa de movilidad neta

Dada la cantidad de datos a calcular para la obtenci칩n de los indicadores. La obtenci칩n de los indicadores se realiza de manera directa, es decir, partiendo de la matriz cuadrada original.

```{r, eval = FALSE}
################################################################################
############################ Poblaci칩n total ###################################
Pob.Total <- mydata %>%
              as.data.frame() %>%
               group_by(CVE_MUN) %>%
                summarise(Pob.Total = sum(FACTOR)) 

################################################################################
###################### Pob. estudiantil de 3 a침os y m치s ########################
Pob.3ymas <- mydata %>%
              as.data.frame() %>%
               mutate(EDAD = as.numeric(.$EDAD)) %>%
                subset(EDAD >= 3 & EDAD <= 130) %>%
                 group_by(CVE_MUN) %>%
                  summarise(Pob.3ymas = sum(FACTOR)) 

################################################################################
########################### Residentes #########################################
load(paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel intramunicipal 2020.RData"))

Residentes <- Migrantes %>%
               rownames_to_column() %>%
                gather(CVE_MUN, Value ,-rowname)%>%
                 filter(rowname == CVE_MUN) %>%
                  select(-rowname) %>%
                   droplevels() %>%
                    rename("Residentes" = "Value") 

################################################################################
############################### Inmigrantes ####################################

## Poblaci칩n que sale de su entidad de residencia y entra a otro demarcaci칩n por motivos de estudios
Inmigrantes <- Migrantes %>% 
                as.data.frame() %>%
                 tibble::rownames_to_column(var = "CVE_MUN") %>%
                  melt(., id.vars = "CVE_MUN", variable.name = "CVE_MUN_ASI") %>%
                   mutate_at(vars(3), as.numeric) %>%
                    as_tibble() %>%
                     filter(CVE_MUN != CVE_MUN_ASI) %>%
                      group_by(CVE_MUN) %>%
                       summarise(Inmigrantes = sum(value, na.rm = TRUE))

################################################################################
############################### Emigrantes #####################################

## Poblaci칩n que entra a la entidad para estudiar 
Emigrantes <- Migrantes %>% 
               as.data.frame() %>%
                tibble::rownames_to_column(var = "CVE_MUN") %>%
                 melt(., id.vars = "CVE_MUN", variable.name = "CVE_MUN_ASI") %>%
                  mutate_at(vars(3), as.numeric) %>%
                   as_tibble() %>%
                    filter(CVE_MUN != CVE_MUN_ASI) %>%
                     group_by(CVE_MUN_ASI) %>%
                      summarise(Emigrantes = sum(value, na.rm = TRUE)) %>%
                       rename("CVE_MUN" = "CVE_MUN_ASI") 

tabla <- Pob.Total %>%
          left_join(., Pob.3ymas, by = c("CVE_MUN")) %>%
          left_join(., Residentes, by = c("CVE_MUN")) %>%
          left_join(., Inmigrantes, by = c("CVE_MUN")) %>%
          left_join(., Emigrantes, by = c("CVE_MUN")) %>%
            mutate(Mig.Neta = .$Inmigrantes - .$Emigrantes,
                   Mig.Bruta = .$Inmigrantes + .$Emigrantes, 
                   Tasa.Inmig = ((.$Inmigrantes/ 5) /((.$Pob.Total + .$Pob.3ymas) / 2)) * 1000,
                   Tasa.Emig = ((.$Emigrantes/ 5) /((.$Pob.Total + .$Pob.3ymas) / 2)) * 1000,
                   Tasa.Mig = Tasa.Inmig - Tasa.Emig, 
                   Eficacia = Mig.Neta - Mig.Bruta)

write.xlsx(tabla, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Indicadores de movilidad estudiantil a nivel intramunicipal 2020.xlsx"), overwrite = TRUE)

save(tabla, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Indicadores de movilidad estudiantil a nivel intramunicipal 2020.RData"))
```

```{r, echo = FALSE}
load(file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Indicadores de movilidad estudiantil a nivel intramunicipal 2020.RData"))

tabla[1:20,] %>%  
 as.data.frame() %>%
  gt() %>% 
   tab_header(title = "Indicadores de  movilidad estudiantil", 
              subtitle = "Nivel intramunicipal") %>%
    tab_options(heading.title.font.size = 12, 
                heading.align = "center",
                heading.subtitle.font.size = 10,
                data_row.padding = px(1),
                column_labels.font.weight = "bold",
                column_labels.padding = px(10), 
                table.font.names = 'montserrat',
                table.font.size = 8) %>%
      tab_style(style = list(cell_text(align = "center",
                                       weight = 'bold')),
                locations = list(cells_title(groups = c("title")))) %>%
       fmt_integer(columns = c(2:8, 12), sep_mark = " ") %>%
        fmt_number(columns = c(11), decimals = 1) %>%
         sub_missing(columns = everything(), missing_text = "0") %>%
          tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
           as_raw_html()
```


## Movilidad intermunicipal {.tabset .tabset-pills}

### Matrices 

```{r, eval = FALSE}
### Municipios que no pertenecen en la muestra
municipios_nomuestra <- c("004012", "007125", "029048")

#Clave de los municipios 2020 
municipios <- MUN %>%
               select(CVE_MUN) %>%
                unique() %>%
                 filter(CVE_MUN %nin% municipios_nomuestra) %>%
                  pull(CVE_MUN)

Pob.3ymas <- mydata %>%
              mutate(CVE_MUN_ASI = paste0(ENT_PAIS_ASI, MUN_ASI)) %>%
               mutate(ENT_PAIS_ASI = case_when(.$ENT_PAIS_ASI %in% estados ~.$ENT_PAIS_ASI,
                                               .$ENT_PAIS_ASI %nin% estados ~ "888", #Residencia en otro pa칤s
                                               .$ENT_PAIS_ASI %in% "997" ~ "997",
                                               .$ENT_PAIS_ASI %in% "998" ~ "998",
                                               .$ENT_PAIS_ASI %in% "997" ~ "999"),
                      CVE_MUN_ASI = case_when(.$CVE_MUN_ASI %in% municipios ~.$CVE_MUN_ASI,
                                             #### Se excluyen los municipios que no fueron muestreados
                                              .$CVE_MUN_ASI %in% municipios_nomuestra ~ "777",
                                               nchar(.$CVE_MUN_ASI) == 3 ~ "888",  #Asistencia escolar en otro pa칤s
                                              .$CVE_MUN_ASI %in% "997999" ~ '997999',
                                              .$ENT_PAIS_ASI %in% "997" ~ "997",
                                              .$ENT_PAIS_ASI %in% "998" ~ "998",
                                              .$ENT_PAIS_ASI %in% "999" ~ "999",
                                              .$MUN_ASI %in% "999" ~ "999")) %>%
                mutate(I_Migracion = case_when(.$CVE_ENT == .$ENT_PAIS_ASI & .$ENT_PAIS_ASI %in% estados ~ 1,
                                               .$CVE_ENT != .$ENT_PAIS_ASI & .$ENT_PAIS_ASI %in% estados ~ 2,
                                               .$ENT_PAIS_ASI %nin% estados ~ 3)) %>%
                 mutate(EDAD = as.numeric(.$EDAD)) %>%
                  subset(EDAD >= 3 & EDAD <= 130) %>%
                   select(FACTOR, ESTRATO, UPM, CVE_MUN, CVE_MUN_ASI, EDAD, I_Migracion) %>%
                    filter(CVE_MUN_ASI %in% municipios & I_Migracion == 2) 

MC <- Pob.3ymas %>%
       svydesign(data = ., id = ~ UPM, strata = ~ESTRATO, weight = ~FACTOR, nest = T)

saveRDS(MC, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/MC_intermunicipal.RDS"))
```

```{r, eval = FALSE}
MC <- readRDS(file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/MC_intermunicipal.RDS"))

Migrantes <- svytable(~CVE_MUN_ASI + CVE_MUN, design = MC) 
```

Se genera la matriz cuadrada y se le asignan los nombres de los estados.

```{r, eval = FALSE}
Migrantes <- Migrantes %>%
              as.data.frame() %>%
               expss::cross_cases(CVE_MUN, CVE_MUN_ASI, weight = Freq) %>%
                as.data.frame() %>%
                 rename("CVE_MUN" = "row_labels") %>% 
                  arrange(CVE_MUN) %>%
                   slice(-1) 

rownames <- Migrantes %>% 
             mutate(CVE_MUN = substr(.$CVE_MUN, 9, 16)) %>% 
              pull(CVE_MUN)

colnames <- names(Migrantes) %>% 
             as.data.frame() %>% 
              slice(-1) %>% 
               rename("CVE_MUN" = ".") %>%
                mutate(`CVE_MUN` = substr(.$CVE_MUN, 13, 18)) %>%
                 pull(CVE_MUN)

# Se elimina la variable CVE_MUN
Migrantes <- Migrantes %>%
              select(-CVE_MUN)

rownames(Migrantes) <- rownames 
colnames(Migrantes) <- colnames

saveRDS(Migrantes, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel intermunicipal 2020.RDS"))
save(Migrantes, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel intermunicipal 2020.RData"))

require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "M.Intermunicipal")
writeData(wb, 1, Migrantes %>% as.data.frame() %>% tibble::rownames_to_column(var = "CVE_MUN"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(), "/Bases/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel intermunicipal 2020.xlsx"), overwrite = TRUE)
```

**Matriz de movilidad estudiantil a nivel municipal, 2020**

<div style="height:500px;overflow:auto;">

```{r, echo = FALSE}
load(paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel intermunicipal 2020.RData"))

tabla <- Migrantes %>%
          as.data.frame() %>%
           tibble::rownames_to_column(var = "CVE_MUN") %>%
            mutate_if(is.numeric, as.numeric)

tabla[1:30, 1:30] %>%  
 gt() %>% 
  tab_header(title = "Matriz de movilidad estudiantil", 
             subtitle = "Nivel intermunicipal") %>%
   tab_options(heading.title.font.size = 12, 
               heading.align = "center",
               heading.subtitle.font.size = 10,
               data_row.padding = px(1),
               column_labels.font.weight = "bold",
               column_labels.padding = px(10), 
               table.font.names = 'montserrat',
               table.font.size = 8) %>%
    tab_style(style = list(cell_text(align = "center",
                                     weight = 'bold')),
              locations = list(cells_title(groups = c("title")))) %>%
     sub_missing(columns = everything(), missing_text = "0") %>%
      tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
       as_raw_html()
```

### Gr치ficos {.tabset .tabset-pills}

#### ChordDiagram 

Se filtran los flujos migratorios que son exclusivos de los estados y que visualmente sean m치s interpretables.

```{r, results = FALSE, eval = FALSE}
# Matriz cuadrada a nivel municipal 
load(paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel intermunicipal 2020.RData"))

rownames <- rownames(Migrantes) %>% 
             as.data.frame() %>%
              rename("CVE_MUN" = ".") %>%
               left_join(., MUN %>% select(CVE_MUN, NOM_MUN)) %>%
                mutate(CVE_MUN = stringr::str_wrap(paste(.$CVE_MUN, .$NOM_MUN), 100)) %>%
                 pull(CVE_MUN)

colnames <- colnames(Migrantes) %>% 
             as.data.frame() %>%
              rename("CVE_MUN" = ".") %>%
               left_join(., MUN %>% select(CVE_MUN, NOM_MUN)) %>%
                mutate(CVE_MUN = stringr::str_wrap(paste(.$CVE_MUN, .$NOM_MUN), 100)) %>%
                 pull(CVE_MUN)

rownames(Migrantes) <- rownames
colnames(Migrantes) <- colnames

# Nombre de los estados 
estado <- stringr::str_wrap(nom_estados, 100)

# Clave de los municipios 
### Municipios que no pertenecen en la muestra
municipios_nomuestra <- c("004012", "007125", "029048")

municipios <- MUN %>% 
               filter(CVE_MUN %nin% municipios_nomuestra) %>%
                mutate(municipios = stringr::str_wrap(paste(.$CVE_MUN, .$NOM_MUN), 100)) %>%
                 pull(municipios)
             
################################################################################
################################## Filtro ######################################
Inmigrantes  <- Migrantes %>%
                 as.data.frame() %>%
                  tibble::rownames_to_column(var = "rn") %>% 
                   melt(., id.vars = "rn", variable.name = "cn") %>%
                    mutate_if(is.factor, as.character) %>%
                     mutate(value = ifelse((.$rn != .$cn) & (.$rn %in% municipios | .$cn %in% municipios), value, 0)) %>%
                      filter(value > 0) %>%
                       group_by(rn) %>% 
                        summarise(Inmigrantes = sum(value, na.rm = TRUE)) 

Emigrantes <- Migrantes %>%
               as.data.frame() %>%
                tibble::rownames_to_column(var = "rn") %>% 
                 melt(., id.vars = "rn", variable.name = "cn") %>%
                  mutate_if(is.factor, as.character) %>%
                   mutate(value = ifelse((.$rn != .$cn) & (.$rn %in% municipios | .$cn %in% municipios), value, 0)) %>%
                    filter(value > 0) %>%
                     group_by(cn) %>% 
                      summarise(Emigrantes = sum(value, na.rm = TRUE))     

################################## Filtro ######################################
filtro  <- Inmigrantes %>%
            full_join(., Emigrantes, by = c("rn" = "cn")) %>%
             mutate(value = sum_row(Inmigrantes, Emigrantes, na.rm = TRUE)) %>%
              filter(value > 0)

filtro_est <- Migrantes %>%
               as.data.frame() %>%
                tibble::rownames_to_column(var = "rn") %>% 
                 melt(., id.vars = "rn", variable.name = "cn") %>%
                  mutate_if(is.factor, as.character) %>%
                   filter(value > 0)

### Sacar el promedio de los flujos migratiorios para determinar como se van a grupar los estados 
#### Es importante correr la tabla1[[x]] sin filtros para determinar el n칰mero promedio de flujos de migraci칩n
#### Filtro <<<<< filter(value < 0) %>%
#### Filtro de estados filter(value > 100000000000 & rn != estados[x]) %>%
#### Se mete el filtro dentro de la funci칩n tabla1[[x]]
#p <- data.frame(estados = est,
 #               filtro_municipio = filtro_mig,
  #              filtro_estado = filtro_out)
#write.table(p, file = paste0(here::here(), "/Bases/Municipio/04_Movilidad estudiantil/2020/Filtro a nivel intermunicipal.txt"), col.names = TRUE)
#write.xlsx(p, file = paste0(here::here(), "/Bases/Municipio/04_Movilidad estudiantil/2020/Filtro a nivel intermunicipal.xlsx"), overwrite = TRUE)

#### Filtro de municipios
filtro_mig <- read.xlsx(paste0(here::here(), "/Bases/Municipio/04_Movilidad estudiantil/2020/Filtro a nivel intermunicipal.xlsx"), colNames = TRUE) %>%
               pull(filtro_municipio)

#### Filtro de estados 
filtro_out <- read.xlsx(paste0(here::here(), "/Bases/Municipio/04_Movilidad estudiantil/2020/Filtro a nivel intermunicipal.xlsx"), colNames = TRUE) %>%
               pull(filtro_estado)


################################################################################
## Se generan los filtros correspondientes a la matriz cuadrada por estados 
tabla <- Migrantes %>%
          as.data.frame() %>%
           tibble::rownames_to_column(var = "rn") %>%
            melt(., id.vars = "rn", variable.name = "cn") %>%
             mutate_if(is.factor, as.character)

tabla1 <-  lapply(1:32, function(x){
                             # filtro de municipios
                             filtro <- filtro %>%
                                        filter(substr(.$rn, 1, 3) == estados[x]) %>%
                                         filter(value < filtro_mig[x]) %>%
                                          pull(rn)
                             
                             # filtro de estados
                             filtro_rn  <- filtro_est %>%
                                            mutate(value = ifelse(substr(.$rn, 1, 3) == estados[x] | substr(.$cn, 1, 3) == estados[x], value, 0)) %>%
                                             mutate(rn = substr(.$rn, 1, 3)) %>%
                                              group_by(rn) %>%
                                               summarise(Inm = sum(value, na.rm = TRUE))
    
                             filtro_cn  <- filtro_est %>%
                                            mutate(value = ifelse(substr(.$rn, 1, 3) == estados[x] | substr(.$cn, 1, 3) == estados[x], value, 0)) %>%
                                             mutate(cn = substr(.$cn, 1, 3)) %>%
                                              group_by(cn) %>%
                                               summarise(Emg = sum(value, na.rm = TRUE))
    
                             filtro_estados <- filtro_rn %>%
                                                full_join(., filtro_cn, by = c("rn" = "cn")) %>%
                                                 mutate(value = sum_row(.$Inm, .$Emg, na.rm = TRUE)) %>%
                                                  filter(value > filtro_out[x] & rn != estados[x]) %>%
                                                   pull(rn)
                                            
                             tabla %>%
                              filter(substr(.$rn, 1, 3) == estados[x] | substr(.$cn, 1, 3) == estados[x]) %>%
                               mutate(rn = case_when(.$rn %in% filtro ~ paste0(estados[x], " Otros municipios"), 
                                                      substr(.$rn, 1, 3) %in% estados[x] & .$rn %nin% filtro ~ .$rn, 
                                                      substr(.$rn, 1, 3) %nin% estados[x] & substr(.$rn, 1, 3) %in% filtro_estados ~ str_wrap(paste0(nom_estados[as.numeric(substr(.$rn, 1, 3))]), 100),
                                                      substr(.$rn, 1, 3) %nin% estados[x] & substr(.$rn, 1, 3) %nin% filtro_estados ~ "Otros estados"),
                                       cn = case_when(.$cn %in% filtro ~ paste0(estados[x], " Otros municipios"), 
                                                      substr(.$cn, 1, 3) %in% estados[x] & .$cn %nin% filtro ~ .$cn, 
                                                      substr(.$cn, 1, 3) %nin% estados[x] & substr(.$cn, 1, 3) %in% filtro_estados ~ str_wrap(paste0(nom_estados[as.numeric(substr(.$cn, 1, 3))]), 100),
                                                      substr(.$cn, 1, 3) %nin% estados[x] & substr(.$cn, 1, 3) %nin% filtro_estados ~ "Otros estados"))  %>%
                                 mutate(value = ifelse(substr(.$rn, 1, 3) %in% estados[x] | substr(.$cn, 1, 3) %in% estados[x], value, 0)) %>% 
                                  filter(value > 0)%>%
                                   dcast(., rn ~ cn, value.var = "value", sum,  na.rm = TRUE) %>%
                                    column_to_rownames(., var = "rn") 
  }
)

################################################################################

## Se sacan los flujos migratorios que pertencen a otros estados
#tabla_estados <- sapply(1:32, function(i){
#                                tabla1[[i]] %>%
#                                 as.data.frame() %>%
#                                  adorn_totals(c("row", "col"), 
#                                               fill = "-", 
#                                                na.rm = TRUE, 
#                                                 ,,,,contains(colnames(tabla1[[i]]))) %>% 
#                                   select(`Otros estados`) %>%
#                                    slice(nrow(.)) %>%
#                                     mutate(`Otros estados` = .$`Otros estados`/10) %>%
#                                      pull(`Otros estados`)
#})

## Se sacan los flujos migratorios que pertencen a otros municipios
#tabla_municipios <- sapply(1:32, function(i){
#                                  tabla1[[i]] %>%
#                                   as.data.frame() %>%
#                                    select(-c(`Otros estados`)) %>%
#                                     adorn_totals(c("row", "col"), 
#                                                   fill = "-", 
#                                                    na.rm = TRUE, 
#                                                     ,,,,contains(colnames(tabla1[[i]]))) %>% 
#                                      slice(nrow(.)) %>%
#                                       mutate(Total = .$Total/50) %>%
#                                        pull(Total)
#  })


################################################################################

## Se guardan las matrices de movilidad estudiantil para analizarlos despu칠s. 
wb <- createWorkbook()
for(i in 1:32){
     tabla <- tabla1[[i]] %>%
                as.data.frame() %>%
                 adorn_totals(c("row", "col"), 
                               fill = "-", 
                                na.rm = TRUE, 
          ,,,,contains(colnames(tabla1[[i]])))
                 
     addWorksheet(wb, paste(est[i]))
     writeData(wb, i, tabla, colNames = TRUE, rowNames = TRUE)
     saveWorkbook(wb, 
                  file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz MEst nivel intermunicipal_Reduccion.xlsx"), 
               overwrite = TRUE)
}

saveRDS(tabla1, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Tabla MEst a nivel intermunicipal.RDS"))
```

```{r tablas de matrices}
tabla1 <- readRDS(file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Tabla MEst a nivel intermunicipal.RDS"))

totales <- lapply(1:length(estados), function(x){
                #Se agrupan los totales
                 full_join(
                           tabla1[[x]] %>%
                            as.data.frame() %>%
                             adorn_totals(c("row", "col"), 
                                          fill = "-", 
                                          na.rm = TRUE, 
                                           ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                              slice(nrow(.)) %>% 
                               t() %>%
                                as.data.frame()%>%
                                 rownames_to_column(var = "name")  %>% 
                                  rename("Total_Filas" = "1"),
                           tabla1[[x]] %>%
                            as.data.frame() %>%
                             adorn_totals(c("row", "col"), 
                                          fill = "-", 
                                          na.rm = TRUE, 
                                           ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                              rownames_to_column(var = "name") %>%
                               select(name, Total) %>%
                                mutate(name = str_replace(.$name, "1$", "Total")), 
                           by = c("name")
                           ) %>%
                            rename("CVE_MUN" = "name",
                                   "Entran por trabajo" = "Total_Filas", # Poblaci칩n que entra a la entidad para trabajar
                                   "Salen por trabajo" = "Total") %>% # Poblaci칩n que sale de su entidad de residencia y entra a otra demarcaci칩n por motivos de trabajo
                             select(`Entran por trabajo`, CVE_MUN, `Salen por trabajo`)
  }
)
porcentajes <- lapply(1:length(estados), function(x){
                           #Se agrupan los porcentajes
                           full_join(
                                     tabla1[[x]] %>%
                                      as.data.frame() %>%
                                       adorn_totals(c("col", "row"), 
                                                    fill = "0", 
                                                    na.rm = TRUE, 
                                                    name = "Total",
                                                    ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                        adorn_percentages("col",
                                                          na.rm = TRUE) %>% 
                                         rownames_to_column(var = "name") %>%
                                          select(name, Total) %>%
                                           mutate(name = str_replace(.$name, "1$", "Total")),
                                     tabla1[[x]] %>%
                                      as.data.frame() %>%
                                       adorn_totals(c("row"), 
                                                    fill = "0", 
                                                    na.rm = TRUE, 
                                                    name = "Total", 
                                                    ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                        adorn_percentages("row", 
                                                          na.rm = TRUE, 
                                                         ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                         slice(nrow(.)) %>% 
                                          t() %>%
                                           as.data.frame()%>%
                                            rownames_to_column(var = "name")  %>% 
                                             rename("Total_Filas" = "1"), 
                                     by = c("name")
                                          ) %>%
                                     rename("CVE_MUN" = "name",
                                            "Entran por trabajo%" = "Total_Filas", # Poblaci칩n que entra a la entidad para trabajar
                                            "Salen por trabajo%" = "Total") %>% # Poblaci칩n que sale de su entidad de residencia y entra a otra demarcaci칩n por motivos de trabajo
                                      select(`Entran por trabajo%`, CVE_MUN, `Salen por trabajo%`)
                                   
  }
)

# Se guardan los totales de las matrices reducidas 
wb <- createWorkbook()
for(i in 1:32){
     addWorksheet(wb, paste(est[i]))
     writeData(wb, i, totales[[i]], colNames = TRUE, startCol = 1)
     writeData(wb, i, porcentajes[[i]], colNames = TRUE, startCol = 5)
     saveWorkbook(wb, 
                  file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz MEst nivel intermunicipal_Reduccion_Totales.xlsx"), 
               overwrite = TRUE)
}
```


**Dada la magnitud de municipios en algunos estados se seleccionan solo algunos de ellos.**

```{r}
tabla1 <- readRDS(file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Tabla MEst a nivel intermunicipal.RDS"))

# Paleta de colores
#paleta <- rev(colorRampPalette(wesanderson::wes_palette("Rushmore1"))(50)) 
paleta <- colorRampPalette(c("#000C7D", "#001599", "#0022B0", "#0035BB", "#004AB4", "#005EA3", "#00708D", "#078472","#3E9A85", "#49A980", "#58B877", "#70C669", "#94D25D", "#BBDA60", "#DEE53E", "#DBCE33", "#D6B92A", "#D1A521", "#CA911A"))(50)

tabla2 <- lapply(1:length(estados), function(x){ 
                    # Paleta de colores
                       groupColors <- setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))))),
                                               nm = str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))
                        circos.clear()
                         chordDiagram(x  = tabla1[[x]] %>% as.matrix(), 
                                       transparency = 0.4,
                                        order = str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE),
                                         grid.col = groupColors)  %>% 
                          pull(col)
  }
)
```

```{r grafico intermunicipal, eval = FALSE, results='hide'}
cairo_pdf(paste0(here::here(), "/Graficos/Municipio/04_Movilidad estudiantil/2020/ChordDiagram de MEst desagregado a nivel intermunicipal.pdf"),
          width = 15,
          height = 10, 
          family = "Montserrat Medium",
          fallback_resolution = 400,
          onefile = TRUE)
for(i in 1:length(estados)){
# Paleta de colores
groupColors <- setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]]))))),
                        nm = str_sort(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]]))), numeric = TRUE))

circos.clear()
circos.par(start.degree = 90, 
           gap.degree = 2, 
           clock.wise = FALSE,
           #track.margin = c(-0.07, 0.07),  # c칤rculo exterior | circulo interior
           track.margin = c(-0.07, 0.1),
           points.overflow.warning = FALSE)

par(mar = rep(0, 4))

chordDiagram(x  =  tabla1[[i]] %>% as.matrix(), 
             grid.col = groupColors,
             col = tabla2[[i]],
             order = str_sort(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]])))),
             keep.diagonal = FALSE,
             transparency =  0,
             directional = 1,
             direction.type = c("arrows", "diffHeight"), 
             diffHeight  = -0.04, # adjust the starting end of the link
             annotationTrack = "grid", 
             annotationTrackHeight = c(0.05, 0.1),
             preAllocateTracks = 1, 
             big.gap = 40, # Gap between row sectors and column sectors.
             link.arr.type = "big.arrow", 
             link.lwd = 3,    # Line width width for link borders
             link.lty = 1,
             link.visible = TRUE,
             link.largest.ontop = TRUE)

# Add text and axis
circos.trackPlotRegion(track.index = 1,
                       track.height = 0.05,
                       bg.border = NA, 
                       panel.fun = function(x, y) {
                                                   xlim = get.cell.meta.data("xlim")
                                                   ylim = get.cell.meta.data("ylim")
                                                   sector.name = get.cell.meta.data("sector.index")
                                                  # Add names to the sector. 
                                                   circos.text(x = mean(xlim), 
                                                               y = ylim[1] + 0.1, 
                                                               labels = sector.name, 
                                                               facing = "clockwise",
                                                               niceFacing = TRUE, 
                                                               adj = c(-0.05, 0.5), #Ajuste de las etiquetas (x, y)
                                                               cex = fontsize(9),
                                                               col = "#000C7D",
                                                               font = 1)
                                                  # Add graduation on axis
                                                   circos.axis(h = "top",
                                                               labels = c(0, 10, 20, 50, 100, 200, 300, 400, 500, seq(1000, 200000, by = 1000)),
                                                               major.tick.length = 0.5,
                                                               minor.ticks = 4, 
                                                               labels.cex = fontsize(6),
                                                               sector.index = sector.name,
                                                               track.index = 2,
                                                               labels.niceFacing = TRUE,
                                                               labels.pos.adjust = c(0, 0.8))
                                                }
  )
}
dev.off()
```

**Etiquetas**

```{r etiquetas_intermunicipal}
etiquetas  <- lapply(1:length(estados), function(x){
                        p <-  tabla1[[x]] %>% 
                               as.data.frame() %>%
                                tibble::rownames_to_column(var = "rn") %>%
                                 melt(., id.vars = "rn", variable.name = "cn") %>%
                                  as.data.frame() %>% 
                                   mutate(rn = str_wrap(.$rn, 100),
                                          cn = str_wrap(.$cn, 100)) %>%
                                    ggplot() + 
                                     geom_bar(aes(x = value, fill = rn))  + 
                                      geom_bar(aes(x = value, fill = cn))  + 
                                       theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                                             text = element_text(family = "Montserrat Medium"),
                                             axis.text = element_blank(),
                                             axis.title = element_blank(),
                                             strip.text = element_text(size = 9, face = "bold", family = "Montserrat Medium"),  
                                             legend.key.size = unit(0.4, "cm"), 
                                             legend.spacing.y = unit(0.4, "cm"),
                                             legend.text = element_text(size = 7, family = "Montserrat Medium"),
                                             legend.title = element_text(size = 8 , family = "Montserrat Medium")) + 
                                        scale_fill_manual(values = colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]])))))) + 
                                         guides(fill = guide_legend(ncol = 1)) + 
                                          labs(fill = stringr::str_wrap(paste(estado[x]), 100),
                                               color = stringr::str_wrap(paste(estado[x]), 100))
                         leg <- get_legend(p)
                         as_ggplot(leg)
 })

cairo_pdf(paste0(here::here(), "/Graficos/Municipio/04_Movilidad estudiantil/2020/Etiquetas a nivel intermunicipal.pdf"), 
          width = 7, height = 8, 
          fallback_resolution = 400,
          family = "montserrat", onefile = TRUE)
for(i in 1:length(estados)){
  print(etiquetas[i])
}
dev.off()
```


#### Gr치fico Sankey

```{r, eval = FALSE}
# Matriz cuadrada a nivel municipal 
load(paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel intermunicipal 2020.RData"))

tabla <- Migrantes %>%
          as.data.frame() %>%
           tibble::rownames_to_column(var = "rn") %>%
            melt(., id.vars = "rn", variable.name = "cn") %>%
             mutate_if(is.factor, as.character)

################################################################################
################################## Filtro ######################################
Inmigrantes  <- Migrantes %>%
                 as.data.frame() %>%
                  tibble::rownames_to_column(var = "rn") %>% 
                   melt(., id.vars = "rn", variable.name = "cn") %>%
                    mutate_if(is.factor, as.character) %>%
                     mutate(value = ifelse((.$rn != .$cn) & (substr(.$rn, 1, 3) %in% estados | substr(.$cn, 1, 3) %in% estados), value, 0)) %>%
                      filter(value > 0) %>%
                       group_by(rn) %>% 
                        summarise(Inmigrantes = sum(value, na.rm = TRUE)) 

Emigrantes <- Migrantes %>%
               as.data.frame() %>%
                tibble::rownames_to_column(var = "rn") %>% 
                 melt(., id.vars = "rn", variable.name = "cn") %>%
                  mutate_if(is.factor, as.character) %>%
                   mutate(value = ifelse((.$rn != .$cn) & (substr(.$rn, 1, 3) %in% estados | substr(.$cn, 1, 3) %in% estados), value, 0)) %>%
                    filter(value > 0) %>%
                     group_by(cn) %>% 
                      summarise(Emigrantes = sum(value, na.rm = TRUE))     

################################## Filtro ######################################
filtro  <- Inmigrantes %>%
            full_join(., Emigrantes, by = c("rn" = "cn")) %>%
             mutate(value = sum_row(Inmigrantes, Emigrantes, na.rm = TRUE)) %>%
              filter(value < 5000) %>% 
               pull(rn)
################################################################################

tabla1 <- lapply(1:32, function(x){
                   tabla %>%
                    mutate(rn = case_when(substr(.$rn, 1, 3) %in% estados[x] & .$rn %in% filtro ~ paste0("Otros municipios (", estados[x], ")"),
                                          substr(.$rn, 1, 3) %in% estados[x]  & .$rn %nin% filtro ~ .$rn,
                                          substr(.$rn, 1, 3) %nin% estados[x] ~ substr(.$rn, 1, 3)),
                           cn = case_when(substr(.$cn, 1, 3) %in% estados[x] & .$cn %in% filtro ~ paste0("Otros municipios (", estados[x], ")"),
                                          substr(.$cn, 1, 3) %in% estados[x] & .$cn %nin% filtro ~ .$cn,
                                          substr(.$cn, 1, 3) %nin% estados[x] ~ substr(.$cn, 1, 3))) %>%

                     mutate(value = ifelse(.$rn != .$cn, .$value, 0)) %>%
                      filter(value > 0) 
  }
)
```


```{r, eval = FALSE}
p <- lapply(1:32, function(x){
             tabla1[[x]] %>% 
              ggplot(aes(axis1 = rn, 
                          axis2 = cn, 
                           y = value),  # c("value", "freq", "tasa")
                      reverse = FALSE, 
                       na.rm = TRUE) +
               geom_alluvium(aes(fill = rn),
                              curve_type = "quintic", 
                               color = "transparent", 
                                alpha = 0.85, 
                                 lwd = 0.001, 
                                  width = 1/5,
                                   reverse = FALSE) +
                 geom_stratum(aes(fill = cn), 
                               color = "white", 
                                alpha = 0.65,  
                                 lwd = 0.001, 
                                  width = 1/5,
                                   reverse = FALSE) +
                  geom_text_repel(aes(label = ifelse(after_stat(x) == 1, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""), 
                                       fontface =  ifelse(after_stat(x) == 1, 'bold', 'plain')),
                                   stat = "stratum", 
                                    size = 3, 
                                     direction = "y", 
                                      nudge_x = -.2,
                                       min.segment.length = unit(1, "lines"),
                                        force = 1,
                                         force_pull = 0,
                                          family = "montserrat",
                                           reverse = FALSE) +
                   geom_text_repel(aes(label = ifelse(after_stat(x)  == 2, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                        fontface =  ifelse(after_stat(x) == 2, 'bold', 'plain')),
                                    stat = "stratum", 
                                     size = 3,
                                      direction = "y", 
                                       nudge_x = .2, 
                                        force = 1,
                                         force_pull = 0,
                                          family = "montserrat",
                                           reverse = FALSE) +
                     theme_void() + 
                      theme(plot.margin = margin(t = 1, r = 5, b = 1, l = 0, "cm"),
                             text = element_text(family = "montserrat"),
                              axis.text = element_blank(),
                               axis.title = element_blank(),
                                strip.text = element_text(size = 10, face = "bold", family = "montserrat"),
                                 legend.key.size = unit(0.5, "cm"),
                                  legend.text = element_text(size = 7, family = "montserrat"),
                                   legend.position = c(1.02, .5)) + 
                       scale_x_discrete(expand = c(-0.1, 0.5)) +
                        scale_fill_viridis_d(option = "A", end = 1, begin = 0.2) +
                         guides(fill = guide_legend(ncol = 1, na.translate = F)) + 
                          labs(fill = "", 
                               color = "")
  }
)

path = paste0(here::here(), "/Graficos/Municipio/04_Movilidad estudiantil/2020/GSankey de MEst desagregado a nivel intermunicipal.pdf")
ggexport(list = p, width = 18, height = 10, dpi = 400, filename = path)
```


### Indicadores {.tabset .tabset-pills}

Se realizan c치lculos generales de movilidad\
+ Residentes\
+ Inmigrantes\
+ Emigrantes\
+ $\%$ Inmigrantes\
+ $\%$ Emigrante\
+ Migraci칩n bruta\
+ Migraci칩n Neta\
+ $\%$ Tasa de movilidad bruta\
+ $\%$ Tasa de movilidad neta

Dada la cantidad de datos a calcular para la obtenci칩n de los indicadores. La obtenci칩n de los indicadores se realiza de manera directa, es decir, partiendo de la matriz cuadrada original.

```{r, eval = FALSE}
################################################################################
############################ Poblaci칩n total ###################################
Pob.Total <- mydata %>%
              as.data.frame() %>%
               filter(CVE_MUN %in% municipios) %>%
                group_by(CVE_MUN) %>%
                 summarise(Pob.Total = sum(FACTOR)) 

################################################################################
###################### Pob. estudiantil de 3 a침os y m치s ########################
Pob.3ymas <- mydata %>%
              as.data.frame() %>%
               mutate(EDAD = as.numeric(.$EDAD)) %>%
                subset(EDAD >= 3 & EDAD <= 130) %>%
                 filter(CVE_MUN %in% municipios) %>%
                  group_by(CVE_MUN) %>%
                   summarise(Pob.3ymas = sum(FACTOR)) 

################################################################################
########################### Residentes #########################################
load(paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Matriz de movilidad estudiantil a nivel intermunicipal 2020.RData"))

Residentes <- Migrantes %>%
               rownames_to_column() %>%
                gather(CVE_MUN, Value ,-rowname)%>%
                 filter(rowname == CVE_MUN) %>%
                  select(-rowname) %>%
                   droplevels() %>%
                    rename("Residentes" = "Value") 

################################################################################
############################### Inmigrantes ####################################

## Poblaci칩n que sale de su entidad de residencia y entra a otro demarcaci칩n por motivos de estudios
Inmigrantes <- Migrantes %>% 
                as.data.frame() %>%
                 tibble::rownames_to_column(var = "CVE_MUN") %>%
                  melt(., id.vars = "CVE_MUN", variable.name = "CVE_MUN_ASI") %>%
                   mutate_at(vars(3), as.numeric) %>%
                    as_tibble() %>%
                     filter(CVE_MUN != CVE_MUN_ASI) %>%
                      group_by(CVE_MUN) %>%
                       summarise(Inmigrantes = sum(value, na.rm = TRUE))

################################################################################
############################### Emigrantes #####################################

## Poblaci칩n que entra a la entidad para estudiar 
Emigrantes <- Migrantes %>% 
               as.data.frame() %>%
                tibble::rownames_to_column(var = "CVE_MUN") %>%
                 melt(., id.vars = "CVE_MUN", variable.name = "CVE_MUN_ASI") %>%
                  mutate_at(vars(3), as.numeric) %>%
                   as_tibble() %>% 
                    filter(CVE_MUN != CVE_MUN_ASI) %>%
                     group_by(CVE_MUN_ASI) %>%
                      summarise(Emigrantes = sum(value, na.rm = TRUE)) %>%
                       rename("CVE_MUN" = "CVE_MUN_ASI") 

tabla <- Pob.Total %>%
          left_join(., Pob.3ymas, by = c("CVE_MUN")) %>%
          left_join(., Residentes, by = c("CVE_MUN")) %>%
          left_join(., Inmigrantes, by = c("CVE_MUN")) %>%
          left_join(., Emigrantes, by = c("CVE_MUN")) %>%
            mutate(Mig.Neta = .$Inmigrantes - .$Emigrantes,
                   Mig.Bruta = .$Inmigrantes + .$Emigrantes, 
                   Tasa.Inmig = ((.$Inmigrantes/ 5) /((.$Pob.Total + .$Pob.3ymas) / 2)) * 1000,
                   Tasa.Emig = ((.$Emigrantes/ 5) /((.$Pob.Total + .$Pob.3ymas) / 2)) * 1000,
                   Tasa.Mig = Tasa.Inmig - Tasa.Emig, 
                   Eficacia = Mig.Neta - Mig.Bruta)

write.xlsx(tabla, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Indicadores de movilidad estudiantil a nivel intermunicipal 2020.xlsx"), overwrite = TRUE)

save(tabla, file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Indicadores de movilidad estudiantil a nivel intermunicipal 2020.RData"))
```

```{r, echo = FALSE}
load(file = paste0(here::here(), "/Output/Municipio/04_Movilidad estudiantil/2020/Indicadores de movilidad estudiantil a nivel intermunicipal 2020.RData"))

tabla[1:20,] %>%  
 as.data.frame() %>%
  gt() %>% 
   tab_header(title = "Indicadores de  movilidad estudiantil", 
              subtitle = "Nivel intermunicipal") %>%
    tab_options(heading.title.font.size = 12, 
                heading.align = "center",
                heading.subtitle.font.size = 10,
                data_row.padding = px(1),
                column_labels.font.weight = "bold",
                column_labels.padding = px(10), 
                table.font.names = 'montserrat',
                table.font.size = 8) %>%
      tab_style(style = list(cell_text(align = "center",
                                       weight = 'bold')),
                locations = list(cells_title(groups = c("title")))) %>%
       fmt_integer(columns = c(2:8, 12), sep_mark = " ") %>%
        fmt_number(columns = c(11), decimals = 1) %>%
         sub_missing(columns = everything(), missing_text = "0") %>%
          tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
           as_raw_html()
```


# Referencias

Librerias que se usaron en el documento

```{r, echo = FALSE}
sesion_info <- devtools::session_info()
kable(dplyr::select(tibble::as_tibble(sesion_info$packages %>% dplyr::filter(attached == TRUE)),
                    c(package, loadedversion, source))) %>%
 kable_styling(font_size = 10, 
               bootstrap_options = c("condensed", "responsive", "bordered")) %>%
  kable_classic(full_width = TRUE, html_font = "montserrat") %>% 
   scroll_box(width = "100%", height = "150px") %>%  
    gsub("font-size: initial !important;", "font-size: 10pt !important;", .)
```
