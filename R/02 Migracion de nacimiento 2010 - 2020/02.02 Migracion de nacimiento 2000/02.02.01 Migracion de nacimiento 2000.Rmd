---
title: "Migraci贸n por lugar de nacimiento 2000"
author: "CONAPO"
output:
  html_document:
    highlight: tango
    theme: flatly
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: yes
---

\usepackage{color}

```{=html}
<style>
code.r{
  font-size: 10px;
}
pre {
  font-size: 12px
}
</style>

<style>
body {
text-align: justify;
font-style: normal;
font-family: "Montserrat";
font-size: 12px
}
h1.title {
  font-size: 40px;
  color: #000D3B;
}
h1 {
  color: #B6854D;
}
h2 {
  color: #172984;
}
h3 {
  color: #172984;
}
</style>
```

```{=html}
<style>
.nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #0A2687;
}
.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
    color: #ffffff;
    background-color: #09C2BC;
}
</style>
```

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE, cache.lazy = FALSE, 
                         eval = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(digits = 2, encoding = "UTF8")
```   
 

```{r, echo=FALSE}
rm(list = ls())
```

```{r, echo=FALSE}
setwd(here::here())
```


```{r, echo=FALSE}
#Font Stlye
require(showtext)
library(extrafont)
# activar showtext
# SE cargan las funtes del sitema Windows (Pero tarda en correr)
#ttf_import('C:/Users/dvill/AppData/Local/Microsoft/Windows/Fonts/')
#fonts()
#extrafont::loadfonts(device = "win")
#font_import()
windowsFonts()
```


```{r, echo = FALSE}
# Librer铆as que se usaron en el documCVE_ENTo
require(chorddiag)
require(circlize)
require(Cairo)
require(haven)
require(Hmisc) # %nin%
require(dplyr)
require(survey)
require(srvyr)
require(stringr)
require(sna)
require(expss)
require(knitr)
require(kableExtra)
require(sjlabelled)
require(gt)
require(ggplot2)
require(ggpubr)
require(ggalluvial)
require(ggsankey)
require(ggrepel)
require(janitor)
require(tibble)
require(tidyr)
require(reshape2)
require(openxlsx)
require(doMC)
registerDoMC(cores = 18)
```


**Cuestionario Ampliado del Censo de Poblaci贸n y Vivienda 2000**

El cuestionario ampliado se guarda en un un archivo `.RData`.

```{r, eval = FALSE}
data <- read_sav("~/Cuestionario Ampliado_2000_Persona.sav")

#data <- data %>%
 #     select(., c(1:96, 101:103))
save(data, 
      file = paste0(here::here(),"/Bases/Censo_Personas_2000.RData"))
```

Se seleccionan las variables que se desean conservar para la realizaci贸n de este documento y se guarda en un archivo `.RData` para practicidad del manejo de datos.

**Posibles variables que se pueden contemplar en la migraci贸n reciente**

-   `EDAD`   
-   `SEXO`  
-   `AFRODES`\   
-   `HLENGUA`\   
-   `QDIALECT_INALI`    
-   `PERTE_INDIGENA`\  
-   `NIVACAD`   
-   `ALFABET`   
-   `CAUSA_MIG`\   
-   `SITUA_CONYUGAL`\   
-   `CONACT`\  
-   `HIJOS_NAC_VIVOS`  


```{r, eval = FALSE}
load(paste0(here::here(),"/Bases/Censo_Personas_2000.RData"))

mydata <- data %>%
           select(CVE_ENT, NOM_ENT, MUN, CVE_MUN, NOM_MUN, LNACEDO_C, 
                  EDAD, SEXO, HLENGUA, QDIALECT_C, PERETN, ESTCON, NIVACAD, ESCOLARI, ALFABET, 
                  CONACT, SITTRA, FACTOR, ESTRATO, UPM) %>%
            rename("ENT_PAIS_NAC" = "LNACEDO_C") %>%
             mutate(CVE_ENT = str_pad(.$CVE_ENT, width = 3, side = c("left"), pad = "0"))

save(mydata, file = paste0(here::here(),"/Bases/02_Migracion de lugar de nacimiento_2000.RData"))
```

锔A partir de aqu铆 se pueden correr los c贸didos .
Se carga el archivo `Migracion interna_2000.RData`.

```{r, echo = FALSE}
load(paste0(here::here(), "/Bases/02_Migracion de lugar de nacimiento_2000.RData"))

# Para fines pr谩cticos se genera un ponderador de uno 
mydata <- mydata %>%
           select(CVE_ENT, NOM_ENT, ENT_PAIS_NAC, FACTOR, ESTRATO, UPM) %>%
            mutate(M = 1) %>%
             mutate(NOM_ENT = as.factor(.$CVE_ENT)) %>%
              ungroup()
```


**Claves de entidades y municipios**

Se genera un vector con el nombre de las entdades llamado `estados` para facilitar los filtros en el documento.\  
Se genera un vector con las abreviaturas de las entidades llamado `est` para fines pr谩cticos.\      
Se genera un vector con las claves de los municipios, pero es importante hacer notar que tres municipios no entraron el muestreo la Encuesta Intercensal.      

```{r}
# Claves de los estados
estados <- sjlabelled::get_labels(mydata$CVE_ENT)
nom_estados <- sjlabelled::get_labels(mydata$NOM_ENT)

est <- c("AGS", "BC", "BCS", "CAMP", "COAH", "COL", "CHIS", "CHIH", "CDMX", "DGO", "GTO", "GRO", "HGO", "JAL", "MEX", "MICH", "MOR", "NAY", "NL", "OAX", "PUE", "QRO", "QROO", "SLP","SIN","SON", "TAB", "TAMS", "TLX", "VER", "YUC", "ZAC")

nom_estados <- c( "Aguascalientes", "Baja California" ,"Baja California Sur", "Campeche", "Coahuila de Zaragoza", "Colima", 
                  "Chiapas", "Chihuahua", "Ciudad de M茅xico", "Durango", "Guanajuato", "Guerrero", "Hidalgo", "Jalisco",    
                  "M茅xico", "Michoac谩n de Ocampo", "Morelos", "Nayarit", "Nuevo Le贸n", "Oaxaca", "Puebla", "Quer茅taro", 
                  "Quintana Roo", "San Luis Potos铆", "Sinaloa", "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala", 
                  "Veracruz de Ignacio de la Llave", "Yucat谩n", "Zacatecas")
est <- c("AGS", "BC", "BCS", "CAMP", "COAH", "COL", "CHIS", "CHIH", "CDMX", "DGO", "GTO", "GRO", "HGO",
         "JAL", "MEX", "MICH", "MOR", "NAY", "NL", "OAX", "PUE", "QRO", "QROO", "SLP","SIN","SON", "TAB", 
         "TAMS", "TLX", "VER", "YUC", "ZAC")

# Se le asignan las etiquetas a los nombres de los estados 
levels(mydata$NOM_ENT) <- estados
```


**Poblaci贸n total**

Se identifica a la poblaci贸n total dentro del cuestionario ampliado.

```{r}
Pob.total <- mydata %>%
              as.data.frame() %>%
               summarise(Pob_Total = sum(.$FACTOR))
```

```{r, echo = FALSE}
Pob.total %>%  
 as.data.frame() %>%
   gt() %>% 
    fmt_integer(columns = 1, sep = " ") %>%
     tab_header(title = "Poblaci贸n total 2000") %>%
      tab_options(heading.title.font.size = 12, 
                  heading.align = "center",
                  heading.subtitle.font.size = 10,
                  table.align = "center",
                  column_labels.font.weight = "bold",
                  table.font.names = 'montserrat',
                  table.font.size = 8) %>%  
       as_raw_html()
```



# Muestro Complejo

Se utiliza la paqueter铆a `survey` para poder trabajar con la muestra del cuestionario ampliado, en la cual se selecciona a toda la poblaci贸n.

```{r, eval = FALSE}
options(survey.lonely.psu = "adjust")

MC <- mydata %>%
       filter(ENT_PAIS_NAC %in% estados) %>%
        svydesign(data = ., id = ~ UPM, strata = ~ESTRATO, weight = ~FACTOR, nest = T)

saveRDS(MC, file = paste0(here::here(), "/Output/Estado/02_Lugar de nacimiento/2000/MC_estado.RDS"))
```

# Nivel estatal {.tabset .tabset-pills}

## Migraci贸n por lugar de nacimiento {.tabset .tabset-pills}

Se genera una matriz cruzada del lugar de de nacimiento a nivel estatal, utilizando la funci贸n `svytable` de la paqueter铆a `survey`.  

```{r}
MC <- readRDS(paste0(here::here(), "/Output/Estado/02_Lugar de nacimiento/2000/MC_estado.RDS"))

Migrantes <- svytable(~CVE_ENT + ENT_PAIS_NAC, design = MC) 
```

La funci贸n `cross_cases()` de la paqueter铆a `expss`  se utiliza para crear tablas de contingencia cruzadas a partir de dos o m谩s variables categ贸ricas. Utilizando el comando `weight`, permite ponderar las observaciones "factores de expansi贸n" en la tabla.   

Se quita la diagonal a la matriz cruadrada con la funci贸n `diag.remove()` de la paqueter铆a `sna`, donde esta funci贸n reemplaza los elementos de la diagonal principal de una matriz por un valor nulo o por el valor especifico.     

```{r, eval = FALSE}
Migrantes <- Migrantes %>%
              as.data.frame() %>%
               expss::cross_cases(CVE_ENT, ENT_PAIS_NAC, weight = Freq) %>%
                as.data.frame() %>%
                 slice(-33) %>% 
                  select(-row_labels) 

rownames(Migrantes)<- nom_estados
colnames(Migrantes) <- nom_estados

wb <- createWorkbook()
addWorksheet(wb, "MNac. 2000")
writeData(wb, 1, Migrantes, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(), "/Bases/Estado/02_Lugar de nacimiento/2000/Matriz de migracion de nacimiento 2000.xlsx"), overwrite = TRUE)

save(Migrantes, file = paste0(here::here(), "/Bases/Estado/02_Lugar de nacimiento/2000/Matriz de migracion de nacimiento 2000.RData"))
```

**Matriz de migraci贸n en el lugar de nacimiento**

::: {style="height:500px;overflow:auto;"}
```{r, echo = FALSE}
load(file = paste0(here::here(), "/Bases/Estado/02_Lugar de nacimiento/2000/Matriz de migracion de nacimiento 2000.RData"))

tabla <- Migrantes %>%
          as.data.frame() %>%
           tibble::rownames_to_column() 

tabla %>%  
 gt() %>% 
  tab_header(title = "Matriz de migraci贸n en el lugar de nacimiento", 
              subtitle = "Nivel estatal") %>%
   tab_options(heading.title.font.size = 12, 
               heading.align = "center",
               heading.subtitle.font.size = 10,
               data_row.padding = px(1),
               column_labels.font.weight = "bold",
               column_labels.padding = px(10), 
               table.font.names = 'montserrat',
               table.font.size = 8) %>%
    tab_style(style = list(cell_text(align = "center",
                                     weight = 'bold')),
              locations = list(cells_title(groups = c("title")))) %>%
     tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
      sub_missing(columns = everything(), missing_text = "0") %>%
       as_raw_html()
```
:::


## Gr谩fico d铆n谩mico

Gr谩fico din谩mico de migraci贸n por lugar de nacimiento a nivel estatal.

```{r, fig.width=7, fig.height=5, fig.align='center'}
#devtools::install_github("mattflor/chorddiag")
require(chorddiag)

load(file = paste0(here::here(), "/Bases/Estado/02_Lugar de nacimiento/2000/Matriz de migracion de nacimiento 2000.RData"))

tabla <- Migrantes %>%
          sna::diag.remove(remove.val = 0) 

# Paleta de colores
#paleta <- colorRampPalette(LaCroixColoR::lacroix_palette("PassionFruit", n = 50, type = "continuous"))(25)
paleta <- c("#C70E7B", "#D1207C", "#DC327D", "#E7467F", "#F25880", "#F86C7C", "#E58560", "#D49E46", "#C2B72A", "#B0D00F", "#9ADC0E", "#7CD332", "#60CA57", "#43C17B", "#25B99F", "#24ABAC", "#359CA8", "#468DA4", "#577DA1", "#686E9D", "#5D6093", "#4B5188", "#39437E", "#283573", "#172869")

p <- chorddiag(tabla, 
               groupColors = paleta, 
               groupnamePadding = 10, 
               height = 500, 
               width = 500,
               margin = 100,
               groupThickness = 0.07,
               groupPadding = 0.8,
               groupnameFontsize = 10,
               fadeLevel = 1,
               chordedgeColor = "#D0D0CF", 
               showTicks = TRUE)

p

require(htmlwidgets)
htmlwidgets::saveWidget(p, paste0(here::here(),"/Graficos/Estado/02_Lugar de nacimiento/2000/MNac a nivel estatal 2000.html"), selfcontained = TRUE)
#require(webshot)
#webshot(url = paste0(here::here(),"/Graficos/Estado/02_Lugar de nacimiento/2000/MNac a nivel estatal 2000.html"),
 #         file = paste0(here::here(),"/Graficos/Estado/02_Lugar de nacimiento/2000/MNac a nivel estatal 2000.png"),
  #                cliprect = "viewport")
```


## Gr谩ficos migraci贸n de nacimiento {.tabset .tabset-pills}

### ChordDiagram

```{r, fig.height=20, fig.width=20, eval = FALSE, class.source = "fold-hide"}
# Paleta de colores
#paleta <- colorRampPalette(LaCroixColoR::lacroix_palette("PassionFruit", n = 50, type = "continuous"))(25)
paleta <- c("#C70E7B", "#D1207C", "#DC327D", "#E7467F", "#F25880", "#F86C7C", "#E58560", "#D49E46", "#C2B72A", "#B0D00F", "#9ADC0E", "#7CD332", "#60CA57", "#43C17B", "#25B99F", "#24ABAC", "#359CA8", "#468DA4", "#577DA1", "#686E9D", "#5D6093", "#4B5188", "#39437E", "#283573", "#172869")

load(file = paste0(here::here(), "/Bases/Estado/02_Lugar de nacimiento/2000/Matriz de migracion de nacimiento 2000.RData"))

tabla <- Migrantes %>%
          sna::diag.remove(remove.val = 0)  

rownames(tabla) <- stringr::str_wrap(nom_estados, 100)
colnames(tabla) <- stringr::str_wrap(nom_estados, 100)

# Paleta de colores
groupColors <- setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla), rownames(tabla))))),
                         nm = str_sort(unique(c(colnames(tabla), rownames(tabla))), numeric = TRUE))

circos.clear()
#svglite::svglite(paste0(here::here(), "/Graficos/Estado/01_Migracion reciente/2000/ChordDiagram de MR5a a nivel estatal.svg"), width = 20, height = 20)
cairo_pdf(paste0(here::here(),"/Graficos/Estado/02_Lugar de nacimiento/2000/ChordDiagram de MNac a nivel estatal.pdf"), 
          width = 7, height = 7, 
          family = "Montserrat Medium",
          fallback_resolution = 400,
          onefile = TRUE)

circos.clear()
circos.par(start.degree = 90, 
           gap.degree = 2, 
           clock.wise = FALSE,
           #track.margin = c(-0.07, 0.07),  # c铆rculo exterior | circulo interior
           track.margin = c(-0.07, 0.1),
           points.overflow.warning = FALSE)

par(mar = rep(0, 4))

chordDiagram(x  = tabla, 
             grid.col = groupColors,
             order = str_sort(unique(c(colnames(tabla), rownames(tabla)))),
             keep.diagonal = FALSE,
             transparency =  0.4,
             directional = 1,
             direction.type = c("arrows", "diffHeight"), 
             diffHeight  = -0.04, # adjust the starting end of the link
             annotationTrack = "grid", 
             annotationTrackHeight = c(0.05, 0.1),
             preAllocateTracks = 1, 
             big.gap = 40, # Gap between row sectors and column sectors.
             link.arr.type = "big.arrow", 
             link.lwd = 3,    # Line width width for link borders
             link.lty = 1,
             link.visible = TRUE,
             link.largest.ontop = TRUE)

# Add text and axis
circos.trackPlotRegion(track.index = 1,
                       track.height = 0.05,
                       bg.border = NA, 
                       panel.fun = function(x, y) {
                                                   xlim = get.cell.meta.data("xlim")
                                                   ylim = get.cell.meta.data("ylim")
                                                   sector.name = get.cell.meta.data("sector.index")
                                                  # Add names to the sector. 
                                                   circos.text(x = mean(xlim), 
                                                               y = ylim[1] + 0.1, 
                                                               labels = sector.name, 
                                                               facing = "clockwise",
                                                               niceFacing = TRUE, 
                                                               adj = c(-0.05, 0.5), #Ajuste de las etiquetas (x, y)
                                                               cex = fontsize(9),
                                                               col = "#172869",
                                                               font = 1)
                                                  # Add graduation on axis
                                                   circos.axis(h = "top",
                                                               labels = c(0, 10, 20, 50, 100, 200, 300, 400, 500, seq(1000, 20000, by = 1000)),
                                                               major.tick.length = 0.5,
                                                               minor.ticks = 4, 
                                                               labels.cex = fontsize(6),
                                                               sector.index = sector.name,
                                                               track.index = 2,
                                                               labels.niceFacing = TRUE,
                                                               labels.pos.adjust = c(0, 0.8))
                                                }
  )
dev.off()
```

### Gr谩fico por estados

Se filtran los flujos migratorios que son exclusivos de los estados y que visualmente sean m谩s interpretables.

```{r, results = FALSE, eval = FALSE}
load(file = paste0(here::here(), "/Bases/Estado/02_Lugar de nacimiento/2000/Matriz de migracion de nacimiento 2000.RData"))

tabla <- Migrantes %>%
          sna::diag.remove(remove.val = 0) 

rownames(tabla) <- stringr::str_wrap(nom_estados, 100)
colnames(tabla) <- stringr::str_wrap(nom_estados, 100)


# Nombre de los estados 
estado <- stringr::str_wrap(nom_estados, 100)

filtro_est <- Migrantes %>%
               as.data.frame() %>%
                tibble::rownames_to_column(var = "rn") %>% 
                 melt(., id.vars = "rn", variable.name = "cn") %>%
                  mutate_if(is.factor, as.character) 

### Sacar el promedio de los flujos migratiorios para determinar como se van a grupar los estados 
#### Es importante correr la tabla1[[x]] sin filtros para determinar el n煤mero promedio de flujos de migraci贸n
#### Filtro <<<<< filter(value > 0 & rn != estado[x]) %>%
#filtro_mig <- sapply(1:32, function(x)
#                      mean(tail(sort(tabla1[[x]]), 1), na.rm = TRUE))
#p <- data.frame(estados = est,
 #               filtro_estados = filtro_mig,
  #               NUM = 1:32)
#write.xlsx(p, file = paste0(here::here(), "/Bases/Estado/02_Lugar de nacimiento/2000/Filtro a nivel estatal.xlsx"))

filtro_mig <- read.xlsx(paste0(here::here(), "/Bases/Estado/02_Lugar de nacimiento/2000/Filtro a nivel estatal.xlsx"), colNames = TRUE) %>% 
               pull(filtro_estados)

tabla1 <- lapply(1:32, function(x){
                         filtro_rn  <- filtro_est %>%
                                        mutate(value = ifelse(.$rn %in% estado[x] | .$cn %in% estado[x], value, 0)) %>%
                                         group_by(rn) %>%
                                          summarise(Inm = sum(value, na.rm = TRUE))

                         filtro_cn  <- filtro_est %>%
                                        mutate(value = ifelse(.$rn %in% estado[x] | .$cn %in% estado[x], value, 0)) %>%
                                         group_by(cn) %>%
                                          summarise(Emg = sum(value, na.rm = TRUE))

                         filtro <- filtro_rn %>%
                                    full_join(., filtro_cn, by = c("rn" = "cn")) %>%
                                     mutate(value = sum_row(.$Inm, .$Emg, na.rm = TRUE)) %>%
                                      filter(value > filtro_mig[x] & rn != estado[x]) %>%
                                       pull(rn)

                          tabla  %>%
                           as.data.frame() %>%
                            tibble::rownames_to_column(var = "rn") %>%
                             melt(., id.vars = "rn", variable.name = "cn") %>%
                              mutate_if(is.factor, as.character) %>%
                               mutate(value = ifelse(.$rn %in% estado[x] | .$cn %in% estado[x], value, 0)) %>%
                                mutate(rn = case_when(.$rn %in% estado[x] ~ .$rn,
                                                      .$rn %in% filtro ~ .$rn,
                                                      .$rn %nin% filtro ~ "Otros estados"),
                                       cn = case_when(.$cn %in% estado[x] ~.$cn, 
                                                      .$cn %in% filtro ~ .$cn,
                                                      .$cn %nin% filtro ~ "Otros estados")) %>%
                                 dcast(., rn ~ cn, value.var = "value", sum,  na.rm = TRUE) %>%                                               
                                  column_to_rownames(., var = "rn") 
  }
)

## Se guardan las matrices de movilidad estudiantil para analizarlos despu茅s. 
wb <- createWorkbook()
for(i in 1:32){
     tabla <- tabla1[[i]] %>%
                as.data.frame() %>%
                 adorn_totals(c("row", "col"), 
                               fill = "-", 
                                na.rm = TRUE, 
                                 name = "Total",,,,contains(colnames(tabla1[[i]])))
                 
     addWorksheet(wb, paste(est[i]))
     writeData(wb, i, tabla, colNames = TRUE, rowNames = TRUE)
     saveWorkbook(wb, 
                  file = paste0(here::here(), "/Output/Estado/02_Lugar de nacimiento/2000/Matriz MNac por estados_2000_Reduccion.xlsx"), 
               overwrite = TRUE)
}
saveRDS(tabla1, file = paste0(here::here(), "/Output/Estado/02_Lugar de nacimiento/2000/Tabla MNac a por estados.RDS"))
```

```{r tablas de matrices}
tabla1 <- readRDS(file = paste0(here::here(), "/Output/Estado/02_Lugar de nacimiento/2000/Tabla MNac a por estados.RDS"))

totales <- lapply(1:length(estados), function(x){
                #Se agrupan los totales
                 full_join(
                           tabla1[[x]] %>%
                            as.data.frame() %>%
                             adorn_totals(c("row", "col"), 
                                          fill = "-", 
                                          na.rm = TRUE, 
                                           ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                              slice(nrow(.)) %>% 
                               t() %>%
                                as.data.frame()%>%
                                 rownames_to_column(var = "name")  %>% 
                                  rename("Total_Filas" = "1"),
                           tabla1[[x]] %>%
                            as.data.frame() %>%
                             adorn_totals(c("row", "col"), 
                                          fill = "-", 
                                          na.rm = TRUE, 
                                           ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                              rownames_to_column(var = "name") %>%
                               select(name, Total) %>%
                                mutate(name = str_replace(.$name, "1$", "Total")), 
                           by = c("name")
                           ) %>%
                           rename("CVE_MUN" = "name",
                                  "Emigrantes" = "Total_Filas",
                                  "Inmigrantes" = "Total") %>%
                            select(Inmigrantes, CVE_MUN, Emigrantes)
  }
)
porcentajes <- lapply(1:length(estados), function(x){
                           #Se agrupan los porcentajes
                           full_join(
                                     tabla1[[x]] %>%
                                      as.data.frame() %>%
                                       adorn_totals(c("col", "row"), 
                                                    fill = "0", 
                                                    na.rm = TRUE, 
                                                    name = "Total",
                                                    ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                        adorn_percentages("col",
                                                          na.rm = TRUE) %>% 
                                         rownames_to_column(var = "name") %>%
                                          select(name, Total) %>%
                                           mutate(name = str_replace(.$name, "1$", "Total")),
                                     tabla1[[x]] %>%
                                      as.data.frame() %>%
                                       adorn_totals(c("row"), 
                                                    fill = "0", 
                                                    na.rm = TRUE, 
                                                    name = "Total", 
                                                    ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                        adorn_percentages("row", 
                                                          na.rm = TRUE, 
                                                         ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                         slice(nrow(.)) %>% 
                                          t() %>%
                                           as.data.frame()%>%
                                            rownames_to_column(var = "name")  %>% 
                                             rename("Total_Filas" = "1"), 
                                     by = c("name")
                                          ) %>%
                                      rename("CVE_MUN" = "name",
                                             "Emigrantes%" = "Total_Filas",
                                             "Inmigrantes%" = "Total") %>%
                                      select(`Inmigrantes%`, CVE_MUN, `Emigrantes%`)
                                   
  }
)

# Se guardan los totales de las matrices reducidas 
wb <- createWorkbook()
for(i in 1:32){
     addWorksheet(wb, paste(est[i]))
     writeData(wb, i, totales[[i]], colNames = TRUE, startCol = 1)
     writeData(wb, i, porcentajes[[i]], colNames = TRUE, startCol = 5)
     saveWorkbook(wb, 
                  file = paste0(here::here(), "/Output/Estado/02_Lugar de nacimiento/2000/Matriz MNac por estados_2000_Reduccion_Totales.xlsx"), 
               overwrite = TRUE)
}
```

```{r, eval = FALSE}
tabla1 <- readRDS(file = paste0(here::here(), "/Output/Estado/02_Lugar de nacimiento/2000/Tabla MNac a por estados.RDS"))

# Paleta de colores
#paleta <- colorRampPalette(LaCroixColoR::lacroix_palette("PassionFruit", n = 50, type = "continuous"))(25)
paleta <- c("#C70E7B", "#D1207C", "#DC327D", "#E7467F", "#F25880", "#F86C7C", "#E58560", "#D49E46", "#C2B72A", "#B0D00F", "#9ADC0E", "#7CD332", "#60CA57", "#43C17B", "#25B99F", "#24ABAC", "#359CA8", "#468DA4", "#577DA1", "#686E9D", "#5D6093", "#4B5188", "#39437E", "#283573", "#172869")

tabla2 <- lapply(1:length(estados), function(x){
                    # Paleta de colores
                       groupColors <- setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))))),
                                               nm = str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))
                        circos.clear()
                         chordDiagram(x  = tabla1[[x]] %>% as.matrix(), 
                                       transparency = 0.4,
                                        order = str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE),
                                         grid.col = groupColors)  %>% 
                          pull(col)
  }
)
```


```{r grafico estatal, eval = FALSE, results='hide'}
cairo_pdf(paste0(here::here(),"/Graficos/Estado/02_Lugar de nacimiento/2000/ChordDiagram de MNac para cada estado.pdf"),
          width = 8,
          height = 8, 
          family = "Montserrat Medium",
          fallback_resolution = 400,
          onefile = TRUE)

for(i in 1:length(estados)){
  
# Paleta de colores
groupColors <- setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]]))))),
                        nm = str_sort(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]]))), numeric = TRUE))

circos.clear()
circos.par(start.degree = 90, 
           gap.degree = 2, 
           clock.wise = FALSE,
           #track.margin = c(-0.07, 0.07),  # c铆rculo exterior | circulo interior
           track.margin = c(-0.07, 0.1),
           points.overflow.warning = FALSE)

par(mar = rep(0, 4))

chordDiagram(x  =  tabla1[[i]] %>% as.matrix(), 
             grid.col = groupColors,
             col = tabla2[[i]],
             order = str_sort(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]])))),
             keep.diagonal = FALSE,
             transparency =  0,
             directional = 1,
             direction.type = c("arrows", "diffHeight"), 
             diffHeight  = -0.04, # adjust the starting end of the link
             annotationTrack = "grid", 
             annotationTrackHeight = c(0.05, 0.1),
             preAllocateTracks = 1, 
             big.gap = 40, # Gap between row sectors and column sectors.
             link.arr.type = "big.arrow", 
             link.lwd = 3,    # Line width width for link borders
             link.lty = 1,
             link.visible = TRUE,
             link.largest.ontop = TRUE)

# Add text and axis
circos.trackPlotRegion(track.index = 1,
                       track.height = 0.05,
                       bg.border = NA, 
                       panel.fun = function(x, y) {
                                                   xlim = get.cell.meta.data("xlim")
                                                   ylim = get.cell.meta.data("ylim")
                                                   sector.name = get.cell.meta.data("sector.index")
                                                  # Add names to the sector. 
                                                   circos.text(x = mean(xlim), 
                                                               y = ylim[1] + 0.1, 
                                                               labels = sector.name, 
                                                               facing = "clockwise",
                                                               niceFacing = TRUE, 
                                                               adj = c(-0.05, 0.5), #Ajuste de las etiquetas (x, y)
                                                               cex = fontsize(9),
                                                               col = "#000C7D",
                                                               font = 1)
                                                  # Add graduation on axis
                                                   circos.axis(h = "top",
                                                               labels = c(0, 10, 20, 50, 100, 200, 300, 400, 500, seq(1000, 20000, by = 1000)),
                                                               major.tick.length = 0.5,
                                                               minor.ticks = 4, 
                                                               labels.cex = fontsize(6),
                                                               sector.index = sector.name,
                                                               track.index = 2,
                                                               labels.niceFacing = TRUE,
                                                               labels.pos.adjust = c(0, 0.8))
                                                }
  )
}
dev.off()
```


**Etiquetas**

```{r etiquetas_estatal}
etiquetas  <- lapply(1:length(estados), function(x){
                        orden <- str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE)
                        p <-  tabla1[[x]] %>% 
                               as.data.frame() %>%
                                tibble::rownames_to_column(var = "rn") %>%
                                 melt(., id.vars = "rn", variable.name = "cn") %>%
                                  as.data.frame() %>% 
                                   mutate(rn = str_wrap(.$rn, 100),
                                          cn = str_wrap(.$cn, 100)) %>%
                                    ggplot() + 
                                     geom_bar(aes(x = value, fill = as.character(rn, orden)))  + 
                                      geom_bar(aes(x = value, fill = as.character(cn, orden)))  + 
                                       theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                                             text = element_text(family = "Montserrat Medium"),
                                             axis.text = element_blank(),
                                             axis.title = element_blank(),
                                             strip.text = element_text(size = 9, face = "bold", family = "Montserrat Medium"),  
                                             legend.key.size = unit(0.4, "cm"), 
                                             legend.spacing.y = unit(0.4, "cm"),
                                             legend.text = element_text(size = 7, family = "Montserrat Medium"),
                                             legend.title = element_text(size = 8 , family = "Montserrat Medium")) + 
                                        scale_fill_manual(values = colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]])))))) + 
                                         guides(fill = guide_legend(ncol = 1)) + 
                                          labs(fill = stringr::str_wrap(paste(nom_estados[x]), 100),
                                               color = stringr::str_wrap(paste(nom_estados[x]), 100))
                         leg <- get_legend(p)
                         as_ggplot(leg)
 })

cairo_pdf(paste0(here::here(), "/Graficos/Estado/02_Lugar de nacimiento/2000/Etiquetas a nivel estatal.pdf"), 
          width = 7, height = 8, 
          fallback_resolution = 400,
          family = "montserrat", onefile = TRUE)
for(i in 1:length(estados)){
  print(etiquetas[i])
}
dev.off()
```

### Gr谩fico Sankey

```{r, eval = FALSE}
load(file = paste0(here::here(), "/Bases/Estado/02_Lugar de nacimiento/2000/Matriz de migracion de nacimiento 2000.RData"))

tabla <- Migrantes %>%
          sna::diag.remove(remove.val = 0) 

#Etiquetas
estados <- est 

colnames(Migrantes) <- estados
rownames(Migrantes) <- estados
```



```{r, eval=FALSE}
tabla <-  Migrantes %>% 
           as.data.frame() %>%
            tibble::rownames_to_column(var = "rn") %>%
             melt(., id.vars = "rn", variable.name = "cn") %>%
              as_tibble() %>%
               mutate(rn = forcats::fct_relevel(.$rn, estados),
                      cn = forcats::fct_relevel(.$cn, estados)) %>%
                filter(value >= 0)   
```



```{r, eval = FALSE}
p <- tabla %>% 
       ggplot(aes(axis1 = rn, 
                   axis2 = cn, 
                    y = value),  # c("value", "freq", "tasa")
               reverse = FALSE, 
                na.rm = TRUE) +
        geom_alluvium(aes(fill = rn),
                       curve_type = "quintic", 
                        color = "transparent", 
                         alpha = 0.7, 
                          lwd = 0.001, 
                           width = 1/5,
                            reverse = FALSE) +
          geom_stratum(aes(fill = cn), 
                        color = "white", 
                         alpha = 0.65,  
                          lwd = 0.001, 
                           width = 1/5,
                            reverse = FALSE) +
           geom_text_repel(aes(label = ifelse(after_stat(x) == 1, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""), 
                               fontface =  ifelse(after_stat(x) == 1, 'bold', 'plain')),
                            stat = "stratum", 
                             size = 3, 
                              direction = "y", 
                               nudge_x = -.2,
                                min.segment.length = unit(1, "lines"),
                                 force = 1,
                                  force_pull = 0,
                                   family = "montserrat",
                                    reverse = FALSE) +
            geom_text_repel(aes(label = ifelse(after_stat(x)  == 2, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                fontface =  ifelse(after_stat(x) == 2, 'bold', 'plain')),
                             stat = "stratum", 
                              size = 3,
                               direction = "y", 
                                nudge_x = .2, 
                                 force = 1,
                                  force_pull = 0,
                                   family = "montserrat",
                                    reverse = FALSE) +
             theme_void() + 
              theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                     text = element_text(family = "montserrat"),
                      axis.text = element_blank(),
                       axis.title = element_blank(),
                        strip.text = element_text(size = 10, face = "bold", family = "montserrat"),
                         legend.key.size = unit(0.5, "cm"),
                          legend.text = element_text(size = 9, family = "montserrat"),
                           legend.position = c(1, .5)) + 
               scale_x_discrete(expand = c(-0.1, 0.35)) +
                scale_fill_viridis_d(option = "A", end = 0.9, begin = 0.2) +
                 guides(fill = guide_legend(ncol = 1, na.translate = F)) + 
                  labs(fill = "", 
                       color = "")

path = paste0(here::here(),"/Graficos/Estado/02_Lugar de nacimiento/2000/GSankey de MNac a nivel estatal.pdf")
ggexport(list = p, width = 14, height = 10, dpi = 400, filename = path)
```


**Desagregado por estado**

```{r, eval = FALSE}
p <- lapply(1:32, function(x){
                   tabla <- tabla %>%
                             mutate(rn = forcats::fct_relevel(.$rn, estados),
                                    cn = forcats::fct_relevel(.$cn, estados)) %>%
                              mutate(value = ifelse((.$rn != .$cn) &.$rn %in% estados[x] | .$cn %in% estados[x], value, 0)) 
 
                    tabla %>% 
                     ggplot(aes(axis1 = rn, 
                                 axis2 = cn, 
                                  y = value),  # c("value", "freq", "tasa")
                             reverse = FALSE, 
                              na.rm = TRUE) + 
                      geom_alluvium(aes(fill = rn),  
                                     color = "transparent", 
                                      alpha = 0.8, 
                                       lwd = 0.001, 
                                        width = 1/5,
                                         reverse = FALSE) +
                       geom_stratum(aes(fill = rn), 
                                     color = "#F1F1F1", 
                                      alpha = 1, 
                                       lwd = 0.001, 
                                        width = 1/5,
                                         reverse = FALSE) +
                         geom_text_repel(aes(label = ifelse(after_stat(x)  == 1, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                             fontface =  ifelse(after_stat(x) == 1, 'bold', 'plain')),
                                           stat = "stratum", 
                                            size = 3,
                                             direction = "y", 
                                              nudge_x = -.2, 
                                               force = 1,
                                                        force_pull = 0,
                                                         family = "montserrat",
                                                          reverse = FALSE) +
                          geom_text_repel(aes(label = ifelse(after_stat(x)  == 2, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                              fontface =  ifelse(after_stat(x) == 2, 'bold', 'plain')),
                                           stat = "stratum", 
                                            size = 3,
                                             direction = "y", 
                                              nudge_x = .2, 
                                               force = 1,
                                                force_pull = 0,
                                                 family = "montserrat",
                                                  reverse = FALSE) +
                            theme_void() + 
                             theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                                    text = element_text(family = "montserrat"),
                                     axis.text = element_blank(),
                                      axis.title = element_blank(),
                                       strip.text = element_text(size = 10, face = "bold", family = "montserrat"),
                                        legend.key.size = unit(0.5, "cm"),
                                         legend.text = element_text(size = 9, family = "montserrat"),
                                          legend.position = c(1, .5)) + 
                              scale_x_discrete(expand = c(-0.1, 0.35)) +
                               scale_fill_viridis_d(option = "A", end = 0.9, begin = 0.2) +
                                guides(fill = guide_legend(ncol = 1, na.translate = F)) + 
                                 labs(fill = "", 
                                      color = "")
              }
        )

path = paste0(here::here(),"/Graficos/Estado/02_Lugar de nacimiento/2000/GSankey de MNac desagregado por estados_Absolutos.pdf")
ggexport(list = p, width = 14, height = 10, dpi = 400, filename = path)
```

## Indicadores {.tabset .tabset-pills}

Se realizan c谩lculos generales de migraci贸n\
- Residentes\
- Inmigrantes\
- Emigrantes\
- % Inmigrantes\
- % Emigrante\
- Migraci贸n bruta\
- Migraci贸n Neta\
- % Tasa de migraci贸n bruta\
- % Tasa de migraci贸n neta

Se trabaja con la matriz cuadrada, la cual de esta manera no se satura la computadora

```{r, eval = FALSE}
################################################################################
############################ Poblaci贸n total ###################################
Pob.Total <- mydata %>%
              as.data.frame() %>%
               group_by(CVE_ENT) %>%
                summarise(Pob.Total = sum(FACTOR)) 

################################################################################
########################### Residentes #########################################
load(file = paste0(here::here(), "/Bases/Estado/02_Lugar de nacimiento/2000/Matriz de migracion de nacimiento 2000.RData"))

rownames(Migrantes) <- str_pad(rep(1:32), width = 3, pad = "0")
colnames(Migrantes) <- str_pad(rep(1:32), width = 3, pad = "0")

Residentes <- Migrantes %>%
               rownames_to_column() %>%
                tidyr::gather(CVE_ENT, Value, -rowname)%>%
                 filter(rowname == CVE_ENT) %>%
                  select(-rowname) %>%
                   droplevels() %>%
                    rename("Residentes" = "Value") 

################################################################################
############################### Inmigrantes ####################################
Inmigrantes <- Migrantes %>% 
                as.data.frame() %>%
                 tibble::rownames_to_column(var = "CVE_ENT") %>%
                  melt(., id.vars = "CVE_ENT", variable.name = "ENT_PAIS_NAC") %>%
                   mutate_at(vars(3), as.numeric) %>%
                    as_tibble() %>%
                     filter(CVE_ENT != ENT_PAIS_NAC) %>%
                      group_by(CVE_ENT) %>%
                       summarise(Inmigrantes = sum(value, na.rm = TRUE))

################################################################################
############################### Emigrantes #####################################
Emigrantes <- Migrantes %>% 
               as.data.frame() %>%
                tibble::rownames_to_column(var = "CVE_ENT") %>%
                 melt(., id.vars = "CVE_ENT", variable.name = "ENT_PAIS_NAC") %>%
                  mutate_at(vars(3), as.numeric) %>%
                   as_tibble() %>%
                    filter(CVE_ENT != ENT_PAIS_NAC) %>%
                     group_by(ENT_PAIS_NAC) %>%
                      summarise(Emigrantes = sum(value, na.rm = TRUE)) %>%
                       rename("CVE_ENT" = "ENT_PAIS_NAC") 

tabla <- Pob.Total %>%
          left_join(., Residentes, by = c("CVE_ENT")) %>%
          left_join(., Inmigrantes, by = c("CVE_ENT")) %>%
          left_join(., Emigrantes, by = c("CVE_ENT")) %>%
           mutate(Mig.Neta = .$Inmigrantes - .$Emigrantes,
                  Mig.Bruta = .$Inmigrantes + .$Emigrantes, 
                  Tasa.Inmig = (.$Inmigrantes/.$Pob.Total)/5*1000,
                  Tasa.Emig = (.$Emigrantes/.$Pob.Total)/5*1000,
                  Tasa.Mig = Tasa.Inmig - Tasa.Emig, 
                  Eficacia = Mig.Neta - Mig.Bruta)

write.xlsx(tabla, file = paste0(here::here(),"/Output/Estado/02_Lugar de nacimiento/2000/Indicadores de migracion de nacimiento a nivel estatal 2000.xlsx"), overwrite = TRUE)

save(tabla, file = paste0(here::here(),"/Output/Estado/02_Lugar de nacimiento/2000/Indicadores de migracion de nacimiento a nivel estatal a nivel estatal 2000.RData"))
```

```{r, echo = FALSE}
load(file = paste0(here::here(),"/Output/Estado/02_Lugar de nacimiento/2000/Indicadores de migracion de nacimiento a nivel estatal a nivel estatal 2000.RData"))

tabla %>%  
 as.data.frame() %>%
  gt() %>% 
   tab_header(title = "Indicadores de  migraci贸n de naciemiento", 
              subtitle = "Nivel estatal") %>%
    tab_options(heading.title.font.size = 12, 
                heading.align = "center",
                heading.subtitle.font.size = 10,
                data_row.padding = px(1),
                column_labels.font.weight = "bold",
                column_labels.padding = px(10), 
                table.font.names = 'montserrat',
                table.font.size = 8) %>%
     tab_style(style = list(cell_text(align = "center",
                                      weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
      fmt_integer(columns = c(2:7, 11), sep_mark = " ") %>%
       fmt_number(columns = c(8:10), decimals = 1) %>%
        sub_missing(columns = everything(), missing_text = "0") %>%
         tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
          as_raw_html()
```


# Referencias

Librerias que se usaron en el documento

```{r, echo = FALSE}
sesion_info <- devtools::session_info()
kable(dplyr::select(tibble::as_tibble(sesion_info$packages %>% dplyr::filter(attached == TRUE)),
                    c(package, loadedversion, source))) %>%
 kable_styling(font_size = 10, 
               bootstrap_options = c("condensed", "responsive", "bordered")) %>%
  kable_classic(full_width = TRUE, html_font = "montserrat") %>% 
   scroll_box(width = "100%", height = "150px") %>%  
    gsub("font-size: initial !important;", "font-size: 10pt !important;", .)
```

