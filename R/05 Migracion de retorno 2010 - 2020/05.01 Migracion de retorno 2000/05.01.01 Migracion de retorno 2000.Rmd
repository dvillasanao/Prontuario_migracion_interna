---
title: "Migración de retorno 2000"
author: "CONAPO"
output:
   html_document:
      highlight: tango
      theme: flatly
      toc: yes
      toc_depth: 2
      toc_float:
        collapsed: yes
---

\usepackage{color}

```{=html}
<style>
code.r{
  font-size: 10px;
}
pre {
  font-size: 12px
}
</style>

<style>
body {
text-align: justify;
font-style: normal;
font-family: "Montserrat";
font-size: 12px
}
h1.title {
  font-size: 40px;
  color: #000D3B;
}
h1 {
  color: #B6854D;
}
h2 {
  color: #172984;
}
h3 {
  color: #172984;
}
</style>
```

```{=html}
<style>
.nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #0A2687;
}
.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
    color: #ffffff;
    background-color: #09C2BC;
}
</style>
```

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE, cache.lazy = FALSE, 
                         eval = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(digits = 2, encoding = "UTF8")
```   
 

```{r, echo=FALSE}
rm(list = ls())
```

```{r, echo=FALSE}
setwd(here::here())
```


```{r, echo=FALSE}
#Font Stlye
require(showtext)
library(extrafont)
# activar showtext
# SE cargan las funtes del sitema Windows (Pero tarda en correr)
#ttf_import('C:/Users/dvill/AppData/Local/Microsoft/Windows/Fonts/')
#fonts()
#extrafont::loadfonts(device = "win")
#font_import()
windowsFonts()
```


```{r, echo = FALSE}
# Librerías que se usaron en el documCVE_ENTo
require(chorddiag)
require(circlize)
require(Cairo)
require(haven)
require(Hmisc) # %nin%
require(dplyr)
require(survey)
require(srvyr)
require(stringr)
require(sna)
require(expss)
require(knitr)
require(kableExtra)
require(sjlabelled)
require(gt)
require(ggplot2)
require(ggpubr)
require(ggalluvial)
require(ggsankey)
require(ggrepel)
require(janitor)
require(tibble)
require(tidyr)
require(reshape2)
require(openxlsx)
require(doMC)
registerDoMC(cores = 18)
```

**Cuestionario Ampliado del Censo de Población y Vivienda 2000**

El cuestionario ampliado se guarda en un un archivo `.RData`.

```{r, eval = FALSE}
data <- read_sav("~/Cuestionario Ampliado_2000_Persona.sav")

#data <- data %>%
 #     select(., c(1:96, 101:103))
save(data, 
      file = paste0(here::here(),"/Bases/Censo_Personas_2000.RData"))
```

Se seleccionan las variables que se desean conservar para la realización de este documento y se guarda en un archivo `.RData` para practicidad del manejo de datos. 

**Posibles variables que se pueden contemplar en la migración de retorno**     

- `EDAD`, 
- `SEXO`
- `AFRODES`  
- `HLENGUA`   
- `QDIALECT_INALI`
- `PERTE_INDIGENA`  
- `NIVACAD`
- `ALFABET` 
- `CAUSA_MIG`  
- `SITUA_CONYUGAL`  
- `CONACT`  
- `HIJOS_NAC_VIVOS`   


**Se clasifican a los migrantes de retorno**    

```{r, eval = FALSE}
load(paste0(here::here(),"/Bases/Censo_Personas_2000.RData"))

# Clave de los estados
tablas <- str_pad(rep(1:32), width = 3, pad = "0")

mydata <- data %>%
           select(CVE_ENT, NOM_ENT, MUN, NOM_MUN, CVE_MUN, LNACEDO_C, CVE_MUN_RES, RES95EDO_C, MUN95OTR_C, CAUEMI,
                  EDAD, SEXO, HLENGUA, QDIALECT_C, PERETN, ESTCON, NIVACAD, ESCOLARI, ALFABET, 
                  CONACT, SITTRA, FACTOR, ESTRATO, UPM) %>%
            rename("ENT_PAIS_NAC" = "LNACEDO_C") %>%
             mutate(CVE_ENT = str_pad(.$CVE_ENT, width = 3, side = c("left"), pad = "0")) %>%
             mutate(ENT_PAIS_NAC = case_when(.$ENT_PAIS_NAC %in% tablas ~.$ENT_PAIS_NAC,
                                              is.na(.$ENT_PAIS_NAC) ~ "0",
                                             .$ENT_PAIS_NAC %in% "900" ~ "900",
                                             .$ENT_PAIS_NAC %in% "999" ~ "999",
                                             .$ENT_PAIS_NAC %nin% c(tablas, "900", "999") ~ "888" #Nacio en otro país
                                             ),
                    RES95EDO_C = case_when(.$RES95EDO_C %in% tablas ~.$RES95EDO_C,
                                           .$RES95EDO_C %in% "" ~ "0",
                                           .$RES95EDO_C %in% "900" ~ "900",
                                           .$RES95EDO_C %in% "999" ~ "999",
                                           .$RES95EDO_C %nin% c(tablas, "900", "999") ~ "888" #Residencia en otro país
                                           )) %>% 
               mutate(I_Condicion_Nacimiento = case_when(.$ENT_PAIS_NAC  == "888" ~ "888",
                                                         .$ENT_PAIS_NAC == "900" ~ "900",
                                                         .$ENT_PAIS_NAC == "999" ~ "999",
                                                         .$CVE_ENT == .$ENT_PAIS_NAC ~ "1",
                                                         .$CVE_ENT != .$ENT_PAIS_NAC ~ "2", 
                                                          TRUE ~ "0"
                                                        ),
                      I_Condicion_Residencia1995 = case_when(.$RES95EDO_C == "0" ~ "0", # Población que no entra en esta categoría 
                                                             .$RES95EDO_C == "888" ~ "888",
                                                             .$RES95EDO_C == "900" ~ "900",
                                                             .$RES95EDO_C == "999" ~ "999",
                                                             .$CVE_ENT == .$RES95EDO_C ~ "1",
                                                             .$CVE_ENT != .$RES95EDO_C ~ "2",
                                                              TRUE ~ "0")) %>%
################################################# Indicador de migración de retorno #######################################################
                mutate(I_Migrante_Retorno = case_when(.$I_Condicion_Residencia1995 == "2" & .$I_Condicion_Nacimiento == "1" ~ "Migrante de retorno",
                                                      .$I_Condicion_Residencia1995 == "2" & .$I_Condicion_Nacimiento == "2" ~ "Inmigrante", 
                                                      .$I_Condicion_Residencia1995 == "2" & .$I_Condicion_Nacimiento == "888" ~ "De otro país",    
                                                      .$I_Condicion_Residencia1995 == "2" & .$I_Condicion_Nacimiento == "900" ~ "No especificó de entidad federativa",                                                        
                                                      .$I_Condicion_Residencia1995 == "2" & .$I_Condicion_Nacimiento == "999" ~ "No especificado", 
                                                       TRUE ~ "0")) 

save(mydata, file = paste0(here::here(),"/Bases/05_Migracion de retorno_2000.RData"))
```

Se carga el archivo `Migracion de retorno_2000.RData`.   

```{r}
load(file = paste0(here::here(), "/Bases/05_Migracion de retorno_2000.RData"))

#Para fines prácticos se genera un ponderador de uno 
mydata <- mydata %>%
           select(CVE_ENT, NOM_ENT, ENT_PAIS_NAC, RES95EDO_C, EDAD, 
                  I_Condicion_Nacimiento, I_Condicion_Residencia1995, I_Migrante_Retorno, FACTOR, ESTRATO, UPM) %>%
            mutate(M = 1)  %>%
             ungroup()
```

**Claves de entidades y municipios**

**Entidades**
Se genera un vector con el nombre de las entidades llamado `estados` para facilitar los filtros en el documento.     
Se genera un vector con las abreviaturas de las entidades llamado `ent` para fines prácticos.     

```{r}
# Claves de los estados
estados <- sjlabelled::get_labels(mydata$CVE_ENT)
nom_estados <- c( "Aguascalientes", "Baja California" ,"Baja California Sur", "Campeche", "Coahuila de Zaragoza",
                  "Colima", "Chiapas", "Chihuahua", "Ciudad de México", "Durango", 
                  "Guanajuato", "Guerrero", "Hidalgo", "Jalisco",  "México", 
                  "Michoacán de Ocampo", "Morelos", "Nayarit", "Nuevo León", "Oaxaca", 
                  "Puebla", "Querétaro", "Quintana Roo", "San Luis Potosí", "Sinaloa", 
                  "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala","Veracruz de Ignacio de la Llave", 
                  "Yucatán", "Zacatecas")
est <- c("AGS", "BC", "BCS", "CAMP", "COAH", "COL", "CHIS", "CHIH", "CDMX", "DGO", "GTO", "GRO", "HGO",
         "JAL", "MEX", "MICH", "MOR", "NAY", "NL", "OAX", "PUE", "QRO", "QROO", "SLP","SIN","SON", "TAB", 
         "TAMS", "TLX", "VER", "YUC", "ZAC")

# Se le asignan las etiquetas a los nombres de los estados 
levels(mydata$NOM_ENT) <- estados
```


**Población de retorno de 5 años y más **    

Se identifica a la población de retorno de 5 años y más.

`filter(EDAD >= 3 & EDAD <= 130)'.`    

```{r}
# Clave de los estados
tablas <- str_pad(rep(1:32), width = 3, pad = "0")

tabla <- mydata %>%
          as.data.frame() %>%
           mutate(EDAD = as.numeric(.$EDAD)) %>%
            subset(EDAD >= 5 & EDAD <= 130) %>%
             filter(CVE_ENT %in% tablas & I_Migrante_Retorno %in% "Migrante de retorno")  # Filtro de migrantes de retorno.
```


```{r, echo = FALSE}
# Población de retorno de 5 años y más
tabla <- tabla %>%
          summarise(Pob.retorno = sum(.$FACTOR))

as.integer(tabla) %>%  
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(.,big.mark = " ", preserve.width = "none"))) %>%
   gt() %>% 
    tab_header(title = "Población de retorno de 5 años y más") %>%
     tab_options(heading.title.font.size = 12, 
                 heading.align = "center",
                 heading.subtitle.font.size = 10,
                 table.align = "center",
                 column_labels.font.weight = "bold",
                 table.font.names = 'montserrat',
                 table.font.size = 8) %>%  
       as_raw_html()
```

# Muestro Complejo 

Se utiliza la paquetería `survey` para poder trabajar con la muestra del cuestionario ampliado, en la cual se selecciona a la Población de retorno de 5 años y más.   

```{r}
options(survey.lonely.psu = "adjust")

MC <- mydata %>%
       as.data.frame() %>%
        mutate(EDAD = as.numeric(.$EDAD)) %>%
         subset(EDAD >= 5 & EDAD <= 130) %>%
          filter(CVE_ENT %in% estados & I_Migrante_Retorno %in% "Migrante de retorno") %>% # Filtro de migrantes de retorno.
           svydesign(data = ., id = ~ UPM, strata = ~ESTRATO, weight = ~FACTOR, nest = T)

saveRDS(MC, file = paste0(here::here(), "/Output/Estado/05_Migracion de retorno/2000/MC_estado.RDS"))
```


# Nivel estatal {.tabset .tabset-pills}

## Migración de retorno  {.tabset .tabset-pills}  

Se genera una matriz cruzada del lugar de residencia hace 5 años a nivel estatal, utilizando la función `svytable` de la paquetería `survey`.  

```{r}
MC <- readRDS(file = paste0(here::here(), "/Output/Estado/05_Migracion de retorno/2000/MC_estado.RDS"))

Migrantes <- svytable(~RES95EDO_C + CVE_ENT, design = MC) 
```


Se quita la diagonal a la matriz cruadrada y se le asignan los nombres de los estados.  

```{r}
Migrantes <- Migrantes %>%
              as.data.frame() %>%
               expss::cross_cases(CVE_ENT, RES95EDO_C, weight = Freq) %>%
                as.data.frame() %>%
                 slice(-33) %>% 
                  select(-row_labels) #%>%

rownames(Migrantes)<- nom_estados
colnames(Migrantes) <- nom_estados

wb <- createWorkbook()
addWorksheet(wb, "MRt. 2000")
writeData(wb, 1, Migrantes, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2000/Matriz de MRt a nivel estatal 2000.xlsx"), overwrite = TRUE)

save(Migrantes, file = paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2000/Matriz de MRt a nivel estatal 2000.RData"))
```


**Matriz de migración de retorno a nivel estatal**  

<div style="height:500px;overflow:auto;">
```{r, echo = FALSE}
load(file = paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2000/Matriz de MRt a nivel estatal 2000.RData"))

tabla <- Migrantes %>%
          as.data.frame() %>%
           tibble::rownames_to_column() 

tabla %>%  
 gt() %>% 
  tab_header(title = "Matriz de migración de retorno, 2000", 
             subtitle = "Nivel estatal") %>%
   tab_options(heading.title.font.size = 12, 
               heading.align = "center",
               heading.subtitle.font.size = 10,
               data_row.padding = px(1),
               column_labels.font.weight = "bold",
               column_labels.padding = px(10), 
               table.font.names = 'montserrat',
               table.font.size = 8) %>%
    tab_style(style = list(cell_text(align = "center",
                                     weight = 'bold')),
              locations = list(cells_title(groups = c("title")))) %>%
  
     tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
      sub_missing(columns = everything(), missing_text = "0") %>%
       as_raw_html()
```
</div>


## Gráfico dinámico 

Gráfico dinámico de migración de retorno a nivel estatal.

```{r, fig.width=7, fig.height=5, fig.align='center'}
#devtools::install_github("mattflor/chorddiag")
require(chorddiag)

load(file = paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2000/Matriz de MRt a nivel estatal 2000.RData"))

tabla <- Migrantes %>%
          sna::diag.remove(remove.val = 0) 

# Paleta de colores
groupColors <- colorRampPalette(pals::parula(100))(50)

p <- chorddiag(tabla, 
               groupColors = groupColors, 
               groupnamePadding = 10, 
               height = 500, 
               width = 500,
               margin = 100,
               groupThickness = 0.07,
               groupPadding = 0.8,
               groupnameFontsize = 10,
               fadeLevel = 1,
               chordedgeColor = "#D0D0CF", 
               showTicks = TRUE)

p
require(htmlwidgets)
htmlwidgets::saveWidget(p, paste0(here::here(),"/Graficos/Estado/05_Migracion de retorno/2000/MRt a nivel estatal 2000.html"), selfcontained = TRUE)
#require(webshot)
#webshot(url = paste0(here::here(),"/Graficos/Estado/05_Migracion de retorno/2000/MRt a nivel estatal 2000.html"),
 #         file = paste0(here::here(),"/Graficos/Estado/05_Migracion de retorno/2000/MRt a nivel estatal 2000.png"),
  #                cliprect = "viewport")
```


## Gráficos migración de retorno {.tabset .tabset-pills}

### ChordDiagram 


```{r, fig.height=20, fig.width=20, eval = FALSE, class.source = "fold-hide"}
# Paleta de colores
paleta <- colorRampPalette(pals::parula(100))(50)

load(file = paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2000/Matriz de MRt a nivel estatal 2000.RData"))

tabla <- Migrantes %>% as.matrix()

rownames(tabla) <- stringr::str_wrap(nom_estados, 50)
colnames(tabla) <- stringr::str_wrap(nom_estados, 50)

# Paleta de colores
groupColors <- setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla), rownames(tabla))))),
                         nm = str_sort(unique(c(colnames(tabla), rownames(tabla))), numeric = TRUE))

circos.clear()
cairo_pdf(paste0(here::here(),"/Graficos/Estado/05_Migracion de retorno/2000/ChordDiagram de MRt a nivel estatal.pdf"), 
          width = 7, height = 7, 
          family = "Montserrat Medium",
          fallback_resolution = 400,
          onefile = TRUE)

circos.clear()
circos.par(start.degree = 90, 
           gap.degree = 2, 
           clock.wise = FALSE,
           #track.margin = c(-0.07, 0.07),  # círculo exterior | circulo interior
           track.margin = c(-0.07, 0.1),
           points.overflow.warning = FALSE)

par(mar = rep(0, 4))

chordDiagram(x  = tabla, 
             grid.col = groupColors,
             order = str_sort(unique(c(colnames(tabla), rownames(tabla)))),
             keep.diagonal = FALSE,
             transparency =  0.4,
             directional = 1,
             direction.type = c("arrows", "diffHeight"), 
             diffHeight  = -0.04, # adjust the starting end of the link
             annotationTrack = "grid", 
             annotationTrackHeight = c(0.05, 0.1),
             preAllocateTracks = 1, 
             big.gap = 40, # Gap between row sectors and column sectors.
             link.arr.type = "big.arrow", 
             link.lwd = 3,    # Line width width for link borders
             link.lty = 1,
             link.visible = TRUE,
             link.largest.ontop = TRUE)

# Add text and axis
circos.trackPlotRegion(track.index = 1,
                       track.height = 0.05,
                       bg.border = NA, 
                       panel.fun = function(x, y) {
                                                   xlim = get.cell.meta.data("xlim")
                                                   ylim = get.cell.meta.data("ylim")
                                                   sector.name = get.cell.meta.data("sector.index")
                                                  # Add names to the sector. 
                                                   circos.text(x = mean(xlim), 
                                                               y = ylim[1] + 0.1, 
                                                               labels = sector.name, 
                                                               facing = "clockwise",
                                                               niceFacing = TRUE, 
                                                               adj = c(-0.05, 0.5), #Ajuste de las etiquetas (x, y)
                                                               cex = fontsize(9),
                                                               col = "#000C7D",
                                                               font = 1)
                                                  # Add graduation on axis
                                                   circos.axis(h = "top",
                                                               labels = c(0, 10, 20, 50, 100, 200, 300, 400, 500, seq(1000, 20000, by = 1000)),
                                                               major.tick.length = 0.5,
                                                               minor.ticks = 4, 
                                                               labels.cex = fontsize(6),
                                                               sector.index = sector.name,
                                                               track.index = 2,
                                                               labels.niceFacing = TRUE,
                                                               labels.pos.adjust = c(0, 0.8))
                                                }
  )
dev.off()
```

### Gráfico por estados

Se filtran los flujos migratorios que son exclusivos de los estados y que visualmente sean más interpretables.

```{r, results = FALSE, eval = FALSE}
load(file = paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2000/Matriz de MRt a nivel estatal 2000.RData"))

tabla <- Migrantes %>%
          sna::diag.remove(remove.val = 0) 

rownames(tabla) <- stringr::str_wrap(nom_estados, 100)
colnames(tabla) <- stringr::str_wrap(nom_estados, 100)


# Nombre de los estados 
estado <- stringr::str_wrap(nom_estados, 100)

filtro_est <- Migrantes %>%
               as.data.frame() %>%
                tibble::rownames_to_column(var = "rn") %>% 
                 melt(., id.vars = "rn", variable.name = "cn") %>%
                  mutate_if(is.factor, as.character) 

### Sacar el promedio de los flujos migratiorios para determinar como se van a grupar los estados 
#### Es importante correr la tabla1[[x]] sin filtros para determinar el número promedio de flujos de migración
#### Filtro <<<<< filter(value > 0 & rn != estado[x]) %>%
#filtro_mig <- sapply(1:32, function(x)
 #                     mean(tail(sort(tabla1[[x]]), 1), na.rm = TRUE))

#p <- data.frame(estados = est,
 #               filtro_estados = filtro_mig,
                 #NUM = 1:32)
#write.xlsx(p, file = paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2000/Filtro a nivel estatal.xlsx"))

filtro_mig <- read.xlsx(paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2000/Filtro a nivel estatal.xlsx"), colNames = TRUE) %>% 
               pull(filtro_estados)

tabla1 <- lapply(1:32, function(x){
                         filtro_rn  <- filtro_est %>%
                                        mutate(value = ifelse(.$rn %in% estado[x] | .$cn %in% estado[x], value, 0)) %>%
                                         group_by(rn) %>%
                                          summarise(Inm = sum(value, na.rm = TRUE))

                         filtro_cn  <- filtro_est %>%
                                        mutate(value = ifelse(.$rn %in% estado[x] | .$cn %in% estado[x], value, 0)) %>%
                                         group_by(cn) %>%
                                          summarise(Emg = sum(value, na.rm = TRUE))

                         filtro <- filtro_rn %>%
                                    full_join(., filtro_cn, by = c("rn" = "cn")) %>%
                                     mutate(value = sum_row(.$Inm, .$Emg, na.rm = TRUE)) %>%
                                      filter(value > filtro_mig[x] & rn != estado[x]) %>%
                                       pull(rn)

                          tabla  %>%
                           as.data.frame() %>%
                            tibble::rownames_to_column(var = "rn") %>%
                             melt(., id.vars = "rn", variable.name = "cn") %>%
                              mutate_if(is.factor, as.character) %>%
                               mutate(value = ifelse(.$rn %in% estado[x] | .$cn %in% estado[x], value, 0)) %>%
                                mutate(rn = case_when(.$rn %in% estado[x] ~ .$rn,
                                                      .$rn %in% filtro ~ .$rn,
                                                      .$rn %nin% filtro ~ "Otros estados"),
                                       cn = case_when(.$cn %in% estado[x] ~.$cn, 
                                                      .$cn %in% filtro ~ .$cn,
                                                      .$cn %nin% filtro ~ "Otros estados")) %>%
                                 dcast(., rn ~ cn, value.var = "value", sum,  na.rm = TRUE) %>%                                               
                                  column_to_rownames(., var = "rn") 
  }
)

## Se guardan las matrices de movilidad estudiantil para analizarlos después. 
wb <- createWorkbook()
for(i in 1:32){
     tabla <- tabla1[[i]] %>%
                as.data.frame() %>%
                 adorn_totals(c("row", "col"), 
                               fill = "-", 
                                na.rm = TRUE, 
                                 name = "Total",,,,contains(colnames(tabla1[[i]])))
                 
     addWorksheet(wb, paste(est[i]))
     writeData(wb, i, tabla, colNames = TRUE, rowNames = TRUE)
     saveWorkbook(wb, 
                  file = paste0(here::here(), "/Output/Estado/05_Migracion de retorno/2000/Matriz MRt por estados_2000_Reduccion.xlsx"), 
               overwrite = TRUE)
}

saveRDS(tabla1, file = paste0(here::here(), "/Output/Estado/05_Migracion de retorno/2000/Tabla MRt a nivel estatal.RDS"))
```

```{r tablas de matrices}
tabla1 <- readRDS(file = paste0(here::here(), "/Output/Estado/05_Migracion de retorno/2000/Tabla MRt a nivel estatal.RDS"))

totales <- lapply(1:length(estados), function(x){
                #Se agrupan los totales
                 full_join(
                           tabla1[[x]] %>%
                            as.data.frame() %>%
                             adorn_totals(c("row", "col"), 
                                          fill = "-", 
                                          na.rm = TRUE, 
                                           ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                              slice(nrow(.)) %>% 
                               t() %>%
                                as.data.frame()%>%
                                 rownames_to_column(var = "name")  %>% 
                                  rename("Total_Filas" = "1"),
                           tabla1[[x]] %>%
                            as.data.frame() %>%
                             adorn_totals(c("row", "col"), 
                                          fill = "-", 
                                          na.rm = TRUE, 
                                           ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                              rownames_to_column(var = "name") %>%
                               select(name, Total) %>%
                                mutate(name = str_replace(.$name, "1$", "Total")), 
                           by = c("name")
                           ) %>%
                           rename("CVE_ENT" = "name",
                                  "Migrantes de retorno" = "Total_Filas",
                                  "Entidad de residencia 5a" = "Total") %>%
                            select(`Migrantes de retorno`, CVE_ENT, `Entidad de residencia 5a`)
  }
)
porcentajes <- lapply(1:length(estados), function(x){
                           #Se agrupan los porcentajes
                           full_join(
                                     tabla1[[x]] %>%
                                      as.data.frame() %>%
                                       adorn_totals(c("col", "row"), 
                                                    fill = "0", 
                                                    na.rm = TRUE, 
                                                    name = "Total",
                                                    ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                        adorn_percentages("col",
                                                          na.rm = TRUE) %>% 
                                         rownames_to_column(var = "name") %>%
                                          select(name, Total) %>%
                                           mutate(name = str_replace(.$name, "1$", "Total")),
                                     tabla1[[x]] %>%
                                      as.data.frame() %>%
                                       adorn_totals(c("row"), 
                                                    fill = "0", 
                                                    na.rm = TRUE, 
                                                    name = "Total", 
                                                    ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                        adorn_percentages("row", 
                                                          na.rm = TRUE, 
                                                         ,,,,contains(str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) %>%
                                         slice(nrow(.)) %>% 
                                          t() %>%
                                           as.data.frame()%>%
                                            rownames_to_column(var = "name")  %>% 
                                             rename("Total_Filas" = "1"), 
                                     by = c("name")
                                          ) %>%
                                       rename("CVE_ENT" = "name",
                                              "Migrantes de retorno%" = "Total_Filas",
                                              "Entidad de residencia 5a%" = "Total") %>%
                                      select(`Migrantes de retorno%`, CVE_ENT, `Entidad de residencia 5a%`)
                                   
  }
)

# Se guardan los totales de las matrices reducidas 
wb <- createWorkbook()
for(i in 1:32){
     addWorksheet(wb, paste(est[i]))
     writeData(wb, i, totales[[i]], colNames = TRUE, startCol = 1)
     writeData(wb, i, porcentajes[[i]], colNames = TRUE, startCol = 5)
     saveWorkbook(wb, 
                  file = paste0(here::here(), "/Output/Estado/05_Migracion de retorno/2000/Matriz MRt por estados_2000_Reduccion_Totales.xlsx"), 
               overwrite = TRUE)
}
```


```{r}
tabla1 <- readRDS(file = paste0(here::here(), "/Output/Estado/05_Migracion de retorno/2000/Tabla MRt a nivel estatal.RDS"))

paleta <- c("#352A87", "#3436A2", "#2A45BC", "#1556D5", "#0963DC", "#066FDD", "#0E78D9", "#1180D5", "#1089D2", "#0995D1", "#069DCB", "#06A5C5", "#0AAABC", "#17B0B0", "#27B4A5", "#3DB999", "#55BC8C", "#6EBE7F", "#87BE75", "#9CBE6C", "#B0BC64", "#C3BB5C", "#D5B955", "#E7B94C", "#F5BB40", "#FBC434", "#FACF2A")

tabla2 <- lapply(1:length(estados), function(x){
                    # Paleta de colores
                       groupColors <- setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))))),
                                               nm = str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))
                        circos.clear()
                         chordDiagram(x  = tabla1[[x]] %>% as.matrix(), 
                                       transparency = 0.4,
                                        order = str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE),
                                         grid.col = groupColors)  %>% 
                          pull(col)
  }
)
```

```{r, eval = FALSE}
cairo_pdf(paste0(here::here(),"/Graficos/Estado/05_Migracion de retorno/2000/ChordDiagram de MRt para cada estado.pdf"), 
          width = 8,
          height = 8, 
          family = "Montserrat Medium",
          fallback_resolution = 400,
          onefile = TRUE)

for(i in 1:length(estados)){
  
# Paleta de colores
groupColors <- setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]]))))),
                        nm = str_sort(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]]))), numeric = TRUE))

circos.clear()
circos.par(start.degree = 90, 
           gap.degree = 2, 
           clock.wise = FALSE,
           #track.margin = c(-0.07, 0.07),  # círculo exterior | circulo interior
           track.margin = c(-0.07, 0.1),
           points.overflow.warning = FALSE)

par(mar = rep(0, 4))

chordDiagram(x  =  tabla1[[i]] %>% as.matrix(), 
             grid.col = groupColors,
             col = tabla2[[i]],
             order = str_sort(unique(c(colnames(tabla1[[i]]), rownames(tabla1[[i]])))),
             keep.diagonal = FALSE,
             transparency =  0,
             directional = 1,
             direction.type = c("arrows", "diffHeight"), 
             diffHeight  = -0.04, # adjust the starting end of the link
             annotationTrack = "grid", 
             annotationTrackHeight = c(0.05, 0.1),
             preAllocateTracks = 1, 
             big.gap = 40, # Gap between row sectors and column sectors.
             link.arr.type = "big.arrow", 
             link.lwd = 3,    # Line width width for link borders
             link.lty = 1,
             link.visible = TRUE,
             link.largest.ontop = TRUE)

# Add text and axis
circos.trackPlotRegion(track.index = 1,
                       track.height = 0.05,
                       bg.border = NA, 
                       panel.fun = function(x, y) {
                                                   xlim = get.cell.meta.data("xlim")
                                                   ylim = get.cell.meta.data("ylim")
                                                   sector.name = get.cell.meta.data("sector.index")
                                                  # Add names to the sector. 
                                                   circos.text(x = mean(xlim), 
                                                               y = ylim[1] + 0.1, 
                                                               labels = sector.name, 
                                                               facing = "clockwise",
                                                               niceFacing = TRUE, 
                                                               adj = c(-0.05, 0.5), #Ajuste de las etiquetas (x, y)
                                                               cex = fontsize(9),
                                                               col = "#000C7D",
                                                               font = 1)
                                                  # Add graduation on axis
                                                   circos.axis(h = "top",
                                                               labels = c(0, 10, 20, 50, 100, 200, 300, 400, 500, seq(1000, 20000, by = 1000)),
                                                               major.tick.length = 0.5,
                                                               minor.ticks = 4, 
                                                               labels.cex = fontsize(6),
                                                               sector.index = sector.name,
                                                               track.index = 2,
                                                               labels.niceFacing = TRUE,
                                                               labels.pos.adjust = c(0, 0.8))
                                                }
  )
}
dev.off()
```



```{r etiquetas_estatal}
etiquetas  <- lapply(1:length(estados), function(x){
                        orden <- str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE)
                        p <-  tabla1[[x]] %>% 
                               as.data.frame() %>%
                                tibble::rownames_to_column(var = "rn") %>%
                                 melt(., id.vars = "rn", variable.name = "cn") %>%
                                  as.data.frame() %>% 
                                   mutate(rn = str_wrap(.$rn, 100),
                                          cn = str_wrap(.$cn, 100)) %>%
                                    ggplot() + 
                                     geom_bar(aes(x = value, fill = as.character(rn, orden)))  + 
                                      geom_bar(aes(x = value, fill = as.character(cn, orden)))  + 
                                       theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                                             text = element_text(family = "Montserrat Medium"),
                                             axis.text = element_blank(),
                                             axis.title = element_blank(),
                                             strip.text = element_text(size = 9, face = "bold", family = "Montserrat Medium"),  
                                             legend.key.size = unit(0.4, "cm"), 
                                             legend.spacing.y = unit(0.4, "cm"),
                                             legend.text = element_text(size = 7, family = "Montserrat Medium"),
                                             legend.title = element_text(size = 8 , family = "Montserrat Medium")) + 
                                        scale_fill_manual(values = setNames(colorRampPalette(paleta)(length(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))))),
                        nm = str_sort(unique(c(colnames(tabla1[[x]]), rownames(tabla1[[x]]))), numeric = TRUE))) + 
                                         guides(fill = guide_legend(ncol = 1)) + 
                                          labs(fill = stringr::str_wrap(paste(nom_estados[x]), 100),
                                               color = stringr::str_wrap(paste(nom_estados[x]), 100))
                         leg <- get_legend(p)
                         as_ggplot(leg)
 })

cairo_pdf(paste0(here::here(), "/Graficos/Estado/05_Migracion de retorno/2000/Etiquetas a nivel estatal.pdf"),
          width = 7, height = 8, 
          fallback_resolution = 400,
          family = "montserrat", onefile = TRUE)
for(i in 1:length(estados)){
  print(etiquetas[i])
}
dev.off()
```


### Gráfico Sankey

```{r, eval = FALSE}
## Variable `Migrantes`  se vuelve a recalcular. 
Migrantes <- svytable(~ENT + RES95EDO_C, design = MC)  


# Para evitar estar recalculando el muestreo complejo, se le nombra como un data.frame a la variable `Migrantes`  previamente calculada.
# Se remueve la diagonal para quedarnos con los flujos migratorios a nivel estatal.  
Migrantes <- Migrantes %>%
              as.data.frame() %>%
               expss::cross_cases(ENT, RES95EDO_C, weight = Freq) %>%
                as.data.frame() %>%
                 slice(-33) %>% 
                  select(-row_labels) %>% 
                   sna::diag.remove(remove.val = 0)

estados <- est 

rownames(Migrantes) <- estados
colnames(Migrantes) <- estados
```

**Gráficos Sankey por estados**

```{r, eval = FALSE}
# Matiz de migración de retorno
tabla <- Migrantes %>% 
          as.data.frame() %>%
           tibble::rownames_to_column(var = "rn") %>%
            melt(., id.vars = "rn", variable.name = "cn") %>%
             as_tibble() %>%
              mutate(rn = forcats::fct_relevel(.$rn, estados),
                     cn = forcats::fct_relevel(.$cn, estados))
```


```{r, eval = FALSE}
p <- tabla %>% 
       ggplot(aes(axis1 = rn, 
                   axis2 = cn, 
                    y = value),  # c("value", "freq", "tasa")
               reverse = FALSE, 
                na.rm = TRUE) +
        geom_alluvium(aes(fill = rn),
                       curve_type = "quintic", 
                        color = "transparent", 
                         alpha = 0.85, 
                          lwd = 0.001, 
                           width = 1/5,
                            reverse = FALSE) +
          geom_stratum(aes(fill = cn), 
                        color = "white", 
                         alpha = 0.65,  
                          lwd = 0.001, 
                           width = 1/5,
                            reverse = FALSE) +
           geom_text_repel(aes(label = ifelse(after_stat(x) == 1, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""), 
                               fontface =  ifelse(after_stat(x) == 1, 'bold', 'plain')),
                            stat = "stratum", 
                             size = 3, 
                              direction = "y", 
                               nudge_x = -.2,
                                min.segment.length = unit(1, "lines"),
                                 force = 1,
                                  force_pull = 0,
                                   family = "montserrat",
                                    reverse = FALSE) +
            geom_text_repel(aes(label = ifelse(after_stat(x)  == 2, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                fontface =  ifelse(after_stat(x) == 2, 'bold', 'plain')),
                             stat = "stratum", 
                              size = 3,
                               direction = "y", 
                                nudge_x = .2, 
                                 force = 1,
                                  force_pull = 0,
                                   family = "montserrat",
                                    reverse = FALSE) +
             theme_void() + 
              theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                     text = element_text(family = "montserrat"),
                      axis.text = element_blank(),
                       axis.title = element_blank(),
                        strip.text = element_text(size = 10, face = "bold", family = "montserrat"),
                         legend.key.size = unit(0.5, "cm"),
                          legend.text = element_text(size = 9, family = "montserrat"),
                           legend.position = c(1, .5)) + 
               scale_x_discrete(expand = c(-0.1, 0.35)) +
                scale_fill_viridis_d(option = "A", end = 0.9, begin = 0.2) +
                 guides(fill = guide_legend(ncol = 1, na.translate = F)) + 
                  labs(fill = "", 
                       color = "")

path = paste0(here::here(),"/Graficos/Estado/05_Migracion de retorno/2000/GSankey de MRt a nivel estatal.pdf")
ggexport(p, width = 14, height = 10, dpi = 400, filename = path)
```


Este tipo de gráfico puede servir para analizar los grandes flujos de migración.   

```{r, eval = FALSE}
p <- lapply(1:32, function(x){
                   tabla <- tabla %>%
                             mutate(rn = forcats::fct_relevel(.$rn, estados),
                                    cn = forcats::fct_relevel(.$cn, estados)) %>%
                              mutate(value = ifelse(.$rn %in% estados[x] | .$cn %in% estados[x], value, 0)) 
 
                    tabla %>% 
                     ggplot(aes(axis1 = rn, 
                                 axis2 = cn, 
                                  y = value),  # c("value", "freq", "tasa")
                             reverse = FALSE, 
                              na.rm = TRUE) + 
                      geom_alluvium(aes(fill = rn),  
                                     color = "transparent", 
                                      alpha = 0.8, 
                                       lwd = 0.001, 
                                        width = 1/5,
                                         reverse = FALSE) +
                       geom_stratum(aes(fill = rn), 
                                     color = "#F1F1F1", 
                                      alpha = 1, 
                                       lwd = 0.001, 
                                        width = 1/5,
                                         reverse = FALSE) +
                         geom_text_repel(aes(label = ifelse(after_stat(x)  == 1, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                             fontface =  ifelse(after_stat(x) == 1, 'bold', 'plain')),
                                           stat = "stratum", 
                                            size = 3,
                                             direction = "y", 
                                              nudge_x = -.2, 
                                               force = 1,
                                                        force_pull = 0,
                                                         family = "montserrat",
                                                          reverse = FALSE) +
                          geom_text_repel(aes(label = ifelse(after_stat(x)  == 2, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                              fontface =  ifelse(after_stat(x) == 2, 'bold', 'plain')),
                                           stat = "stratum", 
                                            size = 3,
                                             direction = "y", 
                                              nudge_x = .2, 
                                               force = 1,
                                                force_pull = 0,
                                                 family = "montserrat",
                                                  reverse = FALSE) +
                            theme_void() + 
                             theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                                    text = element_text(family = "montserrat"),
                                     axis.text = element_blank(),
                                      axis.title = element_blank(),
                                       strip.text = element_text(size = 10, face = "bold", family = "montserrat"),
                                        legend.key.size = unit(0.5, "cm"),
                                         legend.text = element_text(size = 9, family = "montserrat"),
                                          legend.position = c(1, .5)) + 
                              scale_x_discrete(expand = c(-0.1, 0.35)) +
                               scale_fill_viridis_d(option = "A", end = 0.9, begin = 0.2) +
                                guides(fill = guide_legend(ncol = 1, na.translate = F)) + 
                                 labs(fill = "", 
                                      color = "")
              }
)

path = paste0(here::here(),"/Graficos/Estado/05_Migracion de retorno/2000/GSankey de MRt desagregado por estados_Absolutos.pdf")
ggexport(list = p, width = 14, height = 10, dpi = 400, filename = path)
```


## Indicadores {.tabset .tabset-pills}  

Se realizan cálculos generales de movilidad\
+ Residentes\
+ Inmigrantes\
+ Emigrantes\
+ $\%$ Inmigrantes\
+ $\%$ Emigrante\
+ Migración bruta\
+ Migración Neta\
+ $\%$ Tasa de movilidad bruta\
+ $\%$ Tasa de movilidad neta 


Se trabaja con la matriz cuadrada, la cual de esta manera no se satura la computadora 

```{r, eval = FALSE}
# Clave de los estados
tablas <- str_pad(rep(1:32), width = 3, pad = "0")

MC <- mydata  %>%
       select(FACTOR, ESTRATO, UPM, CVE_ENT, CVE_ENT, RES95EDO_C, EDAD, I_Migrante_Retorno) %>%
        as.data.frame() %>%
         mutate(EDAD = as.numeric(.$EDAD)) %>%
          filter(EDAD >= 5 & EDAD <= 130)  %>%
        # Se reclasifica la variable de residencia hace 5 años
           mutate(RES95EDO_C = case_when(.$RES95EDO_C %in% tablas ~.$RES95EDO_C)) %>%
            mutate(M = 1) %>% # Residentes 
             mutate(Migrantes.Retorno = case_when(.$CVE_ENT !=.$RES95EDO_C  & (EDAD >= 5 & EDAD <= 130) & I_Migrante_Retorno %in% "Migrante de retorno" ~ .$RES95EDO_C),
                    Inmigrantes = case_when(.$CVE_ENT !=.$RES95EDO_C  & (EDAD >= 5 & EDAD <= 130) & I_Migrante_Retorno %in% "Inmigrante" ~ .$RES95EDO_C),
                    Residentes = case_when(.$CVE_ENT ==.$RES95EDO_C & (EDAD >= 5 & EDAD <= 130) ~ .$RES95EDO_C)) %>% 
              select(FACTOR, ESTRATO, UPM, CVE_ENT, RES95EDO_C, M, Migrantes.Retorno, Inmigrantes, Residentes) %>%
               svydesign(data = ., id = ~ UPM, strata = ~ESTRATO, weight = ~FACTOR, nest = T)

##################### Migrantes de Retorno #####################################

Migrantes.Retorno <- svytable(~CVE_ENT + Migrantes.Retorno , design = MC) 

Migrantes.Retorno <- Migrantes.Retorno %>%
                      as.data.frame() %>%
                       expss::cross_cases(CVE_ENT,  Migrantes.Retorno, weight = Freq) %>%
                        as.data.frame() %>%
                         slice(-33) %>% 
                          select(-row_labels) %>%
                           mutate_if(is.character, is.numeric) 

rownames(Migrantes.Retorno) <- tablas
colnames(Migrantes.Retorno) <- tablas

##################### Migrantes (Inmigrantes) #####################################

Migrantes.Inmigrantes <- svytable(~CVE_ENT + Inmigrantes , design = MC) 

Migrantes.Inmigrantes <- Migrantes.Inmigrantes %>%
                          as.data.frame() %>%
                           expss::cross_cases(CVE_ENT, Inmigrantes, weight = Freq) %>%
                            as.data.frame() %>%
                             slice(-33) %>% 
                              select(-row_labels) %>%
                               mutate_if(is.character, is.numeric) 

rownames(Migrantes.Inmigrantes) <- tablas
colnames(Migrantes.Inmigrantes) <- tablas

######################## Migrantes (Total) #####################################

Migrantes <- svytable(~CVE_ENT + RES95EDO_C , design = MC) 

Migrantes <- Migrantes %>%
              as.data.frame() %>%
               expss::cross_cases(CVE_ENT, RES95EDO_C, weight = Freq) %>%
                as.data.frame() %>%
                 slice(-33) %>% 
                  select(-row_labels) %>%
                   mutate_if(is.character, is.numeric) 

rownames(Migrantes) <- tablas
colnames(Migrantes) <- tablas
```



```{r, eval = FALSE}
################################################################################
############################ Población total ###################################
Pob.Total <- mydata %>%
              as.data.frame() %>%
               group_by(CVE_ENT) %>%
                summarise(Pob.Total = sum(FACTOR)) 

################################################################################
###################### Población de 5 años y más ###############################
Pob.5ymas <- mydata %>%
              as.data.frame() %>%
               mutate(EDAD = as.numeric(.$EDAD)) %>%
                subset(EDAD >= 5 & EDAD <=130) %>%
                 group_by(CVE_ENT) %>%
                  summarise(Pob.5ymas = sum(FACTOR)) 

################################################################################
########################### Residentes #########################################
Residentes <- Migrantes %>%
               rownames_to_column() %>%
                gather(CVE_ENT, Value, -rowname)%>%
                 filter(rowname == CVE_ENT) %>%
                  select(-rowname) %>%
                   droplevels() %>%
                    rename("Residentes" = "Value") 

################################################################################
############################### Inmigrantes  ####################################
Inmigrantes <- Migrantes %>% 
                as.data.frame() %>%
                 tibble::rownames_to_column(var = "CVE_ENT") %>%
                  melt(., id.vars = "CVE_ENT", variable.name = "RES95EDO_C") %>%
                   mutate_at(vars(3), as.numeric) %>%
                    as.tibble() %>%
                     filter(CVE_ENT != RES95EDO_C) %>%
                      group_by(CVE_ENT) %>%
                       summarise(Inmigrantes = sum(value, na.rm = TRUE))

################################################################################
############################### Inmigrantes | Retorno ##########################
Inmigrantes.Retorno <- Migrantes.Retorno %>% 
                        as.data.frame() %>%
                         tibble::rownames_to_column(var = "CVE_ENT") %>%
                          melt(., id.vars = "CVE_ENT", variable.name = "RES95EDO_C") %>%
                           mutate_at(vars(3), as.numeric) %>%
                            as.tibble() %>%
                             filter(CVE_ENT != RES95EDO_C) %>%
                              group_by(CVE_ENT) %>%
                               summarise(Inmigrantes.Retorno = sum(value, na.rm = TRUE))

################################################################################
########################### Inmigrantes | Inmigrantes ##########################
Inmigrantes.Inmigrantes <- Migrantes.Inmigrantes %>% 
                            as.data.frame() %>%
                             tibble::rownames_to_column(var = "CVE_ENT") %>%
                              melt(., id.vars = "CVE_ENT", variable.name = "RES95EDO_C") %>%
                               mutate_at(vars(3), as.numeric) %>%
                                as.tibble() %>%
                                 filter(CVE_ENT != RES95EDO_C) %>%
                                  group_by(CVE_ENT) %>%
                                   summarise(Inmigrantes.Inmigrantes = sum(value, na.rm = TRUE))

################################################################################
############################### Emigrantes #####################################
Emigrantes <- Migrantes %>% 
               as.data.frame() %>%
                tibble::rownames_to_column(var = "CVE_ENT") %>%
                 melt(., id.vars = "CVE_ENT", variable.name = "RES95EDO_C") %>%
                  mutate_at(vars(3), as.numeric) %>%
                   as.tibble() %>%
                    filter(CVE_ENT != RES95EDO_C) %>%
                     group_by(RES95EDO_C) %>%
                      summarise(Emigrantes = sum(value, na.rm = TRUE)) %>%
                       rename("CVE_ENT" = "RES95EDO_C") 

################################################################################
######################## Emigrantes  | Retorno #################################
Emigrantes.Retorno <- Migrantes.Retorno %>% 
                       as.data.frame() %>%
                        tibble::rownames_to_column(var = "CVE_ENT") %>%
                         melt(., id.vars = "CVE_ENT", variable.name = "RES95EDO_C") %>%
                          mutate_at(vars(3), as.numeric) %>%
                           as.tibble() %>%
                            filter(CVE_ENT != RES95EDO_C) %>%
                             group_by(RES95EDO_C) %>%
                              summarise(Emigrantes.Retorno = sum(value, na.rm = TRUE)) %>%
                               rename("CVE_ENT" = "RES95EDO_C") 

################################################################################
################### Emigrantes  |  Inmigrantes #################################
Emigrantes.Inmigrantes <- Migrantes.Inmigrantes %>% 
                           as.data.frame() %>%
                            tibble::rownames_to_column(var = "CVE_ENT") %>%
                             melt(., id.vars = "CVE_ENT", variable.name = "RES95EDO_C") %>%
                              mutate_at(vars(3), as.numeric) %>%
                               as.tibble() %>%
                                filter(CVE_ENT != RES95EDO_C) %>%
                                 group_by(RES95EDO_C) %>%
                                  summarise(Emigrantes.Inmigrantes = sum(value, na.rm = TRUE)) %>%
                                   rename("CVE_ENT" = "RES95EDO_C") 

tabla <- Pob.Total %>%
          left_join(., Pob.5ymas, by = c("CVE_ENT")) %>%
          left_join(., Residentes, by = c("CVE_ENT")) %>%
          left_join(., Inmigrantes, by = c("CVE_ENT")) %>%
          left_join(., Inmigrantes.Retorno, by = c("CVE_ENT")) %>%
          left_join(., Inmigrantes.Inmigrantes, by = c("CVE_ENT")) %>%
          left_join(., Emigrantes, by = c("CVE_ENT")) %>%
          left_join(., Emigrantes.Retorno, by = c("CVE_ENT")) %>%
          left_join(., Emigrantes.Inmigrantes, by = c("CVE_ENT")) 

write.xlsx(tabla, file = paste0(here::here(),"/Output/Estado/05_Migracion de retorno/2000/Indicadores de migracion de retorno a nivel estatal 2000.xlsx"), overwrite = TRUE)

save(tabla, file = paste0(here::here(),"/Output/Estado/05_Migracion de retorno/2000/Indicadores de migracion de retorno a nivel estatal 2000.RData"))
```

```{r, echo = FALSE}
load(file = paste0(here::here(),"/Output/Estado/05_Migracion de retorno/2000/Indicadores de migracion de retorno a nivel estatal 2000.RData"))

tabla %>%  
 as.data.frame() %>%
  gt() %>% 
   tab_header(title = "Indicadores de  migración de retorno", 
              subtitle = "Nivel estatal") %>%
    tab_options(heading.title.font.size = 12, 
                heading.align = "center",
                heading.subtitle.font.size = 10,
                data_row.padding = px(1),
                column_labels.font.weight = "bold",
                column_labels.padding = px(10), 
                table.font.names = 'montserrat',
                table.font.size = 8) %>%
     tab_style(style = list(cell_text(align = "center",
                                      weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
      fmt_integer(columns = c(2:10), sep_mark = " ") %>%
       fmt_missing(columns = everything(), missing_text = "0") %>%
        tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%
         tab_footnote(footnote = "El total de inmigrantes se incluyen a los inmigrantes de otro país",
                      locations = cells_column_labels(columns = Inmigrantes)) %>% 
          tab_footnote(footnote = "El total de emigrantes se incluyen a los emigrantes de otro país",
                       locations = cells_column_labels(columns = Emigrantes)) %>% 
           as_raw_html()
```

# Referencias

Librerias que se usaron en el documento

```{r, echo = FALSE}
sesion_info <- devtools::session_info()
kable(dplyr::select(tibble::as_tibble(sesion_info$packages %>% dplyr::filter(attached == TRUE)),
                    c(package, loadedversion, source))) %>%
 kable_styling(font_size = 10, 
               bootstrap_options = c("condensed", "responsive", "bordered")) %>%
  kable_classic(full_width = TRUE, html_font = "montserrat") %>% 
   scroll_box(width = "100%", height = "150px") %>%  
    gsub("font-size: initial !important;", "font-size: 10pt !important;", .)
```
