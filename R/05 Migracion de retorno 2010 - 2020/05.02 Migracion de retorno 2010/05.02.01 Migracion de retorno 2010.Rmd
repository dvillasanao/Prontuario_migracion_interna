---
title: "Migraci칩n de retorno 2010"
author: "Diana Villasana Ocampo"
output:
  html_document:
    highlight: tango
    theme: flatly
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: yes
---

\usepackage{color}

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE, cache.lazy = FALSE, 
                         eval = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(digits = 2, encoding = "UTF8")
```

```{r, echo=FALSE}
setwd(here::here())
source(paste0(here::here(), "/R/inst/chord_function.R"))
source(paste0(here::here(), "/R/inst/margins_function.R"))
source(paste0(here::here(), "/R/inst/migration_function.R"))
```

```{r, echo=FALSE}
#Font Stlye
require(showtext)
library(extrafont)
# activar showtext
# SE cargan las funtes del sitema Windows (Pero tarda en correr)
#ttf_import('C:/Users/dvill/AppData/Local/Microsoft/Windows/Fonts/')
#fonts()
#extrafont::loadfonts(device = "win")
#font_import()
windowsFonts()
```

```{r, echo = FALSE, eval = TRUE, results=FALSE}
# Librer칤as que se usaron en el documCVE_ENTo
#devtools::install_github("mattflor/chorddiag")
require(chorddiag)
require(circlize)
require(Cairo)
require(haven)
require(Hmisc) # %nin%
require(dplyr)
require(survey)
require(srvyr)
require(stringr)
require(sna)
require(expss)
require(knitr)
require(kableExtra)
require(mapview)
require(sjlabelled)
require(gt)
require(ggplot2)
require(ggpubr)
require(ggalluvial)
require(ggsankey)
require(ggrepel)
require(janitor)
require(tibble)
require(tidyr)
require(reshape2)
require(openxlsx)
require(doMC)
registerDoMC(cores = 18)
```

**Cuestionario Ampliado del Censo de Poblaci칩n y Vivienda 2010**

El cuestionario ampliado se guarda en un un archivo `.RData`.

```{r, eval = FALSE}
data <- read_sav("~/Cuestionario Ampliado_2010_Persona.sav")

save(data, 
      file = paste0(here::here(),"/Bases/Censo_Personas_2010.RData"))
```

Se seleccionan las variables que se desean conservar para la realizaci칩n de este documento y se guarda en un archivo `.RData` para practicidad del manejo de datos.

**Posibles variables que se pueden contemplar en la migraci칩n de retorno**

-   `EDAD`,
-   `SEXO`
-   `AFRODES`
-   `HLENGUA`
-   `QDIALECT_C`
-   `LI_INALI`
-   `PERTE_INDIGENA`
-   `NIVACAD`
-   `ALFABET`
-   `ESTCON`
-   `CONACT`
-   `HIJOS_NAC_VIVOS`

La variable `mydata` contiene **11 938 402** observaciones** y **12 variables**.

**Se clasifican a los migrantes de retorno**

```{r, eval = FALSE}
load(paste0(here::here(),"/Bases/Censo_Personas_2010.RData"))

# Clave de los estados
tablas <- str_pad(rep(1:32), width = 3, pad = "0")

mydata <- data %>%
           select(ENT, NOM_ENT, MUN, NOM_MUN, ENT_MUN, LNACEDO_C, LNACPAIS_C, ENT_MUN_RES, RES05EDO_C, RES05PAI_C,  MUN05OTR_C,
                  EDAD, SEXO, HLENGUA, QDIALECT_C, LI_INALI, PERETN, NIVACAD, ALFABET, ESTCON, CONACT, FACTOR, ESTRATO, UPM) %>%
            rename("CVE_ENT" = "ENT",
                   "CVE_MUN" = "ENT_MUN",
                   "CVE_MUN_RES" = "ENT_MUN_RES",
                   "ENT_PAIS_NAC" = "LNACEDO_C") %>%
             mutate(CVE_ENT = str_pad(.$CVE_ENT, width = 3, side = c("left"), pad = "0")) %>%
             mutate(ENT_PAIS_NAC = case_when(.$ENT_PAIS_NAC %in% tablas ~.$ENT_PAIS_NAC,
                                              is.na(.$ENT_PAIS_NAC) ~ "0",
                                             .$ENT_PAIS_NAC %in% "900" ~ "900",
                                             .$ENT_PAIS_NAC %in% "999" ~ "999",
                                             .$ENT_PAIS_NAC %nin% c(tablas, "900", "999") ~ "888" #Nacio en otro pa칤s
                                             ),
                    RES05EDO_C = case_when(.$RES05EDO_C %in% tablas ~.$RES05EDO_C,
                                           .$RES05EDO_C %in% "" ~ "0",
                                           .$RES05EDO_C %in% "900" ~ "900",
                                           .$RES05EDO_C %in% "999" ~ "999",
                                           .$RES05EDO_C %nin% c(tablas, "900", "999") ~ "888" #Residencia en otro pa칤s
                                           )) %>% 
               mutate(I_Condicion_Nacimiento = case_when(.$ENT_PAIS_NAC  == "888" ~ "888",
                                                         .$ENT_PAIS_NAC == "900" ~ "900",
                                                         .$ENT_PAIS_NAC == "999" ~ "999",
                                                         .$CVE_ENT == .$ENT_PAIS_NAC ~ "1",
                                                         .$CVE_ENT != .$ENT_PAIS_NAC ~ "2", 
                                                          TRUE ~ "0"
                                                        ),
                      I_Condicion_Residencia2005 = case_when(.$RES05EDO_C == "0" ~ "0", # Poblaci칩n que no entra en esta categor칤a 
                                                             .$RES05EDO_C == "888" ~ "888",
                                                             .$RES05EDO_C == "900" ~ "900",
                                                             .$RES05EDO_C == "999" ~ "999",
                                                             .$CVE_ENT == .$RES05EDO_C ~ "1",
                                                             .$CVE_ENT != .$RES05EDO_C ~ "2",
                                                              TRUE ~ "0")) %>%
################################################# Indicador de migraci칩n de retorno #######################################################
                mutate(I_Migrante_Retorno = case_when(.$I_Condicion_Residencia2005 == "2" & .$I_Condicion_Nacimiento == "1" ~ "Migrante de retorno",
                                                      .$I_Condicion_Residencia2005 == "2" & .$I_Condicion_Nacimiento == "2" ~ "Inmigrante", 
                                                      .$I_Condicion_Residencia2005 == "2" & .$I_Condicion_Nacimiento == "888" ~ "De otro pa칤s",    
                                                      .$I_Condicion_Residencia2005 == "2" & .$I_Condicion_Nacimiento == "900" ~ "No especific칩 de entidad federativa",                                                        
                                                      .$I_Condicion_Residencia2005 == "2" & .$I_Condicion_Nacimiento == "999" ~ "No especificado", 
                                                       TRUE ~ "0")) 

save(mydata, file = paste0(here::here(),"/Bases/05_Migracion de retorno_2010.RData"))
```

勇뀨 partir de aqu칤 se pueden correr los c칩didos 游녢.

Se carga el archivo `Migracion de retorno_2010.RData`.

```{r}
load(file = paste0(here::here(), "/Bases/05_Migracion de retorno_2010.RData"))

#Para fines pr치cticos se genera un ponderador de uno 
mydata <- mydata %>%
           select(CVE_ENT, NOM_ENT, ENT_PAIS_NAC, RES05EDO_C, EDAD, 
                  I_Condicion_Nacimiento, I_Condicion_Residencia2005, I_Migrante_Retorno, FACTOR, ESTRATO, UPM) %>%
            mutate(M = 1)  %>%
             ungroup()
```

**Claves de entidades y municipios**

**Entidades** Se genera un vector con el nombre de las entidades llamado `estados` para facilitar los filtros en el documento.\
Se genera un vector con las abreviaturas de las entidades llamado `ent` para fines pr치cticos.

```{r}
# Claves de los estados
estados <- sjlabelled::get_labels(mydata$CVE_ENT)

nom_estados <- c( "Aguascalientes", "Baja California" ,"Baja California Sur", "Campeche", "Coahuila de Zaragoza",
                  "Colima", "Chiapas", "Chihuahua", "Ciudad de M칠xico", "Durango", 
                  "Guanajuato", "Guerrero", "Hidalgo", "Jalisco",  "M칠xico", 
                  "Michoac치n de Ocampo", "Morelos", "Nayarit", "Nuevo Le칩n", "Oaxaca", 
                  "Puebla", "Quer칠taro", "Quintana Roo", "San Luis Potos칤", "Sinaloa", 
                  "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala","Veracruz de Ignacio de la Llave", 
                  "Yucat치n", "Zacatecas")

est <- c("AGS", "BC", "BCS", "CAMP", "COAH", "COL", "CHIS", "CHIH", "CDMX", "DGO", "GTO", "GRO", "HGO",
         "JAL", "MEX", "MICH", "MOR", "NAY", "NL", "OAX", "PUE", "QRO", "QROO", "SLP","SIN","SON", "TAB", 
         "TAMS", "TLX", "VER", "YUC", "ZAC")

# Se le asignan las etiquetas a los nombres de los estados 
levels(mydata$NOM_ENT) <- estados
```

**Poblaci칩n de retorno de 5 a침os y m치s**

Se identifica a la poblaci칩n de retorno de 5 a침os y m치s.

`filter(EDAD >= 5 & EDAD <= 130)'.`

```{r}
# Clave de los estados
tablas <- str_pad(rep(1:32), width = 3, pad = "0")

tabla <- mydata %>%
          as.data.frame() %>%
           mutate(EDAD = as.numeric(.$EDAD)) %>%
            subset(EDAD >= 5 & EDAD <= 130) %>%
             filter(CVE_ENT %in% tablas & I_Migrante_Retorno %in% "Migrante de retorno")  # Filtro de migrantes de retorno.
```

```{r, echo = FALSE}
# Poblaci칩n de retorno de 5 a침os y m치s
tabla <- tabla %>%
          summarise(Pob.retorno = sum(.$FACTOR))

as.integer(tabla) %>%  
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(.,big.mark = " ", preserve.width = "none"))) %>%
   gt() %>% 
    tab_header(title = "Poblaci칩n de retorno de 5 a침os y m치s") %>%
     tab_options(heading.title.font.size = 12, 
                 heading.align = "center",
                 heading.subtitle.font.size = 10,
                 table.align = "center",
                 column_labels.font.weight = "bold",
                 table.font.names = 'montserrat',
                 table.font.size = 8) %>%  
       as_raw_html()
```

# Muestro Complejo

Se utiliza la paqueter칤a `survey` para poder trabajar con la muestra del cuestionario ampliado, en la cual se selecciona a la Poblaci칩n de retorno de 5 a침os y m치s.

```{r}
options(survey.lonely.psu = "adjust")

MC <- mydata %>%
       as.data.frame() %>%
        mutate(EDAD = as.numeric(.$EDAD)) %>%
         subset(EDAD >= 5 & EDAD <= 130) %>%
          filter(CVE_ENT %in% estados & I_Migrante_Retorno %in% "Migrante de retorno") %>% # Filtro de migrantes de retorno.
           svydesign(data = ., id = ~ UPM, strata = ~ESTRATO, weight = ~FACTOR, nest = T)

saveRDS(MC, file = paste0(here::here(), "/Output/Estado/05_Migracion de retorno/2010/MC_estado.RDS"))
```

# Nivel estatal {.tabset .tabset-pills}

## Migraci칩n de retorno {.tabset .tabset-pills}

Se genera una matriz cruzada del lugar de residencia hace 5 a침os a nivel estatal, utilizando la funci칩n `svytable` de la paqueter칤a `survey`.

```{r}
MC <- readRDS(file = paste0(here::here(), "/Output/Estado/05_Migracion de retorno/2010/MC_estado.RDS"))

Migrantes <- svytable(~RES05EDO_C + CVE_ENT, design = MC) 
```

Se quita la diagonal a la matriz cruadrada y se le asignan los nombres de los estados.

```{r}
Migrantes <- Migrantes %>%
              as.data.frame() %>%
               expss::cross_cases(CVE_ENT, RES05EDO_C, weight = Freq) %>%
                as.data.frame() %>%
                 slice(-33) %>% 
                  select(-row_labels) #%>%

rownames(Migrantes)<- nom_estados
colnames(Migrantes) <- nom_estados

wb <- createWorkbook()
addWorksheet(wb, "MRt. 2010")
writeData(wb, 1, Migrantes, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2010/Matriz de MRt a nivel estatal 2010.xlsx"), overwrite = TRUE)

save(Migrantes, file = paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2010/Matriz de MRt a nivel estatal 2010.RData"))
```

**Matriz de migraci칩n de retorno a nivel estatal**

::: {style="height:500px;overflow:auto;"}
```{r, echo = FALSE, eval = TRUE}
load(file = paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2010/Matriz de MRt a nivel estatal 2010.RData"))

tabla <- Migrantes %>%
          as.data.frame() %>%
           tibble::rownames_to_column() 

tabla %>%  
 gt() %>% 
  tab_header(title = "Matriz de migraci칩n de retorno, 2010", 
             subtitle = "Nivel estatal") %>%
   tab_options(heading.title.font.size = 12, 
               heading.align = "center",
               heading.subtitle.font.size = 10,
               data_row.padding = px(1),
               column_labels.font.weight = "bold",
               column_labels.padding = px(10), 
               table.font.names = 'montserrat',
               table.font.size = 8) %>%
    tab_style(style = list(cell_text(align = "center",
                                     weight = 'bold')),
              locations = list(cells_title(groups = c("title")))) %>%
  
     tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
      sub_missing(columns = everything(), missing_text = "0") %>%
       as_raw_html()
```
:::

## Gr치fico din치mico

Gr치fico din치mico de migraci칩n de retorno a nivel estatal.

```{r, fig.width=5, fig.height=5, fig.align='center', eval = TRUE}
load(file = paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2010/Matriz de MRt a nivel estatal 2010.RData"))

tabla <- Migrantes %>%
          sna::diag.remove(remove.val = 0) 

names <- c("Aguascalientes", "Baja California" ,"Baja California Sur", "Campeche", "Coahuila", "Colima", 
           "Chiapas", "Chihuahua", "Ciudad de M칠xico", "Durango", "Guanajuato", "Guerrero", "Hidalgo", "Jalisco",    
           "M칠xico", "Michoac치n", "Morelos", "Nayarit", "Nuevo Le칩n", "Oaxaca", "Puebla", "Quer칠taro", 
           "Quintana Roo", "San Luis Potos칤", "Sinaloa", "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala", 
           "Veracruz", "Yucat치n", "Zacatecas")

# Paleta de colores
paleta <- colorRampPalette(pals::parula(100))(32)

p <- chorddiag(tabla, 
               groupNames = names,
               groupColors = paleta, 
               groupnamePadding = 10, 
               #height = 700, 
               #width = 700,
               #margin = 150,
               groupThickness = 0.07,
               groupPadding = 3,
               groupnameFontsize = 12,
               fadeLevel = '0.1',
               tickInterval = seq(0, 500000, 10000),
               chordedgeColor = "transparent",
               showZeroTooltips = FALSE,
               showTicks = TRUE)

# Ajusta las etiquetas usando JavaScript para modificar su posici칩n
p <- htmlwidgets::onRender(p, '
  function(el, x) {
    d3.selectAll(".group text")
      .attr("text-anchor", "middle")
      .attr("dx", "0")  
      .attr("dy", "0.75em"); 
  }
')

# Crear un contenedor div y aplicar estilos CSS para centrarlo
#p <- tags$div(style = "display: flex; justify-content: center; align-items: center;", p)

p

p %>% 
 mapshot(url = paste0(here::here(),"/images/MRt_2010.html"))

#htmlwidgets::saveWidget(p, paste0(here::here(),"/Graficos/Estado/05_Migracion de retorno/2010/MRt a nivel estatal 2010.html"), selfcontained = TRUE)
#require(webshot)
#webshot(url = paste0(here::here(),"/Graficos/Estado/05_Migracion de retorno/2010/MRt a nivel estatal 2010.html"),
 #         file = paste0(here::here(),"/Graficos/Estado/05_Migracion de retorno/2010/MRt a nivel estatal 2010.png"),
  #                cliprect = "viewport")
```

## Gr치ficos migraci칩n de retorno {.tabset .tabset-pills}

### ChordDiagram

```{r, fig.height=20, fig.width=20, eval = FALSE, class.source = "fold-hide"}
load(file = paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2010/Matriz de MRt a nivel estatal 2010.RData"))

tabla <- Migrantes %>%
           sna::diag.remove(remove.val = 0)  

rownames(tabla) <- stringr::str_wrap(nom_estados, 100)
colnames(tabla) <- stringr::str_wrap(nom_estados, 100)

# Paleta de colores
paleta <- colorRampPalette(pals::parula(100))(50)

tabla2 <- color_chord_diagram(tabla1 = tabla, paleta)
```

```{r}
file = "/Graficos/Estado/05_Migracion de retorno/2010/ChordDiagram de MRt a nivel estatal.pdf"

## Gr치ficos a nivel estatal 
chord_diagram_graph(file = file, 
                    width = 7, 
                    height = 7, 
                    family = "Montserrat Medium", 
                    paleta = paleta, 
                    tabla1 = tabla, 
                    tabla2 = tabla2, 
                    color_labels = "#352A87",
                    transparency = 0.4,
                    circo.text = 9,
                    circos.axis.text = 6,
                    adj.text =c(-0.05, 0.5), #Ajuste de las etiquetas (x, y)
                    adj.ylim = 0.1,
                    gap.degree = 2, 
                    clock.wise = FALSE,
                    track.margin = c(-0.07, 0.1),
                    margin = rep(0, 4))
```

### Gr치fico por estados

Se filtran los flujos migratorios que son exclusivos de los estados y que visualmente sean m치s interpretables.

```{r, results = FALSE, eval = FALSE}
load(file = paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2010/Matriz de MRt a nivel estatal 2010.RData"))

tabla <- Migrantes %>%
          sna::diag.remove(remove.val = 0) 

rownames(tabla) <- stringr::str_wrap(nom_estados, 100)
colnames(tabla) <- stringr::str_wrap(nom_estados, 100)

# Nombre de los estados 
estado <- stringr::str_wrap(nom_estados, 100)

filtro_est <- Migrantes %>%
               as.data.frame() %>%
                tibble::rownames_to_column(var = "rn") %>% 
                 melt(., id.vars = "rn", variable.name = "cn") %>%
                  mutate_if(is.factor, as.character) %>%
                   filter(value > 0)

### Sacar el promedio de los flujos migratiorios para determinar como se van a grupar los estados 
#### Es importante correr la tabla1[[x]] sin filtros para determinar el n칰mero promedio de flujos de migraci칩n
#### Filtro <<<<< filter(value > 0 & rn != estado[x]) %>%
#filtro_mig <- sapply(1:32, function(x)
 #                     mean(tail(sort(tabla1[[x]]), 1), na.rm = TRUE))

#p <- data.frame(estados = est,
 #               filtro_estados = filtro_mig,
                 #NUM = 1:32)
#write.xlsx(p, file = paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2010/Filtro a nivel estatal.xlsx"))

filtro_mig <- read.xlsx(paste0(here::here(), "/Bases/Estado/05_Migracion de retorno/2010/Filtro a nivel estatal.xlsx"), colNames = TRUE) %>% 
               pull(filtro_estados)

tabla1 <- migration_flows_states(tabla = tabla, 
                                 filtro_mig = filtro_mig, 
                                 filtro_est = filtro_est, 
                                 category = estado, 
                                 group = "Otro estados")

## Se guardan las matrices de migraci칩n de retorno para analizarlos despu칠s. 
wb <- createWorkbook()
for(i in 1:32){
     tabla <- tabla1[[i]] %>%
                as.data.frame() %>%
                 adorn_totals(c("row", "col"), 
                               fill = "-", 
                                na.rm = TRUE, 
                                 name = "Total",,,,contains(colnames(tabla1[[i]])))
                 
     addWorksheet(wb, paste(est[i]))
     writeData(wb, i, tabla, colNames = TRUE, rowNames = TRUE)
     saveWorkbook(wb, 
                  file = paste0(here::here(), "/Output/Estado/05_Migracion de retorno/2010/Matriz MRt por estados_2010_Reduccion.xlsx"), 
               overwrite = TRUE)
}

saveRDS(tabla1, file = paste0(here::here(), "/Output/Estado/05_Migracion de retorno/2010/Tabla MRt a nivel estatal.RDS"))
```

```{r tablas de matrices}
tabla1 <- readRDS(file = paste0(here::here(), "/Output/Estado/05_Migracion de retorno/2010/Tabla MRt a nivel estatal.RDS"))

total_tablas <- totales(tabla1 = tabla1, 
                        Clave = "CVE_ENT", 
                        Inmigrantes = "Migrantes de retorno",  
                        Emigrantes = "Entidad de residencia 5a")

porcentajes_tablas <- porcentajes(tabla1 = tabla1, 
                                  Clave = "CVE_ENT", 
                                  Inmigrantes = "%Migrantes de retorno",  
                                  Emigrantes = "%Entidad de residencia 5a")

# Se guardan los totales de las matrices reducidas 
wb <- createWorkbook()
for(i in 1:32){
     addWorksheet(wb, paste(est[i]))
     writeData(wb, i, total_tablas[[i]], colNames = TRUE, startCol = 1)
     writeData(wb, i, porcentajes_tablas[[i]], colNames = TRUE, startCol = 5)
     saveWorkbook(wb, 
                  file = paste0(here::here(), "/Output/Estado/05_Migracion de retorno/2010/Matriz MRt por estados_2010_Reduccion_Totales.xlsx"), 
               overwrite = TRUE)
}
```

```{r}
tabla1 <- readRDS(file = paste0(here::here(), "/Output/Estado/05_Migracion de retorno/2010/Tabla MRt a nivel estatal.RDS"))

paleta <- c("#352A87", "#3436A2", "#2A45BC", "#1556D5", "#0963DC", "#066FDD", "#0E78D9", "#1180D5", "#1089D2", "#0995D1", "#069DCB", "#06A5C5", "#0AAABC", "#17B0B0", "#27B4A5", "#3DB999", "#55BC8C", "#6EBE7F", "#87BE75", "#9CBE6C", "#B0BC64", "#C3BB5C", "#D5B955", "#E7B94C", "#F5BB40", "#FBC434", "#FACF2A")

tabla2 <- color_chord_diagram(tabla1, paleta)
```

```{r, eval = FALSE}
file = "/Graficos/Estado/05_Migracion de retorno/2010/ChordDiagram de MRt para cada estado.pdf"

## Gr치ficos a nivel estatal 
chord_diagram_graph(file, 
                    width = 8, 
                    height = 8, 
                    family = "Montserrat Medium", 
                    paleta = paleta, 
                    tabla1 = tabla1, 
                    tabla2 = tabla2,
                    color_labels = "#000C7D",
                    transparency = 0,
                    circo.text = 9,
                    circos.axis.text = 6,
                    adj.text = c(-0.05, 0.5),
                    adj.ylim = 0.1,
                    gap.degree = 2, 
                    clock.wise = FALSE,
                    track.margin = c(-0.07, 0.1),
                    margin = c(0, 0, 0, 0))
```

```{r etiquetas_estatal}
file = "/Graficos/Estado/05_Migracion de retorno/2010/Etiquetas a nivel estatal.pdf"

labels_chord_diagram(file = file, 
                     width = 7, 
                     height = 8, 
                     family = "Montserrat Medium", 
                     paleta = paleta, 
                     tabla1 = tabla1, 
                     labels = nom_estados)
```

### Gr치fico Sankey

```{r, eval = FALSE}
## Variable `Migrantes`  se vuelve a recalcular. 
Migrantes <- svytable(~ENT + RES05EDO_C, design = MC)  

# Para evitar estar recalculando el muestreo complejo, se le nombra como un data.frame a la variable `Migrantes`  previamente calculada.
# Se remueve la diagonal para quedarnos con los flujos migratorios a nivel estatal.  
Migrantes <- Migrantes %>%
              as.data.frame() %>%
               expss::cross_cases(ENT, RES05EDO_C, weight = Freq) %>%
                as.data.frame() %>%
                 slice(-33) %>% 
                  select(-row_labels) %>% 
                   sna::diag.remove(remove.val = 0)

rownames(Migrantes) <- estados
colnames(Migrantes) <- estados
```

**Gr치ficos Sankey por estados**

```{r, eval = FALSE}
# Matiz de migraci칩n de retorno
tabla <- Migrantes %>% 
          as.data.frame() %>%
           tibble::rownames_to_column(var = "rn") %>%
            melt(., id.vars = "rn", variable.name = "cn") %>%
             as_tibble() %>%
              mutate(rn = forcats::fct_relevel(.$rn, estados),
                     cn = forcats::fct_relevel(.$cn, estados))
```

```{r, eval = FALSE}
p <- tabla %>% 
       ggplot(aes(axis1 = rn, 
                   axis2 = cn, 
                    y = value),  # c("value", "freq", "tasa")
               reverse = FALSE, 
                na.rm = TRUE) +
        geom_alluvium(aes(fill = rn),
                       curve_type = "quintic", 
                        color = "transparent", 
                         alpha = 0.85, 
                          lwd = 0.001, 
                           width = 1/5,
                            reverse = FALSE) +
          geom_stratum(aes(fill = cn), 
                        color = "white", 
                         alpha = 0.65,  
                          lwd = 0.001, 
                           width = 1/5,
                            reverse = FALSE) +
           geom_text_repel(aes(label = ifelse(after_stat(x) == 1, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""), 
                               fontface =  ifelse(after_stat(x) == 1, 'bold', 'plain')),
                            stat = "stratum", 
                             size = 3, 
                              direction = "y", 
                               nudge_x = -.2,
                                min.segment.length = unit(1, "lines"),
                                 force = 1,
                                  force_pull = 0,
                                   family = "montserrat",
                                    reverse = FALSE) +
            geom_text_repel(aes(label = ifelse(after_stat(x)  == 2, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                fontface =  ifelse(after_stat(x) == 2, 'bold', 'plain')),
                             stat = "stratum", 
                              size = 3,
                               direction = "y", 
                                nudge_x = .2, 
                                 force = 1,
                                  force_pull = 0,
                                   family = "montserrat",
                                    reverse = FALSE) +
             theme_void() + 
              theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                     text = element_text(family = "montserrat"),
                      axis.text = element_blank(),
                       axis.title = element_blank(),
                        strip.text = element_text(size = 10, face = "bold", family = "montserrat"),
                         legend.key.size = unit(0.5, "cm"),
                          legend.text = element_text(size = 9, family = "montserrat"),
                           legend.position = c(1, .5)) + 
               scale_x_discrete(expand = c(-0.1, 0.35)) +
                scale_fill_viridis_d(option = "A", end = 0.9, begin = 0.2) +
                 guides(fill = guide_legend(ncol = 1, na.translate = F)) + 
                  labs(fill = "", 
                       color = "")

path = paste0(here::here(),"/Graficos/Estado/05_Migracion de retorno/2010/GSankey de MRt a nivel estatal.pdf")
ggexport(p, width = 14, height = 10, dpi = 400, filename = path)
```

Este tipo de gr치fico puede servir para analizar los grandes flujos de migraci칩n.

```{r, eval = FALSE}
p <- lapply(1:32, function(x){
                   tabla <- tabla %>%
                             mutate(rn = forcats::fct_relevel(.$rn, estados),
                                    cn = forcats::fct_relevel(.$cn, estados)) %>%
                              mutate(value = ifelse(.$rn %in% estados[x] | .$cn %in% estados[x], value, 0)) 
 
                    tabla %>% 
                     ggplot(aes(axis1 = rn, 
                                 axis2 = cn, 
                                  y = value),  # c("value", "freq", "tasa")
                             reverse = FALSE, 
                              na.rm = TRUE) + 
                      geom_alluvium(aes(fill = rn),  
                                     color = "transparent", 
                                      alpha = 0.8, 
                                       lwd = 0.001, 
                                        width = 1/5,
                                         reverse = FALSE) +
                       geom_stratum(aes(fill = rn), 
                                     color = "#F1F1F1", 
                                      alpha = 1, 
                                       lwd = 0.001, 
                                        width = 1/5,
                                         reverse = FALSE) +
                         geom_text_repel(aes(label = ifelse(after_stat(x)  == 1, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                             fontface =  ifelse(after_stat(x) == 1, 'bold', 'plain')),
                                           stat = "stratum", 
                                            size = 3,
                                             direction = "y", 
                                              nudge_x = -.2, 
                                               force = 1,
                                                        force_pull = 0,
                                                         family = "montserrat",
                                                          reverse = FALSE) +
                          geom_text_repel(aes(label = ifelse(after_stat(x)  == 2, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                              fontface =  ifelse(after_stat(x) == 2, 'bold', 'plain')),
                                           stat = "stratum", 
                                            size = 3,
                                             direction = "y", 
                                              nudge_x = .2, 
                                               force = 1,
                                                force_pull = 0,
                                                 family = "montserrat",
                                                  reverse = FALSE) +
                            theme_void() + 
                             theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                                    text = element_text(family = "montserrat"),
                                     axis.text = element_blank(),
                                      axis.title = element_blank(),
                                       strip.text = element_text(size = 10, face = "bold", family = "montserrat"),
                                        legend.key.size = unit(0.5, "cm"),
                                         legend.text = element_text(size = 9, family = "montserrat"),
                                          legend.position = c(1, .5)) + 
                              scale_x_discrete(expand = c(-0.1, 0.35)) +
                               scale_fill_viridis_d(option = "A", end = 0.9, begin = 0.2) +
                                guides(fill = guide_legend(ncol = 1, na.translate = F)) + 
                                 labs(fill = "", 
                                      color = "")
              }
)

path = paste0(here::here(),"/Graficos/Estado/05_Migracion de retorno/2010/GSankey de MRt desagregado por estados_Absolutos.pdf")
ggexport(list = p, width = 14, height = 10, dpi = 400, filename = path)
```

## Indicadores {.tabset .tabset-pills}

Se realizan c치lculos generales de movilidad

-   Residentes
-   Inmigrantes
-   Emigrantes
-   $\%$ Inmigrantes
-   $\%$ Emigrantes
-   Migraci칩n bruta
-   Migraci칩n Neta
-   $\%$ Tasa de movilidad bruta
-   $\%$ Tasa de movilidad neta

Se trabaja con la matriz cuadrada, la cual de esta manera no se satura la computadora

```{r, eval = FALSE}
MC <- mydata  %>%
       select(FACTOR, ESTRATO, UPM, CVE_ENT, CVE_ENT, RES05EDO_C, EDAD, I_Migrante_Retorno) %>%
        as.data.frame() %>%
         mutate(EDAD = as.numeric(.$EDAD)) %>%
          filter(EDAD >= 5 & EDAD <= 130)  %>%
        # Se reclasifica la variable de residencia hace 5 a침os
           mutate(RES05EDO_C = case_when(.$RES05EDO_C %in% estados ~.$RES05EDO_C)) %>%
            mutate(M = 1) %>% # Residentes 
             mutate(Migrantes.Retorno = case_when(.$CVE_ENT !=.$RES05EDO_C  & (EDAD >= 5 & EDAD <= 130) & I_Migrante_Retorno %in% "Migrante de retorno" ~ .$RES05EDO_C),
                    Inmigrantes = case_when(.$CVE_ENT !=.$RES05EDO_C  & (EDAD >= 5 & EDAD <= 130) & I_Migrante_Retorno %in% "Inmigrante" ~ .$RES05EDO_C),
                    Residentes = case_when(.$CVE_ENT ==.$RES05EDO_C & (EDAD >= 5 & EDAD <= 130) ~ .$RES05EDO_C)) %>% 
              select(FACTOR, ESTRATO, UPM, CVE_ENT, RES05EDO_C, M, Migrantes.Retorno, Inmigrantes, Residentes) %>%
               svydesign(data = ., id = ~ UPM, strata = ~ESTRATO, weight = ~FACTOR, nest = T)

##################### Migrantes de Retorno #####################################
Migrantes.Retorno <- svytable(~CVE_ENT + Migrantes.Retorno , design = MC) 

Migrantes.Retorno <- Migrantes.Retorno %>%
                      as.data.frame() %>%
                       expss::cross_cases(CVE_ENT,  Migrantes.Retorno, weight = Freq) %>%
                        as.data.frame() %>%
                         slice(-33) %>% 
                          select(-row_labels) %>%
                           mutate_if(is.character, is.numeric) 

rownames(Migrantes.Retorno) <- estados
colnames(Migrantes.Retorno) <- estados

##################### Migrantes (Inmigrantes) #####################################
Migrantes.Inmigrantes <- svytable(~CVE_ENT + Inmigrantes , design = MC) 

Migrantes.Inmigrantes <- Migrantes.Inmigrantes %>%
                          as.data.frame() %>%
                           expss::cross_cases(CVE_ENT, Inmigrantes, weight = Freq) %>%
                            as.data.frame() %>%
                             slice(-33) %>% 
                              select(-row_labels) %>%
                               mutate_if(is.character, is.numeric) 

rownames(Migrantes.Inmigrantes) <- estados
colnames(Migrantes.Inmigrantes) <- estados

######################## Migrantes (Total) #####################################
Migrantes <- svytable(~CVE_ENT + RES05EDO_C , design = MC) 

Migrantes <- Migrantes %>%
              as.data.frame() %>%
               expss::cross_cases(CVE_ENT, RES05EDO_C, weight = Freq) %>%
                as.data.frame() %>%
                 slice(-33) %>% 
                  select(-row_labels) %>%
                   mutate_if(is.character, is.numeric) 

rownames(Migrantes) <- estados
colnames(Migrantes) <- estados
```

```{r, eval = FALSE}
################################################################################
############################ Poblaci칩n total ###################################
Pob.Total <- mydata %>%
              as.data.frame() %>%
               group_by(CVE_ENT) %>%
                summarise(Pob.Total = sum(FACTOR)) 

################################################################################
###################### Poblaci칩n de 5 a침os y m치s ###############################
Pob.5ymas <- mydata %>%
              as.data.frame() %>%
               mutate(EDAD = as.numeric(.$EDAD)) %>%
                subset(EDAD >= 5 & EDAD <=130) %>%
                 group_by(CVE_ENT) %>%
                  summarise(Pob.5ymas = sum(FACTOR)) 

################################################################################
########################### Residentes #########################################
Residentes <- Migrantes %>%
               rownames_to_column() %>%
                gather(CVE_ENT, Value, -rowname)%>%
                 filter(rowname == CVE_ENT) %>%
                  select(-rowname) %>%
                   droplevels() %>%
                    rename("Residentes" = "Value") 

################################################################################
############################### Inmigrantes  ####################################
Inmigrantes <- Migrantes %>% 
                as.data.frame() %>%
                 tibble::rownames_to_column(var = "CVE_ENT") %>%
                  melt(., id.vars = "CVE_ENT", variable.name = "RES05EDO_C") %>%
                   mutate_at(vars(3), as.numeric) %>%
                    as.tibble() %>%
                     filter(CVE_ENT != RES05EDO_C) %>%
                      group_by(CVE_ENT) %>%
                       summarise(Inmigrantes = sum(value, na.rm = TRUE))

################################################################################
############################### Inmigrantes | Retorno ##########################
Inmigrantes.Retorno <- Migrantes.Retorno %>% 
                        as.data.frame() %>%
                         tibble::rownames_to_column(var = "CVE_ENT") %>%
                          melt(., id.vars = "CVE_ENT", variable.name = "RES05EDO_C") %>%
                           mutate_at(vars(3), as.numeric) %>%
                            as.tibble() %>%
                             filter(CVE_ENT != RES05EDO_C) %>%
                              group_by(CVE_ENT) %>%
                               summarise(Inmigrantes.Retorno = sum(value, na.rm = TRUE))

################################################################################
########################### Inmigrantes | Inmigrantes ##########################
Inmigrantes.Inmigrantes <- Migrantes.Inmigrantes %>% 
                            as.data.frame() %>%
                             tibble::rownames_to_column(var = "CVE_ENT") %>%
                              melt(., id.vars = "CVE_ENT", variable.name = "RES05EDO_C") %>%
                               mutate_at(vars(3), as.numeric) %>%
                                as.tibble() %>%
                                 filter(CVE_ENT != RES05EDO_C) %>%
                                  group_by(CVE_ENT) %>%
                                   summarise(Inmigrantes.Inmigrantes = sum(value, na.rm = TRUE))

################################################################################
############################### Emigrantes #####################################
Emigrantes <- Migrantes %>% 
               as.data.frame() %>%
                tibble::rownames_to_column(var = "CVE_ENT") %>%
                 melt(., id.vars = "CVE_ENT", variable.name = "RES05EDO_C") %>%
                  mutate_at(vars(3), as.numeric) %>%
                   as.tibble() %>%
                    filter(CVE_ENT != RES05EDO_C) %>%
                     group_by(RES05EDO_C) %>%
                      summarise(Emigrantes = sum(value, na.rm = TRUE)) %>%
                       rename("CVE_ENT" = "RES05EDO_C") 

################################################################################
######################## Emigrantes  | Retorno #################################
Emigrantes.Retorno <- Migrantes.Retorno %>% 
                       as.data.frame() %>%
                        tibble::rownames_to_column(var = "CVE_ENT") %>%
                         melt(., id.vars = "CVE_ENT", variable.name = "RES05EDO_C") %>%
                          mutate_at(vars(3), as.numeric) %>%
                           as.tibble() %>%
                            filter(CVE_ENT != RES05EDO_C) %>%
                             group_by(RES05EDO_C) %>%
                              summarise(Emigrantes.Retorno = sum(value, na.rm = TRUE)) %>%
                               rename("CVE_ENT" = "RES05EDO_C") 

################################################################################
################### Emigrantes  |  Inmigrantes #################################
Emigrantes.Inmigrantes <- Migrantes.Inmigrantes %>% 
                           as.data.frame() %>%
                            tibble::rownames_to_column(var = "CVE_ENT") %>%
                             melt(., id.vars = "CVE_ENT", variable.name = "RES05EDO_C") %>%
                              mutate_at(vars(3), as.numeric) %>%
                               as.tibble() %>%
                                filter(CVE_ENT != RES05EDO_C) %>%
                                 group_by(RES05EDO_C) %>%
                                  summarise(Emigrantes.Inmigrantes = sum(value, na.rm = TRUE)) %>%
                                   rename("CVE_ENT" = "RES05EDO_C") 

tabla <- Pob.Total %>%
          left_join(., Pob.5ymas, by = c("CVE_ENT")) %>%
          left_join(., Residentes, by = c("CVE_ENT")) %>%
          left_join(., Inmigrantes, by = c("CVE_ENT")) %>%
          left_join(., Inmigrantes.Retorno, by = c("CVE_ENT")) %>%
          left_join(., Inmigrantes.Inmigrantes, by = c("CVE_ENT")) %>%
          left_join(., Emigrantes, by = c("CVE_ENT")) %>%
          left_join(., Emigrantes.Retorno, by = c("CVE_ENT")) %>%
          left_join(., Emigrantes.Inmigrantes, by = c("CVE_ENT")) 

write.xlsx(tabla, file = paste0(here::here(),"/Output/Estado/05_Migracion de retorno/2010/Indicadores de migracion de retorno a nivel estatal 2010.xlsx"), overwrite = TRUE)

save(tabla, file = paste0(here::here(),"/Output/Estado/05_Migracion de retorno/2010/Indicadores de migracion de retorno a nivel estatal 2010.RData"))
```

```{r, echo = FALSE, eval = TRUE}
load(file = paste0(here::here(),"/Output/Estado/05_Migracion de retorno/2010/Indicadores de migracion de retorno a nivel estatal 2010.RData"))

tabla %>%  
 as.data.frame() %>%
  gt() %>% 
   tab_header(title = "Indicadores de  migraci칩n de retorno", 
              subtitle = "Nivel estatal") %>%
    tab_options(heading.title.font.size = 12, 
                heading.align = "center",
                heading.subtitle.font.size = 10,
                data_row.padding = px(1),
                column_labels.font.weight = "bold",
                column_labels.padding = px(10), 
                table.font.names = 'montserrat',
                table.font.size = 8) %>%
     tab_style(style = list(cell_text(align = "center",
                                      weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
      fmt_integer(columns = c(2:10), sep_mark = " ") %>%
       fmt_missing(columns = everything(), missing_text = "0") %>%
        tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%
         tab_footnote(footnote = "El total de inmigrantes se incluyen a los inmigrantes de otro pa칤s",
                      locations = cells_column_labels(columns = Inmigrantes)) %>% 
          tab_footnote(footnote = "El total de emigrantes se incluyen a los emigrantes de otro pa칤s",
                       locations = cells_column_labels(columns = Emigrantes)) %>% 
           as_raw_html()
```

# Referencias

Librerias que se usaron en el documento

```{r, echo = FALSE, eval = TRUE}
sesion_info <- devtools::session_info()
kable(dplyr::select(tibble::as_tibble(sesion_info$packages %>% dplyr::filter(attached == TRUE)),
                    c(package, loadedversion, source))) %>%
 kable_styling(font_size = 10, 
               bootstrap_options = c("condensed", "responsive", "bordered")) %>%
  kable_classic(full_width = TRUE, html_font = "montserrat") %>% 
   scroll_box(width = "100%", height = "400px") %>%  
    gsub("font-size: initial !important;", "font-size: 10pt !important;", .)
```

<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img src="https://i.creativecommons.org/l/by/4.0/88x31.png" alt="Creative Commons Licence" style="border-width:0"/></a><br />This work by [**Diana Villasana Ocampo**]{xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName"} is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.